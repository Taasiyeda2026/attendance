<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>נוכחות - תעשיידע</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="logo.png">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Heebo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      direction: rtl;
      overflow-x: hidden;
    }

    /* Login Screen */
    #loginScreen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 400px;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
    }

    .logo h1 {
      color: #667eea;
      font-size: 32px;
      margin-top: 15px;
      font-weight: 700;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #374151;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      font-family: 'Heebo', sans-serif;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-family: 'Heebo', sans-serif;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 110, 234, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    /* App Screen */
    #appScreen {
      display: none;
      min-height: 100vh;
    }

    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: white;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      padding: 20px 0;
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      transition: transform 0.3s;
      z-index: 1000;
    }

    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 2px solid #f3f4f6;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: 600;
    }

    .user-details h3 {
      color: #1f2937;
      font-size: 16px;
      font-weight: 600;
    }

    .user-details p {
      color: #6b7280;
      font-size: 14px;
    }

    .nav-menu {
      margin-top: 20px;
    }

    .nav-item {
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.3s;
      border-right: 3px solid transparent;
    }

    .nav-item:hover {
      background: #f9fafb;
      color: #667eea;
    }

    .nav-item.active {
      background: #f0f0ff;
      color: #667eea;
      border-right-color: #667eea;
      font-weight: 600;
    }

    .nav-item i {
      font-size: 20px;
      width: 24px;
      text-align: center;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-right: 280px;
      padding: 30px;
    }

    .page {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .page-header {
      background: white;
      padding: 25px 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .page-header h2 {
      color: #1f2937;
      font-size: 28px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .page-header p {
      color: #6b7280;
      margin-top: 8px;
      font-size: 15px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #1f2937;
    }

    .stat-label {
      color: #6b7280;
      font-size: 14px;
      margin-top: 5px;
    }

    /* Form Card */
    .form-card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group-inline {
      display: flex;
      flex-direction: column;
    }

    .form-group-inline label {
      margin-bottom: 8px;
      color: #374151;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group-inline input,
    .form-group-inline select,
    .form-group-inline textarea {
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.3s;
      font-family: 'Heebo', sans-serif;
    }

    .form-group-inline input:focus,
    .form-group-inline select:focus,
    .form-group-inline textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group-inline textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Table */
    .table-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow: hidden;
    }

    .table-header {
      padding: 20px 25px;
      border-bottom: 2px solid #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .table-header h3 {
      color: #1f2937;
      font-size: 20px;
      font-weight: 600;
    }

    .search-box {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search-box input {
      padding: 10px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      min-width: 200px;
      font-family: 'Heebo', sans-serif;
    }

    .btn-small {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s;
      font-family: 'Heebo', sans-serif;
    }

    .btn-small:hover {
      transform: translateY(-2px);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f9fafb;
    }

    th {
      padding: 15px 20px;
      text-align: right;
      color: #374151;
      font-weight: 600;
      font-size: 14px;
      border-bottom: 2px solid #e5e7eb;
    }

    td {
      padding: 15px 20px;
      color: #6b7280;
      border-bottom: 1px solid #f3f4f6;
      font-size: 14px;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .action-btns {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
      font-size: 14px;
    }

    .btn-icon:hover {
      transform: scale(1.1);
    }

    .btn-edit {
      background: #dbeafe;
      color: #1e40af;
    }

    .btn-delete {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f3f4f6;
    }

    .modal-header h3 {
      color: #1f2937;
      font-size: 22px;
      font-weight: 600;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .close-modal:hover {
      background: #f3f4f6;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .btn-secondary {
      flex: 1;
      padding: 12px;
      background: #f3f4f6;
      color: #374151;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      font-family: 'Heebo', sans-serif;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .btn-primary {
      flex: 1;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s;
      font-family: 'Heebo', sans-serif;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
    }

    /* Mobile Menu */
    .mobile-header {
      display: none;
      background: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .mobile-header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .menu-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: #667eea;
      cursor: pointer;
    }

    .mobile-title {
      color: #1f2937;
      font-size: 18px;
      font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(100%);
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .main-content {
        margin-right: 0;
        padding: 20px 15px;
      }

      .mobile-header {
        display: block;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .table-card {
        overflow-x: auto;
      }

      table {
        min-width: 600px;
      }

      .login-card {
        padding: 30px 20px;
      }
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Alerts */
    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
    }

    .alert-success {
      background: #d1fae5;
      color: #065f46;
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .alert-info {
      background: #dbeafe;
      color: #1e40af;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* Badge */
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  
  <!-- Login Screen -->
  <div id="loginScreen">
    <div class="login-card">
      <div class="logo">
        <img src="logo.png" alt="תעשיידע">
        <h1>נוכחות</h1>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label>מספר עובד</label>
          <input type="text" id="employeeId" placeholder="הזן מספר עובד" required autocomplete="username">
        </div>
        <div class="form-group">
          <label>סיסמה</label>
          <input type="password" id="password" placeholder="הזן סיסמה" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn" id="loginBtn">
          <span id="loginBtnText">התחבר</span>
          <span id="loginSpinner" class="spinner" style="display:none;"></span>
        </button>
      </form>
    </div>
  </div>

  <!-- App Screen -->
  <div id="appScreen">
    <!-- Mobile Header -->
    <div class="mobile-header">
      <div class="mobile-header-content">
        <button class="menu-btn" id="mobileMenuBtn">
          <i class="fas fa-bars"></i>
        </button>
        <div class="mobile-title" id="mobileTitle">לוח בקרה</div>
        <div style="width:24px;"></div>
      </div>
    </div>

    <div class="app-container">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="user-info">
            <div class="user-avatar" id="userAvatar">א</div>
            <div class="user-details">
              <h3 id="userName">שם משתמש</h3>
              <p id="userRole">תפקיד</p>
            </div>
          </div>
        </div>
        
        <nav class="nav-menu">
          <div class="nav-item active" data-page="dashboard">
            <i class="fas fa-home"></i>
            <span>לוח בקרה</span>
          </div>
          <div class="nav-item" data-page="add-record" data-role="instructor">
            <i class="fas fa-plus-circle"></i>
            <span>הוספת רשומה</span>
          </div>
          <div class="nav-item" data-page="my-records" data-role="instructor">
            <i class="fas fa-list"></i>
            <span>הרשומות שלי</span>
          </div>
          <div class="nav-item" data-page="team-records" data-role="manager">
            <i class="fas fa-users"></i>
            <span>רשומות הצוות</span>
          </div>
          <div class="nav-item" data-page="reports" data-role="admin">
            <i class="fas fa-chart-bar"></i>
            <span>דוחות</span>
          </div>
          <div class="nav-item" data-page="settings">
            <i class="fas fa-cog"></i>
            <span>הגדרות</span>
          </div>
          <div class="nav-item" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            <span>התנתק</span>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        
        <!-- Dashboard Page -->
        <div class="page active" id="dashboardPage">
          <div class="page-header">
            <h2>
              <i class="fas fa-home"></i>
              לוח בקרה
            </h2>
            <p id="dashboardGreeting">ברוך הבא למערכת הנוכחות</p>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                  <i class="fas fa-calendar-check"></i>
                </div>
              </div>
              <div class="stat-value" id="totalRecords">0</div>
              <div class="stat-label">סה"כ רשומות</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                  <i class="fas fa-clock"></i>
                </div>
              </div>
              <div class="stat-value" id="totalHours">0</div>
              <div class="stat-label">סה"כ שעות</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                  <i class="fas fa-car"></i>
                </div>
              </div>
              <div class="stat-value" id="totalKm">0</div>
              <div class="stat-label">סה"כ קילומטרים</div>
            </div>

            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                  <i class="fas fa-shekel-sign"></i>
                </div>
              </div>
              <div class="stat-value" id="totalExpenses">0</div>
              <div class="stat-label">סה"כ הוצאות</div>
            </div>
          </div>

          <div class="form-card">
            <h3 style="margin-bottom: 20px; color: #1f2937;">רשומות אחרונות</h3>
            <div id="recentRecordsTable"></div>
          </div>
        </div>

        <!-- Add Record Page -->
        <div class="page" id="addRecordPage" data-role="instructor">
          <div class="page-header">
            <h2>
              <i class="fas fa-plus-circle"></i>
              הוספת רשומת נוכחות
            </h2>
            <p>מלא את כל השדות הנדרשים</p>
          </div>

          <form class="form-card" id="addRecordForm">
            <div class="form-grid">
              <div class="form-group-inline">
                <label>תאריך *</label>
                <input type="date" id="attendanceDate" required>
              </div>

              <div class="form-group-inline">
                <label>שעת התחלה *</label>
                <input type="time" id="startTime" required>
              </div>

              <div class="form-group-inline">
                <label>שעת סיום *</label>
                <input type="time" id="endTime" required>
              </div>

              <div class="form-group-inline">
                <label>סוג פעילות *</label>
                <select id="activityType" required>
                  <option value="">בחר סוג פעילות</option>
                  <option value="סדנה">סדנה</option>
                  <option value="הדרכה">הדרכה</option>
                  <option value="ליווי">ליווי</option>
                  <option value="פגישה">פגישה</option>
                  <option value="אחר">אחר</option>
                </select>
              </div>

              <div class="form-group-inline">
                <label>שם בית ספר *</label>
                <input type="text" id="schoolName" required placeholder="הזן שם בית ספר">
              </div>

              <div class="form-group-inline">
                <label>רשות *</label>
                <input type="text" id="municipality" required placeholder="הזן רשות">
              </div>

              <div class="form-group-inline">
                <label>שם תוכנית *</label>
                <input type="text" id="programName" required placeholder="הזן שם תוכנית">
              </div>

              <div class="form-group-inline">
                <label>מספר מפגש</label>
                <input type="number" id="sessionNumber" min="1" placeholder="מספר מפגש">
              </div>

              <div class="form-group-inline">
                <label>קילומטרים</label>
                <input type="number" id="kilometers" min="0" step="0.1" value="0" placeholder="0">
              </div>

              <div class="form-group-inline">
                <label>סכום הוצאות</label>
                <input type="number" id="totalExpenses" min="0" step="0.01" value="0" placeholder="0">
              </div>
            </div>

            <div class="form-group-inline">
              <label>פירוט הוצאות</label>
              <textarea id="expensesDetail" placeholder="פרט את ההוצאות כאן..."></textarea>
            </div>

            <div class="form-group-inline">
              <label>הערות</label>
              <textarea id="notes" placeholder="הערות נוספות..."></textarea>
            </div>

            <button type="submit" class="btn" id="submitRecordBtn">
              <span id="submitBtnText">שמור רשומה</span>
              <span id="submitSpinner" class="spinner" style="display:none;"></span>
            </button>
          </form>
        </div>

        <!-- My Records Page -->
        <div class="page" id="myRecordsPage" data-role="instructor">
          <div class="page-header">
            <h2>
              <i class="fas fa-list"></i>
              הרשומות שלי
            </h2>
            <p>כל רשומות הנוכחות שלך</p>
          </div>

          <div class="table-card">
            <div class="table-header">
              <h3>רשימת רשומות</h3>
              <div class="search-box">
                <input type="text" id="searchMyRecords" placeholder="חיפוש...">
                <button class="btn-small" id="refreshMyRecords">
                  <i class="fas fa-sync"></i> רענן
                </button>
              </div>
            </div>
            <div id="myRecordsTableContainer">
              <table>
                <thead>
                  <tr>
                    <th>תאריך</th>
                    <th>שעות</th>
                    <th>סוג פעילות</th>
                    <th>בית ספר</th>
                    <th>רשות</th>
                    <th>תוכנית</th>
                    <th>ק"מ</th>
                    <th>הוצאות</th>
                    <th>פעולות</th>
                  </tr>
                </thead>
                <tbody id="myRecordsTableBody">
                  <tr>
                    <td colspan="9" class="empty-state">
                      <i class="fas fa-inbox"></i>
                      <h3>אין רשומות</h3>
                      <p>התחל להוסיף רשומות נוכחות</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Team Records Page -->
        <div class="page" id="teamRecordsPage" data-role="manager">
          <div class="page-header">
            <h2>
              <i class="fas fa-users"></i>
              רשומות הצוות
            </h2>
            <p>צפה בכל רשומות הצוות שלך</p>
          </div>

          <div class="table-card">
            <div class="table-header">
              <h3>רשימת רשומות צוות</h3>
              <div class="search-box">
                <input type="text" id="searchTeamRecords" placeholder="חיפוש...">
                <button class="btn-small" id="refreshTeamRecords">
                  <i class="fas fa-sync"></i> רענן
                </button>
                <button class="btn-small" id="exportTeamRecords">
                  <i class="fas fa-download"></i> ייצוא
                </button>
              </div>
            </div>
            <div id="teamRecordsTableContainer">
              <table>
                <thead>
                  <tr>
                    <th>עובד</th>
                    <th>תאריך</th>
                    <th>שעות</th>
                    <th>פעילות</th>
                    <th>בית ספר</th>
                    <th>רשות</th>
                    <th>תוכנית</th>
                    <th>ק"מ</th>
                    <th>הוצאות</th>
                  </tr>
                </thead>
                <tbody id="teamRecordsTableBody">
                  <tr>
                    <td colspan="9" class="empty-state">
                      <i class="fas fa-inbox"></i>
                      <h3>אין רשומות</h3>
                      <p>אין רשומות צוות זמינות</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Reports Page -->
        <div class="page" id="reportsPage" data-role="admin">
          <div class="page-header">
            <h2>
              <i class="fas fa-chart-bar"></i>
              דוחות
            </h2>
            <p>דוחות וסטטיסטיקות מפורטים</p>
          </div>

          <div class="form-card">
            <h3 style="margin-bottom: 20px; color: #1f2937;">בחר סוג דוח</h3>
            
            <div class="form-grid">
              <div class="form-group-inline">
                <label>תאריך התחלה</label>
                <input type="date" id="reportStartDate">
              </div>
              <div class="form-group-inline">
                <label>תאריך סיום</label>
                <input type="date" id="reportEndDate">
              </div>
            </div>

            <div class="stats-grid" style="margin-top: 30px;">
              <button class="btn-small" style="width: 100%; padding: 15px;" id="generateSummaryReport">
                <i class="fas fa-file-alt"></i> דוח סיכום כללי
              </button>
              <button class="btn-small" style="width: 100%; padding: 15px;" id="generateEmployeeReport">
                <i class="fas fa-user-tie"></i> דוח לפי עובד
              </button>
              <button class="btn-small" style="width: 100%; padding: 15px;" id="generateActivityReport">
                <i class="fas fa-tasks"></i> דוח לפי פעילות
              </button>
              <button class="btn-small" style="width: 100%; padding: 15px;" id="generateExpensesReport">
                <i class="fas fa-money-bill-wave"></i> דוח הוצאות
              </button>
            </div>
          </div>

          <div id="reportResults" style="margin-top: 30px; display: none;">
            <div class="form-card">
              <h3 style="margin-bottom: 20px; color: #1f2937;">תוצאות דוח</h3>
              <div id="reportContent"></div>
            </div>
          </div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="settingsPage">
          <div class="page-header">
            <h2>
              <i class="fas fa-cog"></i>
              הגדרות
            </h2>
            <p>נהל את הגדרות החשבון שלך</p>
          </div>

          <div class="form-card">
            <h3 style="margin-bottom: 20px; color: #1f2937;">הגדרות אישיות</h3>
            
            <form id="settingsForm">
              <div class="form-grid">
                <div class="form-group-inline">
                  <label>שם מלא</label>
                  <input type="text" id="settingsName" readonly>
                </div>
                <div class="form-group-inline">
                  <label>מספר עובד</label>
                  <input type="text" id="settingsEmployeeId" readonly>
                </div>
                <div class="form-group-inline">
                  <label>תפקיד</label>
                  <input type="text" id="settingsRole" readonly>
                </div>
                <div class="form-group-inline">
                  <label>צוות</label>
                  <input type="text" id="settingsTeam" readonly>
                </div>
              </div>

              <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #f3f4f6;">
                <h3 style="margin-bottom: 20px; color: #1f2937;">שינוי סיסמה</h3>
                <div class="form-grid">
                  <div class="form-group-inline">
                    <label>סיסמה נוכחית</label>
                    <input type="password" id="currentPassword" placeholder="הזן סיסמה נוכחית">
                  </div>
                  <div class="form-group-inline">
                    <label>סיסמה חדשה</label>
                    <input type="password" id="newPassword" placeholder="הזן סיסמה חדשה">
                  </div>
                  <div class="form-group-inline">
                    <label>אימות סיסמה</label>
                    <input type="password" id="confirmPassword" placeholder="אמת סיסמה חדשה">
                  </div>
                </div>
                <button type="submit" class="btn" style="margin-top: 20px;">
                  שמור שינויים
                </button>
              </div>
            </form>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- Edit Record Modal -->
  <div class="modal" id="editRecordModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>עריכת רשומה</h3>
        <button class="close-modal" data-modal="editRecordModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="editRecordForm">
        <input type="hidden" id="editRecordId">
        <div class="form-grid">
          <div class="form-group-inline">
            <label>תאריך</label>
            <input type="date" id="editDate" required>
          </div>
          <div class="form-group-inline">
            <label>שעת התחלה</label>
            <input type="time" id="editStartTime" required>
          </div>
          <div class="form-group-inline">
            <label>שעת סיום</label>
            <input type="time" id="editEndTime" required>
          </div>
          <div class="form-group-inline">
            <label>סוג פעילות</label>
            <select id="editActivityType" required>
              <option value="סדנה">סדנה</option>
              <option value="הדרכה">הדרכה</option>
              <option value="ליווי">ליווי</option>
              <option value="פגישה">פגישה</option>
              <option value="אחר">אחר</option>
            </select>
          </div>
          <div class="form-group-inline">
            <label>קילומטרים</label>
            <input type="number" id="editKilometers" min="0" step="0.1">
          </div>
          <div class="form-group-inline">
            <label>הוצאות</label>
            <input type="number" id="editTotalExpenses" min="0" step="0.01">
          </div>
        </div>
        <div class="form-group-inline">
          <label>הערות</label>
          <textarea id="editNotes"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" data-modal="editRecordModal">ביטול</button>
          <button type="submit" class="btn-primary">שמור</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Logout Confirm Modal -->
  <div class="modal" id="logoutModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>התנתקות</h3>
        <button class="close-modal" data-modal="logoutModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p style="color: #6b7280; margin: 20px 0;">האם אתה בטוח שברצונך להתנתק?</p>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" data-modal="logoutModal">ביטול</button>
        <button type="button" class="btn-primary" id="confirmLogout">התנתק</button>
      </div>
    </div>
  </div>

  <script>
    // =============== Configuration ===============
    const LOGIC_APP_URL = 'https://prod-07.westeurope.logic.azure.com:443/workflows/8e9bbf6d5e1543f4962d88fc54e81fe5/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=MXfxAO2uEVdDTK4qXRRm9cj0ZnV1I_Ug4QeDa1CykHw';

    // =============== Helper Functions (MOVED TO TOP) ===============
    
    // Extract SharePoint Lookup Value
    function extractLookupValue(field, defaultValue = '') {
      if (!field) return defaultValue;
      if (typeof field === 'string') {
        try {
          const parsed = JSON.parse(field);
          if (parsed && parsed.Value) return parsed.Value;
          return field;
        } catch (e) {
          return field;
        }
      }
      if (typeof field === 'object' && field.Value) {
        return field.Value;
      }
      return defaultValue;
    }

    // Extract Time from DateTime
    function extractTimeFromDateTime(dateTimeString) {
      if (!dateTimeString) return '';
      try {
        // Already HH:MM format?
        if (/^\d{2}:\d{2}$/.test(dateTimeString)) {
          return dateTimeString;
        }
        // ISO 8601 like 2024-01-25T14:30:00Z
        const date = new Date(dateTimeString);
        if (!isNaN(date.getTime())) {
          const hours = date.getHours().toString().padStart(2, '0');
          const minutes = date.getMinutes().toString().padStart(2, '0');
          return `${hours}:${minutes}`;
        }
        return dateTimeString;
      } catch (e) {
        return dateTimeString;
      }
    }

    // Get Number Value
    function getNumber(field) {
      if (typeof field === 'number') return field;
      if (typeof field === 'string') return parseFloat(field) || 0;
      return 0;
    }

    // =============== Role-based UI Control ===============
    const ADMIN_ROLES = ["system_admin", "assistant_admin", "payroll_officer"];
    const TEAM_MANAGER_ROLE = "manager";
    const INSTRUCTOR_ROLE = "instructor";

    function normalizeRole(role) {
      if (!role) return '';
      const normalized = role.toLowerCase().trim();
      const roleMap = {
        'team_manager': 'manager',
        'מנהל צוות': 'manager',
        'מנהל': 'manager',
        'מדריך': 'instructor',
        'instructor': 'instructor',
        'guide': 'instructor',
        'אחראית שכר': 'payroll_officer',
        'payroll_officer': 'payroll_officer',
        'payroll': 'payroll_officer',
        'assistant_admin': 'operations_controller',
        'מנהל מערכת': 'system_admin',
        'system_admin': 'system_admin',
        'admin': 'system_admin'
      };
      return roleMap[normalized] || normalized;
    }

    function hideElementsByRole(role) {
      const normalizedRole = normalizeRole(role);
      console.log('✅ UI updated for role:', normalizedRole);

      // Hide all role-specific elements
      document.querySelectorAll('[data-role]').forEach(el => {
        el.style.display = 'none';
      });

      // Show elements based on role
      if (ADMIN_ROLES.includes(normalizedRole)) {
        // Admin sees reports
        document.querySelectorAll('[data-role="admin"]').forEach(el => {
          el.style.display = 'block';
        });
      } else if (normalizedRole === TEAM_MANAGER_ROLE) {
        // Manager sees team records
        document.querySelectorAll('[data-role="manager"]').forEach(el => {
          el.style.display = 'block';
        });
      } else if (normalizedRole === INSTRUCTOR_ROLE) {
        // Instructor sees add record and my records
        document.querySelectorAll('[data-role="instructor"]').forEach(el => {
          el.style.display = 'block';
        });
      }
    }

    // =============== Global State ===============
    let currentUser = null;
    let records = [];

    // =============== Auth Functions ===============
    async function doLogin(employeeId, password) {
      try {
        const response = await fetch(LOGIC_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'auth',
            employeeId: employeeId,
            password: password
          })
        });

        const data = await response.json();
        
        if (data.success) {
          const empData = {
            employeeId: data.employeeId,
            employeeName: extractLookupValue(data.employeeName),
            role: normalizeRole(data.role),
            team: extractLookupValue(data.team),
            employmentType: extractLookupValue(data.employmentType)
          };
          
          currentUser = empData;
          localStorage.setItem('currentUser', JSON.stringify(empData));
          
          // Hide elements by role (FIXED: moved after currentUser is set)
          hideElementsByRole(empData.role);
          
          showAppScreen();
          return { success: true };
        } else {
          return { success: false, message: data.message || 'שגיאה בהתחברות' };
        }
      } catch (error) {
        console.error('Login error:', error);
        return { success: false, message: 'שגיאת תקשורת עם השרת' };
      }
    }

    function doLogout() {
      currentUser = null;
      records = [];
      localStorage.removeItem('currentUser');
      document.getElementById('appScreen').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('loginForm').reset();
    }

    function showAppScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appScreen').style.display = 'block';
      
      // Update UI
      const initials = currentUser.employeeName.split(' ').map(n => n[0]).join('');
      document.getElementById('userAvatar').textContent = initials;
      document.getElementById('userName').textContent = currentUser.employeeName;
      document.getElementById('userRole').textContent = getRoleDisplayName(currentUser.role);
      document.getElementById('dashboardGreeting').textContent = `ברוך הבא, ${currentUser.employeeName}`;
      document.getElementById('mobileTitle').textContent = 'לוח בקרה';
      
      // Update settings
      document.getElementById('settingsName').value = currentUser.employeeName;
      document.getElementById('settingsEmployeeId').value = currentUser.employeeId;
      document.getElementById('settingsRole').value = getRoleDisplayName(currentUser.role);
      document.getElementById('settingsTeam').value = currentUser.team || '-';
      
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('attendanceDate').value = today;
      
      // Load data
      loadMyRecordsFromServer();
    }

    function getRoleDisplayName(role) {
      const roleNames = {
        'instructor': 'מדריך',
        'manager': 'מנהל צוות',
        'payroll_officer': 'אחראית שכר',
        'operations_controller': 'בקר תפעול',
        'system_admin': 'מנהל מערכת'
      };
      return roleNames[role] || role;
    }

    // =============== Records Functions ===============
    async function loadMyRecordsFromServer() {
      try {
        const response = await fetch(LOGIC_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getHistory',
            employeeId: currentUser.employeeId,
            role: currentUser.role,
            team: currentUser.team
          })
        });

        const data = await response.json();
        
        if (data.success && data.records) {
          records = data.records.map(rec => ({
            recordId: rec.ID || rec.Id || rec.id || rec.recordId || null,
            id: rec.ID || rec.Id || rec.id || `${rec.employeeId}_${rec.attendanceDate}_${rec.startTime}`,
            empNum: rec.employeeId?.toString() || currentUser.employeeId,
            empName: extractLookupValue(rec.employeeName || rec.EmployeeName) || currentUser.employeeName,
            team: extractLookupValue(rec.team || rec.Team) || currentUser.team,
            date: rec.attendanceDate || '',
            start: extractTimeFromDateTime(rec.startTime) || '',
            end: extractTimeFromDateTime(rec.endTime) || '',
            hours: getNumber(rec.workHours),
            activity: extractLookupValue(rec.activityType || rec.ActivityType) || '',
            school: extractLookupValue(rec.schoolName || rec.SchoolName) || '',
            municipality: extractLookupValue(rec.municipality || rec.Municipality) || '',
            program: extractLookupValue(rec.programName || rec.ProgramName) || '',
            session: rec.sessionNumber || '',
            km: getNumber(rec.kilometers),
            totalExpenses: getNumber(rec.totalExpenses),
            expensesDetail: rec.expensesDetails || '',
            notes: rec.notes || '',
            employmentType: extractLookupValue(rec.employmentType || rec.EmploymentType) || '',
            attachments: []
          }));
          
          console.log('✅ Records loaded:', records.length);
          updateDashboard();
          renderMyRecordsTable();
        }
      } catch (error) {
        console.error('Error loading records:', error);
      }
    }

    async function submitRecord(recordData) {
      try {
        const response = await fetch(LOGIC_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'submit',
            employeeId: currentUser.employeeId,
            employeeName: currentUser.employeeName,
            team: currentUser.team,
            employmentType: currentUser.employmentType,
            ...recordData
          })
        });

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error submitting record:', error);
        return { success: false, message: 'שגיאת תקשורת' };
      }
    }

    async function updateRecord(recordId, recordData) {
      try {
        const response = await fetch(LOGIC_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'updateRecord',
            recordId: recordId,
            ...recordData
          })
        });

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error updating record:', error);
        return { success: false, message: 'שגיאת תקשורת' };
      }
    }

    async function deleteRecord(recordId) {
      try {
        const response = await fetch(LOGIC_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'deleteRecord',
            recordId: recordId
          })
        });

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error deleting record:', error);
        return { success: false, message: 'שגיאת תקשורת' };
      }
    }

    // =============== UI Functions ===============
    function updateDashboard() {
      const totalRecords = records.length;
      const totalHours = records.reduce((sum, r) => sum + (r.hours || 0), 0);
      const totalKm = records.reduce((sum, r) => sum + (r.km || 0), 0);
      const totalExpenses = records.reduce((sum, r) => sum + (r.totalExpenses || 0), 0);

      document.getElementById('totalRecords').textContent = totalRecords;
      document.getElementById('totalHours').textContent = totalHours.toFixed(1);
      document.getElementById('totalKm').textContent = totalKm.toFixed(1);
      document.getElementById('totalExpenses').textContent = `₪${totalExpenses.toFixed(2)}`;

      // Show recent records
      const recentRecords = records.slice(0, 5);
      const recentHTML = recentRecords.length > 0 ? `
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>תאריך</th>
              <th>פעילות</th>
              <th>שעות</th>
              <th>בית ספר</th>
            </tr>
          </thead>
          <tbody>
            ${recentRecords.map(r => `
              <tr>
                <td>${r.date}</td>
                <td>${r.activity}</td>
                <td>${r.hours}</td>
                <td>${r.school}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : '<div class="empty-state"><i class="fas fa-inbox"></i><h3>אין רשומות אחרונות</h3></div>';
      
      document.getElementById('recentRecordsTable').innerHTML = recentHTML;
    }

    function renderMyRecordsTable() {
      const tbody = document.getElementById('myRecordsTableBody');
      
      if (records.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="empty-state">
              <i class="fas fa-inbox"></i>
              <h3>אין רשומות</h3>
              <p>התחל להוסיף רשומות נוכחות</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${record.date}</td>
          <td>${record.start} - ${record.end} (${record.hours})</td>
          <td>${record.activity}</td>
          <td>${record.school}</td>
          <td>${record.municipality}</td>
          <td>${record.program}</td>
          <td>${record.km}</td>
          <td>₪${record.totalExpenses}</td>
          <td>
            <div class="action-btns">
              <button class="btn-icon btn-edit" onclick="editRecordModal('${record.recordId}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon btn-delete" onclick="confirmDeleteRecord('${record.recordId}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function editRecordModal(recordId) {
      const record = records.find(r => r.recordId == recordId);
      if (!record) return;

      document.getElementById('editRecordId').value = recordId;
      document.getElementById('editDate').value = record.date;
      document.getElementById('editStartTime').value = record.start;
      document.getElementById('editEndTime').value = record.end;
      document.getElementById('editActivityType').value = record.activity;
      document.getElementById('editKilometers').value = record.km;
      document.getElementById('editTotalExpenses').value = record.totalExpenses;
      document.getElementById('editNotes').value = record.notes;

      openModal('editRecordModal');
    }

    async function confirmDeleteRecord(recordId) {
      if (!confirm('האם אתה בטוח שברצונך למחוק רשומה זו?')) return;
      
      const result = await deleteRecord(recordId);
      if (result.success) {
        alert('הרשומה נמחקה בהצלחה');
        await loadMyRecordsFromServer();
      } else {
        alert(result.message || 'שגיאה במחיקת הרשומה');
      }
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function showPage(pageId) {
      // Update active nav item
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-page="${pageId}"]`)?.classList.add('active');

      // Update active page
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(`${pageId}Page`)?.classList.add('active');

      // Update mobile title
      const titles = {
        'dashboard': 'לוח בקרה',
        'add-record': 'הוספת רשומה',
        'my-records': 'הרשומות שלי',
        'team-records': 'רשומות הצוות',
        'reports': 'דוחות',
        'settings': 'הגדרות'
      };
      document.getElementById('mobileTitle').textContent = titles[pageId] || 'נוכחות';

      // Close mobile menu
      document.getElementById('sidebar').classList.remove('active');
    }

    // =============== Event Listeners ===============
    document.addEventListener('DOMContentLoaded', () => {
      // Check for saved session
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showAppScreen();
        hideElementsByRole(currentUser.role);
      }

      // Login form
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const employeeId = document.getElementById('employeeId').value;
        const password = document.getElementById('password').value;
        
        document.getElementById('loginBtnText').style.display = 'none';
        document.getElementById('loginSpinner').style.display = 'inline-block';
        
        const result = await doLogin(employeeId, password);
        
        document.getElementById('loginBtnText').style.display = 'inline';
        document.getElementById('loginSpinner').style.display = 'none';
        
        if (!result.success) {
          alert(result.message);
        }
      });

      // Add record form
      document.getElementById('addRecordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
          attendanceDate: document.getElementById('attendanceDate').value,
          startTime: document.getElementById('startTime').value,
          endTime: document.getElementById('endTime').value,
          activityType: document.getElementById('activityType').value,
          schoolName: document.getElementById('schoolName').value,
          municipality: document.getElementById('municipality').value,
          programName: document.getElementById('programName').value,
          sessionNumber: document.getElementById('sessionNumber').value || null,
          kilometers: parseFloat(document.getElementById('kilometers').value) || 0,
          totalExpenses: parseFloat(document.getElementById('totalExpenses').value) || 0,
          expensesDetails: document.getElementById('expensesDetail').value,
          notes: document.getElementById('notes').value
        };

        // Calculate work hours
        const start = new Date(`2000-01-01T${formData.startTime}`);
        const end = new Date(`2000-01-01T${formData.endTime}`);
        const hours = (end - start) / (1000 * 60 * 60);
        formData.workHours = hours;

        document.getElementById('submitBtnText').style.display = 'none';
        document.getElementById('submitSpinner').style.display = 'inline-block';
        
        const result = await submitRecord(formData);
        
        document.getElementById('submitBtnText').style.display = 'inline';
        document.getElementById('submitSpinner').style.display = 'none';
        
        if (result.success) {
          alert('הרשומה נשמרה בהצלחה!');
          document.getElementById('addRecordForm').reset();
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('attendanceDate').value = today;
          await loadMyRecordsFromServer();
          showPage('my-records');
        } else {
          alert(result.message || 'שגיאה בשמירת הרשומה');
        }
      });

      // Edit record form
      document.getElementById('editRecordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const recordId = document.getElementById('editRecordId').value;
        const formData = {
          attendanceDate: document.getElementById('editDate').value,
          startTime: document.getElementById('editStartTime').value,
          endTime: document.getElementById('editEndTime').value,
          activityType: document.getElementById('editActivityType').value,
          kilometers: parseFloat(document.getElementById('editKilometers').value) || 0,
          totalExpenses: parseFloat(document.getElementById('editTotalExpenses').value) || 0,
          notes: document.getElementById('editNotes').value
        };

        // Calculate work hours
        const start = new Date(`2000-01-01T${formData.startTime}`);
        const end = new Date(`2000-01-01T${formData.endTime}`);
        const hours = (end - start) / (1000 * 60 * 60);
        formData.workHours = hours;

        const result = await updateRecord(recordId, formData);
        
        if (result.success) {
          alert('הרשומה עודכנה בהצלחה!');
          closeModal('editRecordModal');
          await loadMyRecordsFromServer();
        } else {
          alert(result.message || 'שגיאה בעדכון הרשומה');
        }
      });

      // Navigation
      document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        item.addEventListener('click', () => {
          showPage(item.dataset.page);
        });
      });

      // Mobile menu
      document.getElementById('mobileMenuBtn').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('active');
      });

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', () => {
        openModal('logoutModal');
      });

      document.getElementById('confirmLogout').addEventListener('click', () => {
        closeModal('logoutModal');
        doLogout();
      });

      // Modal close buttons
      document.querySelectorAll('.close-modal, [data-modal]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          if (btn.classList.contains('close-modal') || e.target.classList.contains('btn-secondary')) {
            const modal = btn.closest('.modal');
            if (modal) closeModal(modal.id);
          }
        });
      });

      // Refresh buttons
      document.getElementById('refreshMyRecords')?.addEventListener('click', loadMyRecordsFromServer);

      // Search
      document.getElementById('searchMyRecords')?.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredRecords = records.filter(r => 
          r.date.includes(searchTerm) ||
          r.activity.toLowerCase().includes(searchTerm) ||
          r.school.toLowerCase().includes(searchTerm) ||
          r.municipality.toLowerCase().includes(searchTerm)
        );
        // Render filtered records
      });
    });
  </script>

</body>
</html>
