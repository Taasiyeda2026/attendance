
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××¢×¨×›×ª × ×•×›×—×•×ª - ×ª×¢×©×™×™×“×¢</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Heebo', sans-serif;
      background: #f8fafc;
      color: #1e293b;
      direction: rtl;
    }

    .hidden { display: none !important; }

    /* ============= Login Screen ============= */
    #loginScreen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f1f5f9;
      padding: 20px;
    }

    .login-card {
      background: white;
      padding: 50px 40px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12), 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      max-width: 420px;
      width: 100%;
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .login-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(0,0,0,0.15), 0 5px 15px rgba(0,0,0,0.1);
    }

    .login-logo {
      max-width: 200px;
      margin-bottom: 30px;
    }

    .login-card h2 {
      color: #1e293b;
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .login-card p {
      color: #64748b;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: right;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #475569;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      font-family: 'Heebo', sans-serif;
      transition: all 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-login {
      width: 100%;
      padding: 16px;
      background: #1e40af;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Heebo', sans-serif;
      transition: all 0.2s;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
    }

    .btn-login:hover {
      background: #1e3a8a;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(30, 64, 175, 0.35);
    }

    .btn-login:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(30, 64, 175, 0.2);
    }

    .login-error {
      color: #ef4444;
      background: #fee2e2;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
      display: none;
    }

    .login-error.show {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* ============= Main App Layout ============= */
    #mainApp {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: white;
      border-left: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
      box-shadow: -2px 0 10px rgba(0,0,0,0.05);
    }

    .sidebar-header {
      padding: 25px 20px;
      border-bottom: 1px solid #e2e8f0;
      text-align: center;
    }

    .sidebar-logo {
      max-width: 160px;
    }

    .sidebar-user {
      padding: 25px 20px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 600;
    }

    .user-info h3 {
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 4px;
    }

    .user-info p {
      font-size: 13px;
      color: #64748b;
    }

    .sidebar-nav {
      flex: 1;
      padding: 20px 15px;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      color: #64748b;
      text-decoration: none;
      border-radius: 10px;
      margin-bottom: 5px;
      transition: all 0.2s;
      cursor: pointer;
      font-weight: 500;
    }

    .nav-item:hover {
      background: #f1f5f9;
      color: #3b82f6;
    }

    .nav-item.active {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: #3b82f6;
    }

    .nav-item i {
      margin-left: 12px;
      font-size: 18px;
      width: 24px;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid #e2e8f0;
    }

    .btn-logout {
      width: 100%;
      padding: 12px;
      background: #fee2e2;
      color: #dc2626;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Heebo', sans-serif;
    }

    .btn-logout:hover {
      background: #fecaca;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-right: 280px;
      padding: 30px;
    }

    .page-header {
      margin-bottom: 30px;
    }

    .page-header h1 {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .page-header p {
      color: #64748b;
      font-size: 16px;
    }

    /* Dashboard Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .stat-card-title {
      color: #64748b;
      font-size: 14px;
      font-weight: 500;
    }

    .stat-card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .stat-card.blue .stat-card-icon {
      background: #eff6ff;
      color: #3b82f6;
    }

    .stat-card.purple .stat-card-icon {
      background: #f3e8ff;
      color: #a855f7;
    }

    .stat-card.green .stat-card-icon {
      background: #ecfdf5;
      color: #10b981;
    }

    .stat-card.orange .stat-card-icon {
      background: #fff7ed;
      color: #f59e0b;
    }

    .stat-card-value {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 5px;
    }

    .stat-card-label {
      font-size: 13px;
      color: #94a3b8;
    }

    /* Content Card */
    .content-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .content-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15), 0 4px 8px rgba(0,0,0,0.08);
    }

    .card-header {
      padding: 25px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
    }

    .card- {
      padding: 25px;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    table thead {
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
    }

    table th {
      padding: 14px 16px;
      text-align: right;
      font-weight: 600;
      color: #475569;
      font-size: 14px;
    }

    table td {
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      color: #64748b;
      font-size: 14px;
    }

    table t tr:hover {
      background: #f8fafc;
    }

    /* Status Badge */
    .status-badge {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.sent {
      background: #dcfce7;
      color: #16a34a;
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #d97706;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Heebo', sans-serif;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    /* Alert */
    .alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s;
    }

    .alert.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .alert.success {
      background: #dcfce7;
      color: #16a34a;
    }

    .alert.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .alert.info {
      background: #dbeafe;
      color: #3b82f6;
    }

    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-field label {
      display: block;
      margin-bottom: 8px;
      color: #475569;
      font-weight: 500;
      font-size: 14px;
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 15px;
      font-family: 'Heebo', sans-serif;
      transition: all 0.2s;
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-field input:-moz-read-only {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    .form-field input:read-only {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    /* Page */
    .page {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        position: relative;
      }

      .main-content {
        margin-right: 0;
        padding: 20px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Edit Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e2e8f0;
    }

    .modal-header h3 {
      margin: 0;
      color: #1e293b;
      font-size: 22px;
    }

    .close-btn {
      background: #fee2e2;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      color: #dc2626;
      font-size: 20px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: #fecaca;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px solid #e2e8f0;
    }

    .required-label::after {
      content: ' *';
      color: #dc2626;
      font-weight: bold;
    }
</style>
  <link rel="manifest" href="./manifest.json">
  
  <meta name="theme-color" content="#1e40af">
  
  <link rel="icon" type="image/png" href="./favicon.png">
  <link rel="apple-touch-icon" href="./icon-192.png">
</head>
<body>
async function submitAll() {
    const pendingRecords = records.filter(r => r.status === 'pending');
    
    if (pendingRecords.length === 0) {
        showAlert('××™×Ÿ ×¨×©×•××•×ª ×—×“×©×•×ª ×œ×©×œ×™×—×”', 'info');
        return;
    }

    // ×”×›×ª×•×‘×ª ×©×§×™×‘×œ×ª ××”-HTTP Trigger ×‘-Logic App
    const logicAppUrl = 'YOUR_LOGIC_APP_URL_HERE';

    // ×˜×™×¤×•×œ ×‘×§×‘×¦×™× - ×”×•×¤×š ××ª ×”×§×•×‘×¥ ×”×¨××©×•×Ÿ ×œ-Base64 (×× ×§×™×™×)
    const fileInput = document.getElementById('attachments');
    let fileBase64 = null;
    if (fileInput.files.length > 0) {
        fileBase64 = await toBase64(fileInput.files[0]);
    }

    const payload = {
        employeeNumber: document.getElementById('empNum').value,
        employeeName: document.getElementById('empName').value,
        records: pendingRecords,
        attachment: fileBase64 // × ×©×œ×— ×›×˜×§×¡×˜ ××¨×•×š
    };

    try {
        const response = await fetch(logicAppUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            showAlert('×”× ×ª×•× ×™× ×¡×•× ×›×¨× ×• ×‘×”×¦×œ×—×”!', 'success');
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ××§×•××™ ×›×“×™ ×©×œ× ×™×™×©×œ×— ×¤×¢××™×™×
            records.forEach(r => r.status = 'sent');
            localStorage.setItem('attendance_records', JSON.stringify(records));
            renderRecords();
        }
    } catch (error) {
        showAlert('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-Logic App', 'error');
    }
}

// ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×”××¨×ª ×§×•×‘×¥ ×œ×¤×•×¨××˜ ×©×”-Logic App ×™×›×•×œ ×œ×§×¨×•×
const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = error => reject(error);
});
<!-- =============== Login Screen =============== -->
<div id="loginScreen">
  <div class="login-card">
    <h1 style="font-size: 40px; font-weight: 800; color: #1e293b; margin: 30px 0 10px 0; letter-spacing: -0.5px;">×ª×¢×©×™×™×“×¢<br><span style="font-size: 28px;">××¢×¨×›×ª × ×•×›×—×•×ª</span></h1>
    <p style="font-size: 14px; color: #64748b; margin: 0 0 25px 0;">×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª</p>
    
    <form onsubmit="return doLogin(event);" id="loginForm">
      <div class="form-group">
        <label for="loginEmpNum">××¡×¤×¨ ×¢×•×‘×“</label>
        <input type="text" id="loginEmpNum" placeholder="×”×–×Ÿ ××¡×¤×¨ ×¢×•×‘×“" required>
      </div>
      
      <div class="form-group">
        <label for="empCode">×§×•×“ ××™×©×™</label>
        <input type="password" id="empCode" placeholder="×”×–×Ÿ ×§×•×“ ××™×©×™" required>
      </div>
      
      <button type="submit" class="btn-login" id="loginBtn">
        <i class="fas fa-sign-in-alt"></i>
        ×›× ×™×¡×” ×œ××¢×¨×›×ª
      </button>
    </form>
    
    <div class="login-error" id="loginError">
      <i class="fas fa-exclamation-circle"></i>
      <span>××¡×¤×¨ ×¢×•×‘×“ ××• ×§×•×“ ×©×’×•×™×™×</span>
    </div>
  </div>
</div>

<!-- =============== Main App =============== -->
<div id="mainApp" class="hidden">
  
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2 style="font-size: 24px; font-weight: 700; color: #1e293b; margin: 0; text-align: center;">×ª×¢×©×™×™×“×¢<br><span style="font-size: 14px; font-weight: 500; color: #64748b;">××¢×¨×›×ª × ×•×›×—×•×ª</span></h2>
    </div>
    
    <div class="sidebar-user">
      <div class="user-avatar">×¢</div>
      <div class="user-info">
        <h3 id="userName">×¢×™×“×Ÿ × ×—×•×</h3>
        <p id="userRole">×× ×”×œ ××¢×¨×›×ª</p>
      </div>
    </div>
    
    <nav class="sidebar-nav">
      <a href="#" class="nav-item active" onclick="showPage(event, 'dashboard')">
        <i class="fas fa-chart-line"></i>
        <span>×œ×•×— ×‘×§×¨×”</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'add-record')">
        <i class="fas fa-plus-circle"></i>
        <span>×”×•×¡×¤×ª ×¨×©×•××”</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'records')">
        <i class="fas fa-table"></i>
        <span>×¨×©×•××•×ª × ×•×›×—×•×ª</span>
      </a>
      <a href="#" class="nav-item" onclick="syncFromSharePoint()">
        <i class="fas fa-sync-alt"></i>
        <span>×¡× ×›×¨×•×Ÿ × ×ª×•× ×™×</span>
      </a>
    </nav>
    
    <div class="sidebar-footer">
      <button class="btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        ×™×¦×™××” ××”××¢×¨×›×ª
      </button>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Alert -->
    <div class="alert" id="alertBox">
      <i class="fas fa-check-circle"></i>
      <span id="alertText"></span>
    </div>
    
    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page">
      <div class="page-header">
        <h1>×œ×•×— ×‘×§×¨×”</h1>
        <p>×¡×§×™×¨×” ×›×œ×œ×™×ª ×©×œ ×”× ×•×›×—×•×ª ×•×”×”×©×ª×™×™×¢×“×•×ª</p>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card blue" onclick="showPage(event, 'records')" style="cursor: pointer; transition: transform 0.2s;"
             onmouseover="this.style.transform='translateY(-5px)'"
             onmouseout="this.style.transform='translateY(0)'">
          <div class="stat-card-header">
            <span class="stat-card-title">×¡×”"×› ×¨×©×•××•×ª</span>
            <div class="stat-card-icon">
              <i class="fas fa-clipboard-list"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalRecordsStat">0</div>
          <div class="stat-card-label">×¨×©×•××•×ª × ×•×›×—×•×ª</div>
        </div>
        
        <div class="stat-card purple">
          <div class="stat-card-header">
            <span class="stat-card-title">×¡×”"×› ×©×¢×•×ª</span>
            <div class="stat-card-icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalHoursStat">0</div>
          <div class="stat-card-label">×©×¢×•×ª ×¢×‘×•×“×”</div>
        </div>
        
        <div class="stat-card green">
          <div class="stat-card-header">
            <span class="stat-card-title">×¡×”"×› ×”×•×¦××•×ª</span>
            <div class="stat-card-icon">
              <i class="fas fa-shekel-sign"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalExpensesStat">0 â‚ª</div>
          <div class="stat-card-label">×”×•×¦××•×ª ×•×”×—×–×¨×™×</div>
        </div>
        
        <div class="stat-card orange" onclick="showPage(event, 'records')" style="cursor: pointer; transition: transform 0.2s;"
             onmouseover="this.style.transform='translateY(-5px)'"
             onmouseout="this.style.transform='translateY(0)'">
          <div class="stat-card-header">
            <span class="stat-card-title">×××ª×™× ×•×ª ×œ×©×œ×™×—×”</span>
            <div class="stat-card-icon">
              <i class="fas fa-hourglass-half"></i>
            </div>
          </div>
          <div class="stat-card-value" id="pendingRecordsStat">0</div>
          <div class="stat-card-label">×¨×©×•××•×ª ×—×“×©×•×ª</div>
        </div>
      </div>
      
      <!-- ×›×¤×ª×•×¨ ×”×•×¡×¤×ª ×¨×©×•××” ×—×“×©×” -->
      <div style="text-align: center; margin-top: 40px;">
        <button class="btn btn-primary" onclick="showPage(event, 'add-record')" style="font-size: 18px; padding: 20px 40px;">
          <i class="fas fa-plus"></i>
          ×”×•×¡×£ ×¨×©×•××” ×—×“×©×”
        </button>
      </div>
    </div>

    <!-- Add Record Page -->
    <div id="addRecordPage" class="page hidden">
      <div class="page-header">
        <h1>×”×•×¡×¤×ª ×¨×©×•××” ×—×“×©×”</h1>
        <p>××œ× ××ª ×›×œ ×”×¤×¨×˜×™× ×”× ×“×¨×©×™×</p>
      </div>
      
      <div class="content-card">
        <div class="card-body">
          <div class="form-grid">
            <div class="form-field">
              <label for="empNum">××¡×¤×¨ ×¢×•×‘×“</label>
              <input type="text" id="empNum" readonly>
            </div>
            <div class="form-field">
              <label for="empName">×©× ×¢×•×‘×“</label>
              <input type="text" id="empName" readonly>
            </div>
            <div class="form-field">
              <label for="recDate">×ª××¨×™×š <span style="color: #ef4444;">*</span></label>
              <input type="date" id="recDate" required>
            </div>
            <div class="form-field">
              <label for="startTime">×©×¢×ª ×”×ª×—×œ×” <span style="color: #ef4444;">*</span></label>
              <input type="time" id="startTime" onchange="calculateHours()" required>
            </div>
            <div class="form-field">
              <label for="endTime">×©×¢×ª ×¡×™×•× <span style="color: #ef4444;">*</span></label>
              <input type="time" id="endTime" onchange="calculateHours()" required>
            </div>
            <div class="form-field">
              <label for="hoursField">×¡×”"×› ×©×¢×•×ª</label>
              <input type="number" id="hoursField" step="0.01" min="0" max="24" readonly style="background: #f1f5f9; cursor: not-allowed;">
            </div>
            <div class="form-field">
              <label for="activityType">×¡×•×’ ×¤×¢×™×œ×•×ª <span style="color: #ef4444;">*</span></label>
              <select id="activityType" required>
                <option value="">×‘×—×¨</option>
                <option value="×‘×™×˜×•×œ ×–××Ÿ">×‘×™×˜×•×œ ×–××Ÿ</option>
                <option value="×”×›×©×¨×”">×”×›×©×¨×”</option>
                <option value="×¡×“× ×”">×¡×“× ×”</option>
                <option value="×¡×™×•×¨">×¡×™×•×¨</option>
                <option value="×§×•×¨×¡">×§×•×¨×¡</option>
                <option value="×ª×¤×¢×•×œ">×ª×¤×¢×•×œ</option>
              </select>
            </div>
            <div class="form-field">
              <label for="schoolField">×‘×™×ª ×¡×¤×¨ <span style="color: #ef4444;">*</span></label>
              <select id="schoolField" onchange="updateMunicipalityFromSchool()" required>
                <option value="">×‘×—×¨ ×‘×™×ª ×¡×¤×¨</option>
              </select>
            </div>
            <div class="form-field">
              <label for="municipality">×¨×©×•×ª <span style="color: #ef4444;">*</span></label>
              <input type="text" id="municipality" readonly required style="background: #f1f5f9;">
            </div>
            <div class="form-field">
              <label for="programField">×ª×•×›× ×™×ª <span style="color: #ef4444;">*</span></label>
              <select id="programField" required>
                <option value="">×‘×—×¨ ×ª×•×›× ×™×ª</option>
                <option value="×”×©××™×™× ××™× × ×”×’×‘×•×œ">×”×©××™×™× ××™× × ×”×’×‘×•×œ</option>
                <option value="×”×ª× ×¡×•×ª ×‘×ª×¢×©×™×™×”">×”×ª× ×¡×•×ª ×‘×ª×¢×©×™×™×”</option>
                <option value="×‘×™×•××™××™×§×¨×™">×‘×™×•××™××™×§×¨×™</option>
                <option value="×‘×™×•××™××™×§×¨×™ ×œ×—×˜×™×‘×•×ª">×‘×™×•××™××™×§×¨×™ ×œ×—×˜×™×‘×•×ª</option>
                <option value="×‘×™× ×” ××œ××›×•×ª×™×ª">×‘×™× ×” ××œ××›×•×ª×™×ª</option>
                <option value="×™×™×©×•××™ AI">×™×™×©×•××™ AI</option>
                <option value="××™×™×§×¨×™× ×˜×›× ×•-×›×™×£">××™×™×§×¨×™× ×˜×›× ×•-×›×™×£</option>
                <option value="×× ×”×™×’×•×ª ×™×¨×•×§×”">×× ×”×™×’×•×ª ×™×¨×•×§×”</option>
                <option value="××§×•×¨×•×ª">××§×•×¨×•×ª</option>
                <option value="××©×—×§×™ ×§×•×¤×¡×”">××©×—×§×™ ×§×•×¤×¡×”</option>
                <option value="×¤×•×¨×¦×•×ª ×“×¨×š">×¤×•×¨×¦×•×ª ×“×¨×š</option>
                <option value="×¨×•×§×—×™× ×¢×•×œ×">×¨×•×§×—×™× ×¢×•×œ×</option>
                <option value="×˜×›× ×•×œ×•×’×™×•×ª ×”×—×œ×œ">×˜×›× ×•×œ×•×’×™×•×ª ×”×—×œ×œ</option>
                <option value="×ª××™×¨">×ª××™×¨</option>
              </select>
            </div>
            <div class="form-field">
              <label for="sessionNum">××¡×¤×¨ ××¤×’×© <span style="color: #ef4444;">*</span></label>
              <select id="sessionNum" required>
                <option value="">×‘×—×¨</option>
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
              </select>
            </div>
            <div class="form-field">
              <label for="kmField">×§×™×œ×•××˜×¨</label>
              <input type="number" id="kmField" step="0.1" min="0" placeholder="×œ×“×•×’××”: 25.5">
            </div>
            <div class="form-field">
              <label for="totalExpenses">×¡×”"×› ×”×•×¦××•×ª (â‚ª)</label>
              <input type="number" id="totalExpenses" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="form-field">
              <label for="expensesDetail">×¤×™×¨×•×˜ ×”×•×¦××•×ª</label>
              <textarea id="expensesDetail" rows="2" placeholder="×¤×¨×˜ ××ª ×”×”×•×¦××•×ª"></textarea>
            </div>
            <div class="form-field">
              <label for="attachments">×¦×¨×£ ××¡××›×™×/×ª××•× ×•×ª</label>
              <input type="file" id="attachments" multiple accept="image/*,.pdf,.doc,.docx">
              <small style="color: #64748b; font-size: 12px; display: block; margin-top: 5px;">× ×™×ª×Ÿ ×œ×”×¢×œ×•×ª ××¡×¤×¨ ×§×‘×¦×™×</small>
            </div>
            <div class="form-field">
              <label for="notesField">×”×¢×¨×•×ª</label>
              <textarea id="notesField" rows="3"></textarea>
            </div>
          </div>
          
          <div style="display: flex; gap: 15px; margin-top: 25px;">
            <button class="btn btn-success" onclick="addRecord()">
              <i class="fas fa-check"></i>
              ×”×•×¡×£ ×¨×©×•××”
            </button>
            <button class="btn btn-primary" onclick="showPage(event, 'dashboard')">
              <i class="fas fa-arrow-right"></i>
              ×—×–×•×¨ ×œ×œ×•×— ×‘×§×¨×”
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Records Page -->
    <div id="recordsPage" class="page hidden">
      <div class="page-header">
        <h1>×¨×©×•××•×ª × ×•×›×—×•×ª</h1>
        <p>×›×œ ×”×¨×©×•××•×ª ×‘××¢×¨×›×ª</p>
      </div>
      
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">×¡×”"×› <span id="totalRecordsCount">0</span> ×¨×©×•××•×ª</h2>
          <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="exportToExcel()" style="background: #10b981; color: white;">
              <i class="fas fa-file-excel"></i>
              ×™×™×¦×•× ×œ-Excel
            </button>
            <button class="btn" onclick="clearAllData()" style="background: #dc2626; color: white;">
              <i class="fas fa-trash"></i>
              ××™×¤×•×¡ ×›×œ ×”× ×ª×•× ×™×
            </button>
            <button class="btn btn-primary" onclick="submitAll()">
              <i class="fas fa-paper-plane"></i>
              ×©×œ×— ×“×™×•×•×—
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="recordsTable">
            <p style="text-align: center; color: #94a3b8; padding: 40px;">××™×Ÿ ×¨×©×•××•×ª ×œ×”×¦×’×”</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>×¢×¨×™×›×ª ×¨×©×•××”</h3>
          <button class="close-btn" onclick="closeEditModal()">Ã—</button>
        </div>
        
        <div class="form-grid">
          <div class="form-field">
            <label for="editDate" class="required-label">×ª××¨×™×š</label>
            <input type="date" id="editDate" required>
          </div>
          <div class="form-field">
            <label for="editStartTime" class="required-label">×©×¢×ª ×”×ª×—×œ×”</label>
            <input type="time" id="editStartTime" onchange="calculateEditHours()" required>
          </div>
          <div class="form-field">
            <label for="editEndTime" class="required-label">×©×¢×ª ×¡×™×•×</label>
            <input type="time" id="editEndTime" onchange="calculateEditHours()" required>
          </div>
          <div class="form-field">
            <label for="editHours">×¡×”"×› ×©×¢×•×ª</label>
            <input type="number" id="editHours" step="0.01" min="0" max="24" readonly style="background: #f1f5f9; cursor: not-allowed;">
          </div>
          <div class="form-field">
            <label for="editActivity" class="required-label">×¡×•×’ ×¤×¢×™×œ×•×ª</label>
            <select id="editActivity" required>
              <option value="">×‘×—×¨</option>
              <option value="×‘×™×˜×•×œ ×–××Ÿ">×‘×™×˜×•×œ ×–××Ÿ</option>
              <option value="×”×›×©×¨×”">×”×›×©×¨×”</option>
              <option value="×¡×“× ×”">×¡×“× ×”</option>
              <option value="×¡×™×•×¨">×¡×™×•×¨</option>
              <option value="×§×•×¨×¡">×§×•×¨×¡</option>
              <option value="×ª×¤×¢×•×œ">×ª×¤×¢×•×œ</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editSchool" class="required-label">×‘×™×ª ×¡×¤×¨</label>
            <select id="editSchool" onchange="updateEditMunicipality()" required>
              <option value="">×‘×—×¨ ×‘×™×ª ×¡×¤×¨</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editMunicipality" class="required-label">×¨×©×•×ª</label>
            <input type="text" id="editMunicipality" readonly style="background: #f1f5f9;" required>
          </div>
          <div class="form-field">
            <label for="editProgram" class="required-label">×ª×•×›× ×™×ª</label>
            <select id="editProgram" required>
              <option value="">×‘×—×¨ ×ª×•×›× ×™×ª</option>
              <option value="×”×©××™×™× ××™× × ×”×’×‘×•×œ">×”×©××™×™× ××™× × ×”×’×‘×•×œ</option>
              <option value="×”×ª× ×¡×•×ª ×‘×ª×¢×©×™×™×”">×”×ª× ×¡×•×ª ×‘×ª×¢×©×™×™×”</option>
              <option value="×‘×™×•××™××™×§×¨×™">×‘×™×•××™××™×§×¨×™</option>
              <option value="×‘×™×•××™××™×§×¨×™ ×œ×—×˜×™×‘×•×ª">×‘×™×•××™××™×§×¨×™ ×œ×—×˜×™×‘×•×ª</option>
              <option value="×‘×™× ×” ××œ××›×•×ª×™×ª">×‘×™× ×” ××œ××›×•×ª×™×ª</option>
              <option value="×™×™×©×•××™ AI">×™×™×©×•××™ AI</option>
              <option value="××™×™×§×¨×™× ×˜×›× ×•-×›×™×£">××™×™×§×¨×™× ×˜×›× ×•-×›×™×£</option>
              <option value="×× ×”×™×’×•×ª ×™×¨×•×§×”">×× ×”×™×’×•×ª ×™×¨×•×§×”</option>
              <option value="××§×•×¨×•×ª">××§×•×¨×•×ª</option>
              <option value="××©×—×§×™ ×§×•×¤×¡×”">××©×—×§×™ ×§×•×¤×¡×”</option>
              <option value="×¤×•×¨×¦×•×ª ×“×¨×š">×¤×•×¨×¦×•×ª ×“×¨×š</option>
              <option value="×¨×•×§×—×™× ×¢×•×œ×">×¨×•×§×—×™× ×¢×•×œ×</option>
              <option value="×˜×›× ×•×œ×•×’×™×•×ª ×”×—×œ×œ">×˜×›× ×•×œ×•×’×™×•×ª ×”×—×œ×œ</option>
              <option value="×ª××™×¨">×ª××™×¨</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editSession" class="required-label">××¡×¤×¨ ××¤×’×©</label>
            <select id="editSession" required>
              <option value="">×‘×—×¨</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editKm">×§×™×œ×•××˜×¨</label>
            <input type="number" id="editKm" step="0.1" min="0" placeholder="×œ×“×•×’××”: 25.5">
          </div>
          <div class="form-field">
            <label for="editTotalExpenses">×¡×”"×› ×”×•×¦××•×ª (â‚ª)</label>
            <input type="number" id="editTotalExpenses" step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-field">
            <label for="editExpensesDetail">×¤×™×¨×•×˜ ×”×•×¦××•×ª</label>
            <textarea id="editExpensesDetail" rows="2" placeholder="×¤×¨×˜ ××ª ×”×”×•×¦××•×ª"></textarea>
          </div>
          <div class="form-field">
            <label for="editNotes">×”×¢×¨×•×ª</label>
            <textarea id="editNotes" rows="3"></textarea>
          </div>
          <div class="form-field">
            <label for="editAttachments">×§×‘×¦×™× ××¦×•×¨×¤×™×</label>
            <input type="file" id="editAttachments" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx">
            <small style="color: #64748b; font-size: 12px;">× ×™×ª×Ÿ ×œ×¦×¨×£ ××¡×¤×¨ ×§×‘×¦×™× (PDF, ×ª××•× ×•×ª, ××¡××›×™×)</small>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn" onclick="closeEditModal()" style="background: #e2e8f0; color: #475569;">
            <i class="fas fa-times"></i>
            ×‘×™×˜×•×œ
          </button>
          <button class="btn btn-success" onclick="saveEdit()">
            <i class="fas fa-save"></i>
            ×©××™×¨×”
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// =============== Configuration ===============

// Logic App URL moved to server-side for security

// =============== State ===============
let records = [];
let currentUser = '';
let editingIndex = -1;

// =============== Users ===============
// Authentication moved to server-side for security

// =============== Schools Data ===============
const schoolsData = [
  {"×¨×©×•×ª":"×‘× ×™××™× ×”","×‘×™×ª ×¡×¤×¨":"××ª× \"×¡"},
  {"×¨×©×•×ª":"×’'×“×™×™×“×” ××›×¨","×‘×™×ª ×¡×¤×¨":"×’'×“×™×™×“×” ×™×¡×•×“×™"},
  {"×¨×©×•×ª":"×”×¨×¦×œ×™×”","×‘×™×ª ×¡×¤×¨":"×•×™×¦×• ×¤× ×™× ×™× ××™×œ× ×•×ª"},
  {"×¨×©×•×ª":"×—×™×¤×”","×‘×™×ª ×¡×¤×¨":"×œ××•×‘×§"},
  {"×¨×©×•×ª":"×™×¨×•×©×œ×™×","×‘×™×ª ×¡×¤×¨":"×‘×™×›×•×¨×™×"},
  {"×¨×©×•×ª":"×›×™×¡×¨× ×¡××™×”","×‘×™×ª ×¡×¤×¨":"×›×™×¡×¨× ×¡××™×”"},
  {"×¨×©×•×ª":"×™×¨×›×","×‘×™×ª ×¡×¤×¨":"×™×¨×›× ××œ-×¨×•××™"},
  {"×¨×©×•×ª":"×™×¨×›×","×‘×™×ª ×¡×¤×¨":"×™×¨×›× ××œ-×××™×Ÿ"},
  {"×¨×©×•×ª":"×’'×•×œ×™×¡","×‘×™×ª ×¡×¤×¨":"×“×¨×›×"},
  {"×¨×©×•×ª":"×¢×™×Ÿ ×§×™× ×™×”","×‘×™×ª ×¡×¤×¨":"×¢×™×Ÿ ×§×™× ×™×”"},
  {"×¨×©×•×ª":"×‘×•×§×¢×ª×","×‘×™×ª ×¡×¤×¨":"×‘×•×§×¢×ª×"},
  {"×¨×©×•×ª":"××’'×“×œ ×©××¡","×‘×™×ª ×¡×¤×¨":"××’'×“×œ ×©××¡"},
  {"×¨×©×•×ª":"×™×”×•×“","×‘×™×ª ×¡×¤×¨":"×”×¨×¦×œ"},
  {"×¨×©×•×ª":"×™×”×•×“","×‘×™×ª ×¡×¤×¨":"×™×”×•×“×” ×”×œ×•×™"},
  {"×¨×©×•×ª":"×™×”×•×“","×‘×™×ª ×¡×¤×¨":"×”×™×•×‘×œ"},
  {"×¨×©×•×ª":"××©×›×•×œ","×‘×™×ª ×¡×¤×¨":"× ×•×¤×™ ×”×‘×©×•×¨"},
  {"×¨×©×•×ª":"×× ×©×”","×‘×™×ª ×¡×¤×¨":"× ×˜×¢×™×"},
  {"×¨×©×•×ª":"××˜×” ×™×”×•×“×”","×‘×™×ª ×¡×¤×¨":"××œ×•×Ÿ"},
  {"×¨×©×•×ª":"××˜×” ×™×”×•×“×”","×‘×™×ª ×¡×¤×¨":"××ª×™×ª×™×”×•"},
  {"×¨×©×•×ª":"××˜×” ×™×”×•×“×”","×‘×™×ª ×¡×¤×¨":"×”××œ×”"},
  {"×¨×©×•×ª":"××˜×” ×™×”×•×“×”","×‘×™×ª ×¡×¤×¨":"×”×¨×˜×•×‘ ×”×™×¡×•×“×™"},
  {"×¨×©×•×ª":"××˜×” ×™×”×•×“×”","×‘×™×ª ×¡×¤×¨":"×¢×™×Ÿ ×”×¨×™×"},
  {"×¨×©×•×ª":"××˜×” ×™×”×•×“×”","×‘×™×ª ×¡×¤×¨":"×”×©×—×¨"},
  {"×¨×©×•×ª":"××˜×” ×™×”×•×“×”","×‘×™×ª ×¡×¤×¨":"×™×¡×•×“×™ ×¢×™×Ÿ × ×§×•×‘×-×¨××¤×”"},
  {"×¨×©×•×ª":"××˜×” ×™×”×•×“×”","×‘×™×ª ×¡×¤×¨":"×§×¨×•×‘"},
  {"×¨×©×•×ª":"××˜×” ×™×”×•×“×”","×‘×™×ª ×¡×¤×¨":"× ×•×•×” ×©×œ×•×"},
  {"×¨×©×•×ª":"××˜×” ×™×”×•×“×”","×‘×™×ª ×¡×¤×¨":"×§×¡×"},
  {"×¨×©×•×ª":"××¡×¢×“×”","×‘×™×ª ×¡×¤×¨":"××¡×¢×“×” ×™×¡×•×“×™"},
  {"×¨×©×•×ª":"× ×”×¨×™×”","×‘×™×ª ×¡×¤×¨":"×’×•×œ×“×”"},
  {"×¨×©×•×ª":"× ×”×¨×™×”","×‘×™×ª ×¡×¤×¨":"×™×©×™×‘×ª ××‘×™×¨×™ ×™×¢×§×‘"},
  {"×¨×©×•×ª":"× ×”×¨×™×”","×‘×™×ª ×¡×¤×¨":"××“×¢×™×"},
  {"×¨×©×•×ª":"× ×”×¨×™×”","×‘×™×ª ×¡×¤×¨":"×¨××‘\"×"},
  {"×¨×©×•×ª":"× ×ª× ×™×”","×‘×™×ª ×¡×¤×¨":"×‘×¨ ××™×œ×Ÿ"},
  {"×¨×©×•×ª":"× ×ª× ×™×”","×‘×™×ª ×¡×¤×¨":"××œ×“×“"},
  {"×¨×©×•×ª":"× ×ª× ×™×”","×‘×™×ª ×¡×¤×¨":"×¨×™×’×œ×¨"},
  {"×¨×©×•×ª":"× ×ª× ×™×”","×‘×™×ª ×¡×¤×¨":"××œ×ª×¨××Ÿ"},
  {"×¨×©×•×ª":"× ×ª× ×™×”","×‘×™×ª ×¡×¤×¨":"××•×¨×˜ ×’×•×˜××Ÿ"},
  {"×¨×©×•×ª":"× ×ª× ×™×”","×‘×™×ª ×¡×¤×¨":"×©×—×¤×™× ×—× \"× (××œ×•××•×ª ×œ×©×¢×‘×¨)"},
  {"×¨×©×•×ª":"×¢×™×Ÿ ××œ××¡×“","×‘×™×ª ×¡×¤×¨":"×¢×™×Ÿ ××œ××¡×“"},
  {"×¨×©×•×ª":"×¢×›×•","×‘×™×ª ×¡×¤×¨":"×’×•×¨×“×•×Ÿ"},
  {"×¨×©×•×ª":"×¢×›×•","×‘×™×ª ×¡×¤×¨":"×”×¢×œ×™×” ×”×©× ×™×”"},
  {"×¨×©×•×ª":"×¢×›×•","×‘×™×ª ×¡×¤×¨":"×—×™×œ××™"},
  {"×¨×©×•×ª":"×¢××§ ×”×™×¨×“×Ÿ - ××¤×™×§×™×","×‘×™×ª ×¡×¤×¨":"××¤×™×§×™ ×™×¨×“×Ÿ"},
  {"×¨×©×•×ª":"×¢××§ ×”×™×¨×“×Ÿ - ××©×“×•×ª ×™×¢×§×‘","×‘×™×ª ×¡×¤×¨":"××•×œ ×’×œ×¢×“"},
  {"×¨×©×•×ª":"×¢××§ ×”×™×¨×“×Ÿ - ×’×™× ×•×¡×¨","×‘×™×ª ×¡×¤×¨":"× ×•×¤×™ ××¨×‘×œ"},
  {"×¨×©×•×ª":"×¢××§ ×”×™×¨×“×Ÿ - ×“×’× ×™×” ×'","×‘×™×ª ×¡×¤×¨":"×‘×™×ª ×—×™× ×•×š ×“×’× ×™×”"},
  {"×¨×©×•×ª":"×¢××§ ×”×™×¨×“×Ÿ - ×›× ×¨×ª","×‘×™×ª ×¡×¤×¨":"×›× ×¨×ª"},
  {"×¨×©×•×ª":"×§×¨×™×™×ª ×˜×‘×¢×•×Ÿ","×‘×™×ª ×¡×¤×¨":"×›×¤×¨ ×”× ×•×¢×¨ ×¨××ª ×”×“×¡×”"},
  {"×¨×©×•×ª":"×§×¨×™×™×ª ×©××•× ×”","×‘×™×ª ×¡×¤×¨":"××ª× \"×¡ ×§×¨×™×™×ª ×©××•× ×”"},
  {"×¨×©×•×ª":"×§×¨×™×™×ª ×©××•× ×”","×‘×™×ª ×¡×¤×¨":"×¢×•×–×™××œ"},
  {"×¨×©×•×ª":"×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ","×‘×™×ª ×¡×¤×¨":"×’×™×× ×¡×™×”"},
  {"×¨×©×•×ª":"×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ","×‘×™×ª ×¡×¤×¨":"×ª×™×›×•×Ÿ ×”××¢×™×™×Ÿ"},
  {"×¨×©×•×ª":"×¨×—×•×‘×•×ª","×‘×™×ª ×¡×¤×¨":"×‘×›×•×¨ ×œ×•×™"},
  {"×¨×©×•×ª":"×¨×—×•×‘×•×ª","×‘×™×ª ×¡×¤×¨":"× ×‘×•×Ÿ ×¨×—×•×‘×•×ª"},
  {"×¨×©×•×ª":"×‘×•×¡×ª×Ÿ ×”×’×œ×™×œ","×‘×™×ª ×¡×¤×¨":"××™×˜×¨"},
  {"×¨×©×•×ª":"××•×¤×§×™×","×‘×™×ª ×¡×¤×¨":"×‘×Ÿ ×’×•×¨×™×•×Ÿ"},
  {"×¨×©×•×ª":"××©×“×•×“","×‘×™×ª ×¡×¤×¨":"×—×•×•×” ×—×§×œ××™×ª - ××©×›×•×œ"},
  {"×¨×©×•×ª":"××©×“×•×“","×‘×™×ª ×¡×¤×¨":"×—×•×•×” ×—×§×œ××™×ª - ×™×—×“"},
  {"×¨×©×•×ª":"××©×“×•×“","×‘×™×ª ×¡×¤×¨":"××§×™×£ ×”'"},
  {"×¨×©×•×ª":"××©×“×•×“","×‘×™×ª ×¡×¤×¨":"××§×™×£ ×˜'"},
  {"×¨×©×•×ª":"××©×›×•×œ","×‘×™×ª ×¡×¤×¨":"××¨×—×‘×™ ××©×›×•×œ"},
  {"×¨×©×•×ª":"××©×›×•×œ","×‘×™×ª ×¡×¤×¨":"×©×“×•×ª ××©×›×•×œ"},
  {"×¨×©×•×ª":"××©×›×•×œ","×‘×™×ª ×¡×¤×¨":"×©××© ×’×‘×•×œ×•×ª"},
  {"×¨×©×•×ª":"××©×§×œ×•×Ÿ","×‘×™×ª ×¡×¤×¨":"××™×œ× ×•×ª"},
  {"×¨×©×•×ª":"××©×§×œ×•×Ÿ","×‘×™×ª ×¡×¤×¨":"×‘×¨××©×™×ª"},
  {"×¨×©×•×ª":"××©×§×œ×•×Ÿ","×‘×™×ª ×¡×¤×¨":"×“×¨×›× ××§×™×£ ×”'"},
  {"×¨×©×•×ª":"××©×§×œ×•×Ÿ","×‘×™×ª ×¡×¤×¨":"× ×•×£ ×™× ×‘'"},
  {"×¨×©×•×ª":"×‘××¨ ×™×¢×§×‘","×‘×™×ª ×¡×¤×¨":"×¦××œ×•×Ÿ"},
  {"×¨×©×•×ª":"×‘××¨ ×©×‘×¢","×‘×™×ª ×¡×¤×¨":"×”×ª×•××¨"},
  {"×¨×©×•×ª":"×‘××¨ ×©×‘×¢","×‘×™×ª ×¡×¤×¨":"×—×•×•×” ×—×§×œ××™×ª - ×”×ª×•××¨"},
  {"×¨×©×•×ª":"×‘××¨ ×©×‘×¢","×‘×™×ª ×¡×¤×¨":"×©×•×‘×•"},
  {"×¨×©×•×ª":"×‘××¨ ×©×‘×¢","×‘×™×ª ×¡×¤×¨":"×—×•×•×” ×—×§×œ××™×ª - ×¨× × ×•×ª"},
  {"×¨×©×•×ª":"×‘××¨ ×©×‘×¢","×‘×™×ª ×¡×¤×¨":"××§×™×£ ×’'"},
  {"×¨×©×•×ª":"×’×“×¨×”","×‘×™×ª ×¡×¤×¨":"×“×¨×›× ×¨××•×Ÿ"},
  {"×¨×©×•×ª":"×“×™××•× ×”","×‘×™×ª ×¡×¤×¨":"× ×•×•×” ×¢××¨×"},
  {"×¨×©×•×ª":"×™×‘× ×”","×‘×™×ª ×¡×¤×¨":"×‘×™××œ×™×§"},
  {"×¨×©×•×ª":"×™×‘× ×”","×‘×™×ª ×¡×¤×¨":"× ×‘×•×Ÿ ×™×‘× ×”"},
  {"×¨×©×•×ª":"×™×‘× ×”","×‘×™×ª ×¡×¤×¨":"×¤×¨×“×¡ ×¦×¤×•× ×™"},
  {"×¨×©×•×ª":"×™×“ ×‘× ×™××™×Ÿ","×‘×™×ª ×¡×¤×¨":"×™×“ ×‘× ×™××™×Ÿ"},
  {"×¨×©×•×ª":"×œ×›×™×©","×‘×™×ª ×¡×¤×¨":"×¨×‘×§×” ×’×•×‘×¨"},
  {"×¨×©×•×ª":"×.× ×—×•×£ ××©×§×œ×•×Ÿ","×‘×™×ª ×¡×¤×¨":"×‘××¨ ×’× ×™×"},
  {"×¨×©×•×ª":"×.× ×—×•×£ ××©×§×œ×•×Ÿ","×‘×™×ª ×¡×¤×¨":"×—×•×¤×™×"},
  {"×¨×©×•×ª":"×.× ×—×•×£ ××©×§×œ×•×Ÿ","×‘×™×ª ×¡×¤×¨":"××•×¨×©×”"},
  {"×¨×©×•×ª":"×.× ×—×•×£ ××©×§×œ×•×Ÿ","×‘×™×ª ×¡×¤×¨":"× ×™×¦×Ÿ"},
  {"×¨×©×•×ª":"×.× ×—×•×£ ××©×§×œ×•×Ÿ","×‘×™×ª ×¡×¤×¨":"× ×™×¦× ×™ ×§×œ×™×£"},
  {"×¨×©×•×ª":"×.× ×—×•×£ ××©×§×œ×•×Ÿ","×‘×™×ª ×¡×¤×¨":"×©×“×•×ª ×¡×™×œ×‘×¨"},
  {"×¨×©×•×ª":"××•×“×™×¢×™×Ÿ","×‘×™×ª ×¡×¤×¨":"×ª×™×›×•×Ÿ ×‘'"},
  {"×¨×©×•×ª":"× ×¡ ×¦×™×•× ×”","×‘×™×ª ×¡×¤×¨":"×‘×Ÿ ×’×•×¨×™×•×Ÿ"},
  {"×¨×©×•×ª":"×§×¨×™×™×ª ×’×ª","×‘×™×ª ×¡×¤×¨":"××•×¨×˜ ×’×¨×•×¡"},
  {"×¨×©×•×ª":"×§×¨×™×™×ª ×’×ª","×‘×™×ª ×¡×¤×¨":"××•×¨×˜ ×××™×¨"},
  {"×¨×©×•×ª":"×§×¨×™×™×ª ×’×ª","×‘×™×ª ×¡×¤×¨":"×‘×Ÿ ×¦×‘×™"},
  {"×¨×©×•×ª":"×§×¨×™×™×ª ×’×ª","×‘×™×ª ×¡×¤×¨":"×“×•×“ ××œ×¢×–×¨"},
  {"×¨×©×•×ª":"×§×¨×™×™×ª ×’×ª","×‘×™×ª ×¡×¤×¨":"××©×•××”"},
  {"×¨×©×•×ª":"×§×¨×™×™×ª ××œ××›×™","×‘×™×ª ×¡×¤×¨":"×“×¨×•×¨"},
  {"×¨×©×•×ª":"×§×¨×™×™×ª ××œ××›×™","×‘×™×ª ×¡×¤×¨":"×¢××œ ×’×‘×¢×ª×™"},
  {"×¨×©×•×ª":"×¨××œ×”","×‘×™×ª ×¡×¤×¨":"×—×˜×™×‘×ª ×¢×™×“× ×™×"},
  {"×¨×©×•×ª":"×¨××œ×”","×‘×™×ª ×¡×¤×¨":"××§×™×£ ×™×’××œ ××œ×•×Ÿ"},
  {"×¨×©×•×ª":"×¨××œ×”","×‘×™×ª ×¡×¤×¨":"×ª×™×›×•×Ÿ ×¤×¨×•×¤ × ×’×¨"},
  {"×¨×©×•×ª":"×©×“×¨×•×ª","×‘×™×ª ×¡×¤×¨":"×—× ×™×ª×” ×‘'"},
  {"×¨×©×•×ª":"××‘×Ÿ ×©××•××œ","×‘×™×ª ×¡×¤×¨":"×©×¤×™×¨"},
  {"×¨×©×•×ª":"×©×¤×™×¨","×‘×™×ª ×¡×¤×¨":"×ª×ª×\"×“"},
  {"×¨×©×•×ª":"×©×¢×¨ ×”× ×’×‘","×‘×™×ª ×¡×¤×¨":"×©×“×•×ª ×¨×•×—××”"}
];

// Sort and add Zoom at beginning
schoolsData.sort((a, b) => a['×‘×™×ª ×¡×¤×¨'].localeCompare(b['×‘×™×ª ×¡×¤×¨'], 'he'));
schoolsData.unshift({"×¨×©×•×ª":"×–×•×","×‘×™×ª ×¡×¤×¨":"×–×•×"});

// =============== Login ===============
async function doLogin(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  
  const employeeId = document.getElementById('loginEmpNum').value.trim();
  const personalCode = document.getElementById('empCode').value.trim();
  const loginBtn = document.querySelector('#loginForm button[type="submit"]');
  const errorEl = document.getElementById('loginError');
  
  errorEl.classList.remove('show');
  
  if (!employeeId || !personalCode) {
    errorEl.textContent = '× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×¢×•×‘×“ ×•×§×•×“ ××™×©×™';
    errorEl.classList.add('show');
    return false;
  }
  
  if (loginBtn) {
    loginBtn.disabled = true;
    loginBtn.textContent = '××ª×—×‘×¨...';
  }
  
  try {
    const response = await fetch(
  'https://prod-23.israelcentral.logic.azure.com:443/workflows/39fabd0c7a1b418286fe5ec53a720f61/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=JSq3DkhLej1JC18oCJ3CtV7hjUdX_vu1E2j94LLsw_g',
  {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        employeeId: parseInt(employeeId, 10), 
        personalCode: parseInt(personalCode, 10) 
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      currentUser = data.employeeName;
      const empData = {
        empNum: data.employeeId.toString(),
        empName: data.employeeName,
        role: data.role,
        team: data.team || null
      };
      localStorage.setItem('currentUser', JSON.stringify(empData));
      
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      
      document.getElementById('empNum').value = empData.empNum;
      document.getElementById('empName').value = empData.empName;
      document.getElementById('userName').textContent = empData.empName;
      
      loadFromLocalStorage();
      updateStats();
      showPage(null, 'dashboard');
    } else {
      errorEl.textContent = data.message || '××¡×¤×¨ ×¢×•×‘×“ ××• ×§×•×“ ××™×©×™ ×©×’×•×™×™×';
      errorEl.classList.add('show');
    }
  } catch (error) {
    errorEl.textContent = '×©×’×™××ª ×ª×§×©×•×¨×ª - × ×¡×” ×©×•×‘';
    errorEl.classList.add('show');
  } finally {
    if (loginBtn) {
      loginBtn.disabled = false;
      loginBtn.textContent = '×”×ª×—×‘×¨×•×ª';
    }
  }
  
  return false;
}

function logout() {
  if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
    localStorage.removeItem('currentUser');
    currentUser = '';
    location.reload();
  }
}

// =============== Page Navigation ===============
function showPage(event, pageName) {
  if (event) {
    event.preventDefault();
  }
  
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  
  const pageMap = {
    'dashboard': 'dashboardPage',
    'add-record': 'addRecordPage',
    'records': 'recordsPage'
  };
  
  document.getElementById(pageMap[pageName]).classList.remove('hidden');
  
  if (event && event.target.closest('.nav-item')) {
    event.target.closest('.nav-item').classList.add('active');
  }
  
  if (pageName === 'dashboard') updateDashboard();
  if (pageName === 'records') renderRecordsTable();
}

// =============== Alert ===============
function showAlert(message, type = 'success') {
  const alert = document.getElementById('alertBox');
  const alertText = document.getElementById('alertText');
  
  alert.className = `alert ${type} show`;
  alertText.textContent = message;
  
  setTimeout(() => {
    alert.classList.remove('show');
  }, 5000);
}

// =============== LocalStorage ===============
function saveToLocalStorage() {
  localStorage.setItem('attendanceRecords', JSON.stringify(records));
}

function loadFromLocalStorage() {
  try {
    const data = localStorage.getItem('attendanceRecords');
    if (data) {
      records = JSON.parse(data);
    }
  } catch(e) {
    console.error('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×:', e);
  }
}

// =============== SharePoint Sync ===============
function syncFromSharePoint() {
  showAlert('âœ… ×”××¢×¨×›×ª ××•×›× ×” ×œ×¢×‘×•×“×”!', 'success');
}

function mergeRecords(loadedRecords) {
  const existingIds = new Set(records.map(r => r.id));
  loadedRecords.forEach(rec => {
    if (!existingIds.has(rec.id)) {
      records.push(rec);
    }
  });
}

// =============== File to Base64 ===============
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}

// =============== Format Attachments ===============
function formatAttachments(attachments) {
  if (!attachments || attachments.length === 0) {
    return '';
  }
  
  return attachments.map(file => {
    const sizeKB = (file.size / 1024).toFixed(1);
    return `${file.name} (${sizeKB} KB)`;
  }).join(', ');
}

// =============== Submit to SharePoint ===============
async function submitAll() {
  if (records.length === 0) {
    showAlert('××™×Ÿ × ×ª×•× ×™× ×œ×©×œ×™×—×”', 'error');
    return;
  }
  
  const pending = records.filter(r => r.status !== '× ×©×œ×—');
  
  if (pending.length === 0) {
    showAlert('××™×Ÿ ×¨×©×•××•×ª ×—×“×©×•×ª ×œ×©×œ×™×—×”', 'info');
    return;
  }
  
  showAlert(`ğŸš€ ×©×•×œ×— ${pending.length} ×“×™×•×•×—×™×...`, 'info');
  
  let success = 0;
  let failed = 0;
  
  for (const rec of pending) {
    try {
      console.log('=== DEBUG submitToSharePoint ===');
      console.log('rec:', rec);
      
      const payload = {
        employeeId: rec.empNum,
        employeeName: rec.empName,
        workDate: rec.date,
        startTime: rec.start || '',
        endTime: rec.end || '',
        hours: rec.hours,
        activityType: rec.activity,
        school: rec.school || '',
        municipality: rec.municipality,
        program: rec.program,
        sessionNumber: rec.session,
        km: rec.km || 0,
        totalExpenses: rec.totalExpenses || 0,
        expensesDetails: rec.expensesDetail || '',
        notes: rec.notes || '',
        attachments: rec.attachments || [],
        attachmentsNames: formatAttachments(rec.attachments || [])
      };
      
      console.log('=== PAYLOAD ===', JSON.stringify(payload, null, 2));
      
      const response = await fetch(
  'https://prod-23.israelcentral.logic.azure.com:443/workflows/39fabd0c7a1b418286fe5ec53a720f61/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=JSq3DkhLej1JC18oCJ3CtV7hjUdX_vu1E2j94LLsw_g',
  {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      
      console.log('Response:', response.status, response.statusText);
      
      if (response.ok) {
        rec.status = '× ×©×œ×—';
        success++;
      } else {
        failed++;
      }
    } catch(error) {
      console.error('×©×’×™××” ×‘×©×œ×™×—×”:', error);
      failed++;
    }
  }
  
  saveToLocalStorage();
  updateStats();
  renderRecordsTable();
  
  if (failed === 0) {
    showAlert(`âœ… ×›×œ ×”×“×™×•×•×—×™× (${success}) × ×©×œ×—×• ×‘×”×¦×œ×—×”!`, 'success');
  } else {
    showAlert(`âš ï¸ × ×©×œ×—×• ${success} ×“×™×•×•×—×™×, ${failed} × ×›×©×œ×•`, 'error');
  }
}

// =============== Statistics ===============
function updateStats() {
  const totalRecords = records.length;
  const totalHours = records.reduce((sum, r) => sum + (parseFloat(r.hours) || 0), 0).toFixed(2);
  const totalExpenses = records.reduce((sum, r) => sum + (parseFloat(r.totalExpenses) || 0), 0).toFixed(2);
  const pending = records.filter(r => r.status !== '× ×©×œ×—').length;
  
  document.getElementById('totalRecordsStat').textContent = totalRecords;
  document.getElementById('totalHoursStat').textContent = totalHours;
  document.getElementById('totalExpensesStat').textContent = totalExpenses + ' â‚ª';
  document.getElementById('pendingRecordsStat').textContent = pending;
}

// =============== Dashboard ===============
function updateDashboard() {
  updateStats();
  // ×”×˜×‘×œ×” ×”×•×¡×¨×” - ×¨×§ ××¢×“×›× ×™× ×¡×˜×˜×™×¡×˜×™×§×”
}

// =============== Calculate Hours ===============
function calculateHours() {
  const startTime = document.getElementById('startTime').value;
  const endTime = document.getElementById('endTime').value;
  
  if (startTime && endTime) {
    const start = new Date('2000-01-01 ' + startTime);
    const end = new Date('2000-01-01 ' + endTime);
    
    let diff = (end - start) / 1000 / 60 / 60;
    
    if (diff < 0) {
      diff += 24;
    }
    
    document.getElementById('hoursField').value = diff.toFixed(2);
  }
}

function calculateEditHours() {
  const startTime = document.getElementById('editStartTime').value;
  const endTime = document.getElementById('editEndTime').value;
  
  if (startTime && endTime) {
    const start = new Date('2000-01-01 ' + startTime);
    const end = new Date('2000-01-01 ' + endTime);
    
    let diff = (end - start) / 1000 / 60 / 60;
    
    if (diff < 0) {
      diff += 24;
    }
    
    document.getElementById('editHours').value = diff.toFixed(2);
  }
}

// =============== Add Record ===============
async function addRecord() {
  const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
  const empNum = userData.empNum || '';
  const empName = userData.empName || '';
  
  console.log('=== DEBUG addRecord ===');
  console.log('userData:', userData);
  console.log('empNum:', empNum);
  console.log('empName:', empName);
  
  const date = document.getElementById('recDate').value;
  const startTime = document.getElementById('startTime').value;
  const endTime = document.getElementById('endTime').value;
  const hours = parseFloat(document.getElementById('hoursField').value) || 0;
  const activity = document.getElementById('activityType').value;
  
  const schoolSelect = document.getElementById('schoolField');
  let school = '';
  let municipality = '';
  
  if (schoolSelect.value) {
    try {
      const schoolData = JSON.parse(schoolSelect.value);
      school = schoolData['×‘×™×ª ×¡×¤×¨'];
      municipality = schoolData['×¨×©×•×ª'];
    } catch(e) {}
  }
  
  const program = document.getElementById('programField').value;
  const session = document.getElementById('sessionNum').value;
  const km = parseFloat(document.getElementById('kmField').value) || 0;
  const totalExpenses = parseFloat(document.getElementById('totalExpenses').value) || 0;
  const expensesDetail = document.getElementById('expensesDetail').value;
  const notes = document.getElementById('notesField').value;
  
  const attachments = [];
  const fileInput = document.getElementById('attachments');
  if (fileInput && fileInput.files.length > 0) {
    for (const file of fileInput.files) {
      const base64 = await fileToBase64(file);
      attachments.push({
        name: file.name,
        type: file.type,
        size: file.size,
        content: base64
      });
    }
  }
  
  const missing = [];
  if (!date) missing.push('×ª××¨×™×š');
  if (!startTime) missing.push('×©×¢×ª ×”×ª×—×œ×”');
  if (!endTime) missing.push('×©×¢×ª ×¡×™×•×');
  if (!hours) missing.push('×©×¢×•×ª');
  if (!activity) missing.push('×¡×•×’ ×¤×¢×™×œ×•×ª');
  if (!school) missing.push('×‘×™×ª ×¡×¤×¨');
  if (!municipality) missing.push('×¨×©×•×ª');
  if (!program) missing.push('×ª×•×›× ×™×ª');
  if (!session) missing.push('××¡×¤×¨ ××¤×’×©');
  
  if (missing.length > 0) {
    showAlert('âš ï¸ ×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”: ' + missing.join(', '), 'error');
    return;
  }
  
  const newRecord = {
    empNum,
    empName,
    date,
    start: startTime,
    end: endTime,
    hours,
    activity,
    school,
    municipality,
    location: '',
    program,
    session,
    km,
    totalExpenses,
    expensesDetail,
    attachments,
    notes,
    status: '×××ª×™×Ÿ',
    id: empNum + '_' + date + '_' + Date.now()
  };
  
  records.push(newRecord);
  saveToLocalStorage();
  updateStats();
  
  // Clear form
  document.getElementById('recDate').value = '';
  document.getElementById('startTime').value = '';
  document.getElementById('endTime').value = '';
  document.getElementById('hoursField').value = '';
  document.getElementById('activityType').value = '';
  document.getElementById('schoolField').value = '';
  document.getElementById('municipality').value = '';
  document.getElementById('programField').value = '';
  document.getElementById('sessionNum').value = '';
  document.getElementById('kmField').value = '';
  document.getElementById('totalExpenses').value = '';
  document.getElementById('expensesDetail').value = '';
  if (document.getElementById('attachments')) document.getElementById('attachments').value = '';
  document.getElementById('notesField').value = '';
  
  showAlert('âœ… ×”×¨×©×•××” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!', 'success');
  showPage(null, 'dashboard');
}

// =============== Records Table ===============
function renderRecordsTable() {
  document.getElementById('totalRecordsCount').textContent = records.length;
  
  const totalHours = records.reduce((sum, rec) => sum + (rec.hours || 0), 0);
  const totalKm = records.reduce((sum, rec) => sum + (rec.km || 0), 0);
  
  if (records.length === 0) {
    document.getElementById('recordsTable').innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px;">××™×Ÿ ×¨×©×•××•×ª ×œ×”×¦×’×”</p>';
    return;
  }
  
  const tableHTML = `
    <table>
      <thead>
        <tr>
          <th>×ª××¨×™×š</th>
          <th>×¢×•×‘×“</th>
          <th>×©×¢×•×ª ×”×ª×—×œ×”</th>
          <th>×©×¢×•×ª ×¡×™×•×</th>
          <th>×¡×”"×› ×©×¢×•×ª</th>
          <th>×¤×¢×™×œ×•×ª</th>
          <th>×‘×™×ª ×¡×¤×¨</th>
          <th>×¨×©×•×ª</th>
          <th>×§"×</th>
          <th>×¡×˜×˜×•×¡</th>
          <th>×¤×¢×•×œ×•×ª</th>
        </tr>
      </thead>
      <tbody>
        ${records.map((rec, idx) => `
          <tr>
            <td>${rec.date}</td>
            <td>${rec.empName}</td>
            <td>${rec.start || '-'}</td>
            <td>${rec.end || '-'}</td>
            <td><strong>${parseFloat(rec.hours).toFixed(2)}</strong></td>
            <td>${rec.activity}</td>
            <td>${rec.school || '-'}</td>
            <td>${rec.municipality}</td>
            <td>${rec.km}</td>
            <td><span class="status-badge ${rec.status === '× ×©×œ×—' ? 'sent' : 'pending'}">${rec.status}</span></td>
            <td>
              <button class="btn" onclick="editRecord(${idx})" style="background: #dbeafe; color: #1e40af; padding: 8px 12px; margin-left: 5px;">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn" onclick="deleteRecord(${idx})" style="background: #fee2e2; color: #dc2626; padding: 8px 12px;">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `).join('')}
        <tr style="background: #f8fafc; font-weight: bold; border-top: 2px solid #3b82f6;">
          <td colspan="4" style="text-align: left; padding-right: 20px;">×¡×”"×›:</td>
          <td style="color: #3b82f6;">${totalHours.toFixed(2)}</td>
          <td colspan="3"></td>
          <td style="color: #3b82f6;">${totalKm.toFixed(1)}</td>
          <td colspan="2"></td>
        </tr>
      </tbody>
    </table>
  `;
  
  document.getElementById('recordsTable').innerHTML = tableHTML;
}

function deleteRecord(index) {
  if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¨×©×•××” ×–×•?')) {
    records.splice(index, 1);
    saveToLocalStorage();
    updateStats();
    renderRecordsTable();
    showAlert('ğŸ—‘ï¸ ×”×¨×©×•××” × ××—×§×” ×‘×”×¦×œ×—×”', 'success');
  }
}

// =============== Edit Record ===============
function editRecord(index) {
  editingIndex = index;
  const rec = records[index];
  
  document.getElementById('editDate').value = rec.date;
  document.getElementById('editStartTime').value = rec.start || '';
  document.getElementById('editEndTime').value = rec.end || '';
  document.getElementById('editHours').value = rec.hours;
  document.getElementById('editActivity').value = rec.activity;
  
  const schoolSelect = document.getElementById('editSchool');
  schoolSelect.innerHTML = '<option value="">×‘×—×¨ ×‘×™×ª ×¡×¤×¨</option>';
  schoolsData.forEach(school => {
    const option = document.createElement('option');
    option.value = JSON.stringify(school);
    option.textContent = school['×‘×™×ª ×¡×¤×¨'];
    if (school['×‘×™×ª ×¡×¤×¨'] === rec.school) {
      option.selected = true;
    }
    schoolSelect.appendChild(option);
  });
  
  document.getElementById('editMunicipality').value = rec.municipality;
  document.getElementById('editProgram').value = rec.program || '';
  document.getElementById('editSession').value = rec.session || '';
  document.getElementById('editKm').value = rec.km || '';
  document.getElementById('editTotalExpenses').value = rec.totalExpenses || '';
  document.getElementById('editExpensesDetail').value = rec.expensesDetail || '';
  document.getElementById('editNotes').value = rec.notes || '';
  
  if (rec.school === '×–×•×') {
    document.getElementById('editKm').value = '0';
    document.getElementById('editKm').readOnly = true;
    document.getElementById('editKm').style.background = '#f1f5f9';
  } else {
    document.getElementById('editKm').readOnly = false;
    document.getElementById('editKm').style.background = 'white';
  }
  
  document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
  editingIndex = -1;
}

function updateEditMunicipality() {
  const schoolSelect = document.getElementById('editSchool');
  const municipalityInput = document.getElementById('editMunicipality');
  const kmField = document.getElementById('editKm');
  
  if (schoolSelect.value) {
    try {
      const school = JSON.parse(schoolSelect.value);
      municipalityInput.value = school['×¨×©×•×ª'];
      
      if (school['×‘×™×ª ×¡×¤×¨'] === '×–×•×') {
        kmField.value = '0';
        kmField.readOnly = true;
        kmField.style.background = '#f1f5f9';
        kmField.style.cursor = 'not-allowed';
      } else {
        kmField.readOnly = false;
        kmField.style.background = 'white';
        kmField.style.cursor = 'text';
      }
    } catch(e) {
      console.error('×©×’×™××” ×‘×¢×™×“×›×•×Ÿ ×¨×©×•×ª:', e);
    }
  }
}

async function saveEdit() {
  if (editingIndex === -1) return;
  
  const date = document.getElementById('editDate').value;
  const startTime = document.getElementById('editStartTime').value;
  const endTime = document.getElementById('editEndTime').value;
  const hours = parseFloat(document.getElementById('editHours').value) || 0;
  const activity = document.getElementById('editActivity').value;
  const schoolSelect = document.getElementById('editSchool');
  const municipality = document.getElementById('editMunicipality').value;
  const program = document.getElementById('editProgram').value;
  const session = document.getElementById('editSession').value;
  const km = parseFloat(document.getElementById('editKm').value) || 0;
  const totalExpenses = parseFloat(document.getElementById('editTotalExpenses').value) || 0;
  const expensesDetail = document.getElementById('editExpensesDetail').value;
  const notes = document.getElementById('editNotes').value;
  const attachmentsInput = document.getElementById('editAttachments');
  let attachments = records[editingIndex].attachments || [];
  
  if (attachmentsInput.files.length > 0) {
    for (const file of attachmentsInput.files) {
      const base64 = await fileToBase64(file);
      attachments.push({ 
        name: file.name, 
        size: file.size,
        type: file.type,
        content: base64 
      });
    }
  }
  
  let school = '';
  if (schoolSelect.value) {
    try {
      const schoolData = JSON.parse(schoolSelect.value);
      school = schoolData['×‘×™×ª ×¡×¤×¨'];
    } catch(e) {}
  }
  
  const missing = [];
  if (!date) missing.push('×ª××¨×™×š');
  if (!startTime) missing.push('×©×¢×ª ×”×ª×—×œ×”');
  if (!endTime) missing.push('×©×¢×ª ×¡×™×•×');
  if (!hours) missing.push('×©×¢×•×ª');
  if (!activity) missing.push('×¡×•×’ ×¤×¢×™×œ×•×ª');
  if (!school) missing.push('×‘×™×ª ×¡×¤×¨');
  if (!municipality) missing.push('×¨×©×•×ª');
  if (!program) missing.push('×ª×•×›× ×™×ª');
  if (!session) missing.push('××¡×¤×¨ ××¤×’×©');
  
  if (missing.length > 0) {
    showAlert('âš ï¸ ×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”: ' + missing.join(', '), 'error');
    return;
  }
  
  records[editingIndex] = {
    ...records[editingIndex],
    date,
    start: startTime,
    end: endTime,
    hours,
    activity,
    school,
    municipality,
    location: '',
    program,
    session,
    km,
    totalExpenses,
    expensesDetail,
    notes,
    attachments,
    status: '×××ª×™×Ÿ'
  };
  
  saveToLocalStorage();
  updateStats();
  renderRecordsTable();
  closeEditModal();
  showAlert('âœ… ×”×¨×©×•××” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!', 'success');
}

// =============== Schools Functions ===============
function populateSchools() {
  const schoolSelect = document.getElementById('schoolField');
  schoolSelect.innerHTML = '<option value="">×‘×—×¨ ×‘×™×ª ×¡×¤×¨</option>';
  
  schoolsData.forEach(school => {
    const option = document.createElement('option');
    option.value = JSON.stringify(school);
    option.textContent = school['×‘×™×ª ×¡×¤×¨'];
    schoolSelect.appendChild(option);
  });
}

function updateMunicipalityFromSchool() {
  const schoolSelect = document.getElementById('schoolField');
  const municipalityInput = document.getElementById('municipality');
  const kmField = document.getElementById('kmField');
  
  if (schoolSelect.value) {
    try {
      const school = JSON.parse(schoolSelect.value);
      municipalityInput.value = school['×¨×©×•×ª'];
      
      if (school['×‘×™×ª ×¡×¤×¨'] === '×–×•×') {
        kmField.value = '0';
        kmField.readOnly = true;
        kmField.style.background = '#f1f5f9';
        kmField.style.cursor = 'not-allowed';
        kmField.removeAttribute('required');
      } else {
        kmField.readOnly = false;
        kmField.style.background = 'white';
        kmField.style.cursor = 'text';
      }
    } catch(e) {
      console.error('×©×’×™××” ×‘×¢×™×“×›×•×Ÿ ×¨×©×•×ª:', e);
    }
  }
}

// =============== Export & Clear ===============
function exportToExcel() {
  if (records.length === 0) {
    showAlert('âš ï¸ ××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×', 'error');
    return;
  }
  
  let csv = '××¡×¤×¨ ×¢×•×‘×“,×©× ×¢×•×‘×“,×ª××¨×™×š,×©×¢×ª ×”×ª×—×œ×”,×©×¢×ª ×¡×™×•×,×©×¢×•×ª,×¡×•×’ ×¤×¢×™×œ×•×ª,×‘×™×ª ×¡×¤×¨,×¨×©×•×ª,×ª×•×›× ×™×ª,××¡×¤×¨ ××¤×’×©,×§×™×œ×•××˜×¨,×”×•×¦××•×ª,×¤×™×¨×•×˜ ×”×•×¦××•×ª,×”×¢×¨×•×ª\n';
  
  records.forEach(rec => {
    csv += `${rec.empNum},${rec.empName},${rec.date},${rec.start || ''},${rec.end || ''},${rec.hours},${rec.activity},${rec.school || ''},${rec.municipality},${rec.program},${rec.session},${rec.km || 0},${rec.totalExpenses || 0},"${(rec.expensesDetail || '').replace(/"/g, '""')}","${(rec.notes || '').replace(/"/g, '""')}"\n`;
  });
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `× ×•×›×—×•×ª_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  
  showAlert('âœ… ×”×§×•×‘×¥ ×™×•×¦× ×‘×”×¦×œ×—×”!', 'success');
}

function clearAllData() {
  if (!confirm('âš ï¸ ××–×”×¨×”! ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™×!\n\n×”×× ××ª×” ×‘×˜×•×— ×œ×—×œ×•×˜×™×Ÿ?')) {
    return;
  }
  
  if (!confirm('×”×× ××ª×” ×‘×××ª ×‘×˜×•×—? ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”!')) {
    return;
  }
  
  records = [];
  saveToLocalStorage();
  updateStats();
  renderRecordsTable();
  updateDashboard();
  
  showAlert('ğŸ—‘ï¸ ×›×œ ×”× ×ª×•× ×™× × ××—×§×•!', 'success');
}

// =============== Initialize ===============
window.addEventListener('DOMContentLoaded', function() {
  populateSchools();
  
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    try {
      const empData = JSON.parse(savedUser);
      currentUser = empData.empName;
      
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      
      document.getElementById('empNum').value = empData.empNum;
      document.getElementById('empName').value = empData.empName;
      document.getElementById('userName').textContent = empData.empName;
      
      loadFromLocalStorage();
      updateStats();
      showPage(null, 'dashboard');
    } catch(e) {
      console.error('×©×’×™××”:', e);
    }
  }
});
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('ServiceWorker registration successful');
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
  });
}
</script>
</body>

</html>
