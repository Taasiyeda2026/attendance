<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1e40af">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="נוכחות">
  <title>מערכת נוכחות - תעשיידע</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" href="./logo.png">
  <link rel="apple-touch-icon" href="./logo.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    /* iOS and Mobile Touch Fixes */
    html {
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Heebo', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
      color: #1e293b;
      direction: rtl;
      font-size: 14px;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      max-width: 100vw;
      position: relative;
    }
    
    html {
      overflow-x: hidden;
      max-width: 100vw;
    }
    
    #mainApp, #loginScreen {
      max-width: 100vw;
      overflow-x: hidden;
    }
    
    /* Prevent iOS zoom on input focus */
    input, select, textarea {
      font-size: 16px !important;
    }
    
    /* Better touch targets */
    a, button, input, select, textarea, .nav-item, .btn {
      touch-action: manipulation;
    }
    
    /* Safe area padding for notched phones */
    .mobile-bottom-nav {
      padding-bottom: max(env(safe-area-inset-bottom), 8px);
    }
    
    .main-content {
      padding-bottom: max(env(safe-area-inset-bottom), 20px);
    }
    
    /* Smooth transitions for all interactive elements */
    button, .btn, input, select, .nav-item, .stat-card, .card {
      transition: all 0.2s ease;
    }

    .hidden { display: none !important; }

    /* ============= Login Screen ============= */
    #loginScreen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #e8eef5 0%, #f1f5f9 50%, #e2e8f0 100%);
      padding: 20px;
    }

    .login-card {
      background: white;
      padding: 35px 30px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
      max-width: 360px;
      width: 100%;
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .login-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(0,0,0,0.15), 0 5px 15px rgba(0,0,0,0.1);
    }

    .login-logo {
      max-width: 160px;
      margin-bottom: 20px;
    }

    .login-card h2 {
      color: #1e293b;
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .login-card p {
      color: #64748b;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .form-group {
      margin-bottom: 14px;
      text-align: right;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: #475569;
      font-weight: 500;
      font-size: 13px;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Heebo', sans-serif;
      transition: all 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-login {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Heebo', sans-serif;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 8px;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-login:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(30, 64, 175, 0.3);
    }

    .btn-login:active {
      transform: translateY(0);
    }

    .login-error {
      color: #ef4444;
      background: #fee2e2;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
      display: none;
    }

    .login-error.show {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* ============= Main App Layout ============= */
    #mainApp {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
      border-left: 1px solid #e8ecf1;
      display: flex;
      flex-direction: column;
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
      box-shadow: -4px 0 20px rgba(0,0,0,0.04), -1px 0 6px rgba(0,0,0,0.02);
    }

    .sidebar-header {
      padding: 16px 14px;
      border-bottom: 1px solid #e2e8f0;
      text-align: center;
    }

    .sidebar-logo {
      max-width: 130px;
    }

    .sidebar-user {
      padding: 14px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
    }

    .user-info h3 {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .user-info p {
      font-size: 12px;
      color: #64748b;
    }

    .sidebar-nav {
      flex: 1;
      padding: 12px 10px;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      color: #64748b;
      text-decoration: none;
      border-radius: 10px;
      margin-bottom: 3px;
      transition: all 0.25s ease;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      position: relative;
    }

    .nav-item:hover {
      background: linear-gradient(135deg, #f1f5f9 0%, #e8ecf1 100%);
      transform: translateX(-2px);
      color: #3b82f6;
    }

    .nav-item.active {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: #3b82f6;
    }

    .nav-item i {
      margin-left: 10px;
      font-size: 15px;
      width: 20px;
    }

    .sidebar-footer {
      padding: 12px;
      border-top: 1px solid #e2e8f0;
    }

    .btn-logout {
      width: 100%;
      padding: 10px;
      background: #fee2e2;
      color: #dc2626;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Heebo', sans-serif;
    }

    .btn-logout:hover {
      background: #fecaca;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-right: 240px;
      padding: 20px;
    }

    .page-header {
      margin-bottom: 20px;
    }

    .page-header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 4px;
    }

    .page-header p {
      color: #64748b;
      font-size: 13px;
    }

    /* Dashboard Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.8);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, rgba(59,130,246,0.3), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 16px 32px rgba(0,0,0,0.06);
      border-color: #e2e8f0;
    }
    
    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .stat-card-title {
      color: #64748b;
      font-size: 12px;
      font-weight: 500;
    }

    .stat-card-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .stat-card.blue .stat-card-icon {
      background: #eff6ff;
      color: #3b82f6;
    }

    .stat-card.purple .stat-card-icon {
      background: #f3e8ff;
      color: #a855f7;
    }

    .stat-card.green .stat-card-icon {
      background: #ecfdf5;
      color: #10b981;
    }

    .stat-card.orange .stat-card-icon {
      background: #fff7ed;
      color: #f59e0b;
    }

    .stat-card-value {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .stat-card-label {
      font-size: 11px;
      color: #94a3b8;
    }

    /* Content Card */
    .content-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.04);
      border: 1px solid #f1f5f9;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .content-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .card-header {
      padding: 16px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(180deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.4) 100%);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
    }

    .card-body {
      padding: 16px;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    table thead {
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
    }

    table th {
      padding: 10px 12px;
      text-align: right;
      font-weight: 600;
      color: #475569;
      font-size: 12px;
    }

    table td {
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      color: #64748b;
      font-size: 12px;
    }

    table tbody tr:hover {
      background: #f8fafc;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Heebo', sans-serif;
      transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    /* Alert */
    .alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s;
    }

    .alert.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .alert.success {
      background: #dcfce7;
      color: #16a34a;
    }

    .alert.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .alert.info {
      background: #dbeafe;
      color: #3b82f6;
    }

    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-bottom: 14px;
      padding: 16px;
    }
    
    @media (max-width: 1200px) {
      .form-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-field label {
      display: block;
      margin-bottom: 4px;
      color: #475569;
      font-weight: 500;
      font-size: 13px;
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      width: 100%;
      max-width: 350px;
      padding: 8px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Heebo', sans-serif;
      transition: all 0.25s ease;
      background: linear-gradient(180deg, #ffffff 0%, #fafbfc 100%);
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }
    
    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1), inset 0 1px 2px rgba(0,0,0,0.04);
      outline: none;
    }

    .form-field textarea {
      max-width: 100%;
    }

    .form-field input[type="time"] {
      cursor: pointer;
      -webkit-appearance: listbox;
      position: relative;
    }
    
    /* Fix for time input odd behavior on some mobile browsers */
    input[type="time"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
    }

    /* Time picker dropdowns - RTL aligned with LTR internal display */
    .time-picker-row {
      display: flex;
      flex-direction: row-reverse;
      gap: 6px;
      align-items: center;
      width: 180px;
      max-width: 180px;
    }

    .time-picker-row select {
      width: 72px;
      min-width: 72px;
      max-width: 72px;
      flex-shrink: 0;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
      max-height: 200px;
      overflow-y: auto;
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      border: 1.5px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px 8px;
      color: #1e40af;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .time-picker-row select:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
    }
    
    .time-picker-row select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .time-picker-row .time-separator {
      font-size: 20px;
      font-weight: bold;
      color: #3b82f6;
      width: 12px;
      text-align: center;
    }

    @media (max-width: 768px) {
      .time-picker-row select {
        min-height: 50px;
        font-size: 18px;
      }

      .time-picker-row .time-separator {
        font-size: 24px;
      }
    }

    .form-field input:-moz-read-only {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    .form-field input:read-only {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    /* Page */
    .page {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Hide floating submit on desktop */
    .mobile-floating-submit {
      display: none;
    }

    /* Mobile Greeting Header */
    .mobile-greeting {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 60px;
      height: 54px;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      padding: 0 16px;
      z-index: 199;
      align-items: center;
      font-weight: 600;
      font-size: 16px;
      gap: 12px;
    }
    
    .mobile-greeting .mobile-logo {
      height: 32px;
      width: auto;
      display: none;
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none; /* Hidden on desktop */
      position: fixed;
      top: 5px;
      right: 10px;
      z-index: 200;
      background: #1e40af;
      color: white;
      border: none;
      border-radius: 8px;
      width: 44px;
      height: 44px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s ease;
    }
    
    .mobile-menu-toggle:active {
      transform: scale(0.95);
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }

    /* Responsive - Tablet */
    @media (max-width: 1024px) {
      .sidebar {
        width: 220px;
      }
      .main-content {
        margin-right: 220px;
        padding: 16px;
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Add Record Page - Mobile Responsive */
    @media (max-width: 900px) {
      #addRecordPage > div[style*="grid-template-columns: repeat(2"] {
        grid-template-columns: 1fr !important;
      }
    }
    
    @media (max-width: 768px) {
      #addRecordPage .page-header {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 12px !important;
      }
      
      #addRecordPage .page-header > div:first-child {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 10px !important;
      }
      
      #addRecordPage .page-header h1 {
        font-size: 20px !important;
      }
      
      #formUserInfoHeader {
        width: 100% !important;
        justify-content: center !important;
        font-size: 13px !important;
        padding: 8px 12px !important;
      }
      
      #addRecordPage .page-header > div:last-child {
        justify-content: center !important;
      }
    }

    /* ============= MOBILE RESPONSIVE - 768px ============= */
    @media (max-width: 768px) {
      /* Base */
      body {
        font-size: 16px;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }

      /* Mobile Header */
      .mobile-greeting {
        display: flex;
        height: 56px;
        right: 0;
        padding-right: 60px;
      }
      
      /* ===== הצגת לוגו במובייל ===== */
      .mobile-greeting .mobile-logo {
        display: block !important;
      }

      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 46px;
        height: 46px;
        top: 5px;
        right: 8px;
      }

      .mobile-overlay.active {
        display: block;
      }
      
      /* Sidebar Mobile */
      .sidebar {
        position: fixed;
        right: -280px;
        width: 280px;
        max-width: 85vw;
        height: 100vh;
        max-height: 100vh;
        overflow-y: auto;
        overflow-x: hidden;
        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 150;
        box-shadow: -8px 0 30px rgba(0,0,0,0.15);
        -webkit-overflow-scrolling: touch;
      }

      .sidebar.open {
        right: 0;
      }
      
      .sidebar-header {
        padding: 20px 16px;
      }
      
      .sidebar-user {
        padding: 16px;
      }
      
      .user-avatar {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }
      
      .user-info h3 {
        font-size: 16px;
      }
      
      .user-info p {
        font-size: 13px;
      }

      .sidebar-nav .nav-item {
        padding: 16px 18px;
        font-size: 16px;
        min-height: 54px;
        border-radius: 12px;
        margin-bottom: 4px;
      }

      .sidebar-nav .nav-item i {
        font-size: 20px;
        width: 24px;
        margin-left: 12px;
      }
      
      .sidebar-footer {
        padding: 16px;
      }
      
      .btn-logout {
        padding: 14px;
        font-size: 15px;
        border-radius: 10px;
        min-height: 48px;
      }

      /* Main Content */
      .main-content {
        margin-right: 0;
        padding: 72px 12px 100px 12px;
      }

      .page-header {
        margin-bottom: 16px;
      }

      .page-header h1 {
        font-size: 22px;
        line-height: 1.3;
      }

      .page-header p {
        font-size: 14px;
      }

      /* Stats Cards */
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .stat-card {
        padding: 14px 12px;
        border-radius: 12px;
      }

      .stat-card-value {
        font-size: 20px;
      }

      .stat-card-title {
        font-size: 11px;
      }
      
      .stat-card-label {
        font-size: 10px;
      }

      .stat-card-icon {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      /* Content Cards */
      .content-card {
        border-radius: 12px;
        margin-bottom: 12px;
      }

      .card-header {
        padding: 14px;
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .card-header h2,
      .card-title {
        font-size: 16px;
      }

      .card-body {
        padding: 12px;
      }

      /* Forms */
      .form-grid {
        grid-template-columns: 1fr;
        padding: 14px;
        gap: 14px;
      }

      .form-field {
        margin-bottom: 0;
      }

      .form-field label {
        font-size: 14px;
        margin-bottom: 8px;
        font-weight: 600;
        display: block;
      }

      .form-field input,
      .form-field select,
      .form-field textarea {
        width: 100%;
        max-width: 100%;
        padding: 14px 16px;
        font-size: 16px;
        min-height: 52px;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
      }
      
      .form-field input:focus,
      .form-field select:focus,
      .form-field textarea:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59,130,246,0.15);
      }
      
      .form-field textarea {
        min-height: 100px;
      }

      .form-field select {
        -webkit-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: left 16px center;
        padding-left: 40px;
      }
      
      /* Time Picker Mobile */
      .time-picker-row {
        width: 100%;
        max-width: 100%;
        justify-content: center;
        gap: 8px;
      }
      
      .time-picker-row select {
        width: 80px;
        min-width: 80px;
        max-width: 80px;
        min-height: 52px;
        font-size: 18px;
        padding: 12px 10px;
        border-radius: 12px;
        border: 2px solid #cbd5e1;
      }
      
      .time-picker-row .time-separator {
        font-size: 26px;
        width: 20px;
      }

      /* Buttons */
      .btn {
        padding: 16px 20px;
        font-size: 16px;
        width: 100%;
        min-height: 54px;
        border-radius: 12px;
        font-weight: 600;
      }

      .btn-back {
        min-height: 48px;
        font-size: 15px;
        padding: 12px 16px;
      }

      .form-actions {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
      }
      
      /* Dashboard buttons */
      #dashboardPage .btn {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      #dashboardPage > div[style*="display: flex"][style*="gap"] {
        flex-direction: column !important;
      }

      /* Tables - Scrollable */
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
        border-radius: 8px;
      }

      table th,
      table td {
        padding: 10px 8px;
        font-size: 12px;
      }
      
      table th {
        font-weight: 600;
        background: #f1f5f9;
      }
      
      /* Records Table Compact */
      #recordsPage table,
      #teamRecordsPage table {
        font-size: 11px;
      }
      
      #recordsPage table th,
      #recordsPage table td,
      #teamRecordsPage table th,
      #teamRecordsPage table td {
        padding: 8px 6px;
        min-width: 50px;
      }
      
      /* Admin/Payroll Tables - Compact for mobile */
      .admin-table {
        font-size: 10px !important;
        min-width: 600px !important;
      }
      
      .admin-table th,
      .admin-table td {
        padding: 8px 4px !important;
        white-space: nowrap;
      }
      
      #payrollDashboard .card-header,
      #adminControllerDashboard .card-header {
        flex-direction: column !important;
        gap: 12px !important;
        align-items: stretch !important;
      }
      
      #payrollDashboard .card-header .btn,
      #adminControllerDashboard .card-header .btn {
        width: 100% !important;
        justify-content: center;
      }
      
      #recordsPage .page-header,
      #teamRecordsPage .page-header {
        padding: 8px 0;
      }
      
      #recordsPage .card-header,
      #teamRecordsPage .card-header {
        flex-direction: column;
        gap: 10px;
        padding: 12px;
      }
      
      #recordsPage .card-header .btn,
      #teamRecordsPage .card-header .btn {
        font-size: 14px;
        padding: 10px 14px;
        min-height: 44px;
        width: 100%;
      }

      /* Modal */
      .modal {
        padding: 8px;
        align-items: flex-start;
        overflow-y: auto;
      }
      
      .modal-content {
        padding: 16px;
        margin: 8px auto;
        max-height: none;
        border-radius: 16px;
        width: 100%;
        max-width: 100%;
      }
      
      .modal-header {
        margin-bottom: 16px;
        padding-bottom: 12px;
      }

      .modal-header h3 {
        font-size: 18px;
      }
      
      .close-btn {
        width: 40px;
        height: 40px;
        font-size: 22px;
      }
      
      .modal-footer {
        margin-top: 16px;
        padding-top: 16px;
        flex-direction: column;
        gap: 10px;
      }
      
      .modal-footer .btn {
        width: 100%;
      }
      
      /* Edit Modal specific */
      #editModal .form-grid {
        grid-template-columns: 1fr;
      }

      /* Floating Submit Button */
      .mobile-floating-submit {
        display: block;
        position: fixed;
        bottom: 80px;
        left: 12px;
        right: 12px;
        z-index: 180;
        padding: 10px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 -4px 24px rgba(0,0,0,0.18);
      }
      
      .mobile-floating-submit .btn {
        margin: 0;
      }

      /* Alert */
      .alert {
        font-size: 14px;
        padding: 14px 16px;
        left: 12px;
        right: 12px;
        transform: translateY(-100px);
        width: auto;
        border-radius: 12px;
      }
      
      .alert.show {
        transform: translateY(0);
      }
      
      /* Login Card Mobile */
      .login-card {
        padding: 28px 24px;
        margin: 12px;
        border-radius: 20px;
      }
      
      .login-card h1 {
        font-size: 28px !important;
      }
      
      .login-logo {
        max-width: 70px !important;
      }
      
      .login-card .form-group input {
        padding: 16px;
        font-size: 16px;
        min-height: 54px;
        border-radius: 12px;
      }
      
      .btn-login {
        padding: 16px;
        font-size: 17px;
        min-height: 56px;
        border-radius: 12px;
      }
      
      /* Reports Page filters */
      #reportsPage .card-header {
        padding: 12px;
      }
      
      #reportsPage .form-group {
        min-width: 100% !important;
        width: 100% !important;
      }
      
      /* ===== הקטנת תיבות select בדוחות ===== */
      #reportsPage select {
        width: 100%;
        min-height: 38px !important;
        font-size: 13px !important;
        padding: 8px 10px !important;
      }
      
      /* Admin Dashboard filters */
      #adminDashboardFilters {
        flex-direction: column !important;
        align-items: stretch !important;
      }
      
      #adminDashboardFilters > div {
        width: 100% !important;
        flex-direction: column !important;
      }
      
      #adminDashboardFilters select,
      #adminDashboardFilters button {
        width: 100% !important;
        min-height: 48px;
      }
      
      /* File upload */
      .file-upload-container {
        padding: 24px 16px;
      }
      
      .file-item {
        padding: 12px;
      }
      
      .file-item-name {
        font-size: 14px;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .file-item-remove {
        width: 32px;
        height: 32px;
        min-width: 32px;
      }
    }

    /* Mobile Bottom Navigation */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
      z-index: 200;
      padding: 8px 0;
      padding-bottom: env(safe-area-inset-bottom, 8px);
      border-top: 1px solid #e2e8f0;
    }

    .mobile-bottom-nav-inner {
      display: flex;
      justify-content: space-around;
      align-items: center;
      max-width: 500px;
      margin: 0 auto;
    }

    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 6px 4px;
      border: none;
      background: none;
      color: #64748b;
      font-size: 9px;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 48px;
      flex: 1;
      max-width: 70px;
      border-radius: 8px;
      -webkit-tap-highlight-color: transparent;
    }

    .mobile-nav-item i {
      font-size: 18px;
      transition: transform 0.2s ease;
    }

    .mobile-nav-item.active {
      color: #2563eb;
      background: rgba(37, 99, 235, 0.08);
    }
    
    .mobile-nav-item.active i {
      transform: scale(1.1);
    }

    .mobile-nav-item:active {
      background: rgba(37, 99, 235, 0.12);
      transform: scale(0.95);
    }

    @media (max-width: 768px) {
      /* ===== הסתרת סיידבר במובייל ===== */
      .sidebar {
        display: none !important;
      }
      
      /* ===== הצגת תפריט תחתון ===== */
      .mobile-bottom-nav {
        display: block;
      }

      /* ===== תיקון main-content ללא margin ===== */
      .main-content {
        margin-right: 0 !important;
        padding: 15px;
        padding-bottom: 90px;
        max-width: 100vw;
        overflow-x: hidden;
      }
      
      /* ===== הזזת הודעות למעלה כדי לא לכסות שם משתמש ===== */
      .alert {
        top: 10px !important;
        font-size: 13px !important;
        padding: 10px 16px !important;
        z-index: 9999 !important;
      }
      
      /* ===== הקטנת כל תיבות ה-select במובייל ===== */
      select, .form-field select {
        min-height: 38px !important;
        font-size: 13px !important;
        padding: 8px 10px !important;
      }
      
      /* ===== הקטנת כל ה-inputs במובייל ===== */
      input:not([type="checkbox"]):not([type="radio"]), 
      .form-field input:not([type="checkbox"]):not([type="radio"]) {
        min-height: 38px !important;
        font-size: 14px !important;
        padding: 8px 10px !important;
      }
      
      /* Hide start/end time columns on mobile - keep only total hours */
      #recordsPage table th:nth-child(2),
      #recordsPage table td:nth-child(2),
      #recordsPage table th:nth-child(3),
      #recordsPage table td:nth-child(3) {
        display: none;
      }
      
      #teamRecordsPage table th:nth-child(2),
      #teamRecordsPage table td:nth-child(2),
      #teamRecordsPage table th:nth-child(3),
      #teamRecordsPage table td:nth-child(3) {
        display: none;
      }
    }

    /* ============= SMALL MOBILE - 480px ============= */
    @media (max-width: 480px) {
      .main-content {
        padding: 68px 10px 95px 10px;
      }
      
      .mobile-greeting {
        font-size: 14px;
        height: 52px;
      }

      /* Stats single column */
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .stat-card {
        padding: 12px;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }

      .stat-card-header {
        flex-direction: row-reverse;
        gap: 12px;
      }
      
      .stat-card-value {
        font-size: 22px;
      }
      
      .stat-card-title {
        font-size: 12px;
      }
      
      .stat-card-icon {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }

      /* Login */
      .login-card {
        padding: 24px 20px;
        margin: 8px;
        border-radius: 16px;
      }

      .login-card h1 {
        font-size: 24px !important;
      }

      .login-card h2 {
        font-size: 20px;
      }

      .login-card p {
        font-size: 13px;
      }
      
      .login-logo {
        max-width: 60px !important;
      }

      .form-group input,
      .login-card .form-group input {
        padding: 14px;
        font-size: 16px;
        min-height: 52px;
      }

      .btn-login {
        padding: 16px;
        font-size: 16px;
        min-height: 52px;
      }
      
      /* Page header */
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 12px;
      }

      .page-header h1 {
        font-size: 18px;
        line-height: 1.3;
      }
      
      .page-header p {
        font-size: 13px;
      }
      
      .page-header > div:last-child {
        width: 100%;
        justify-content: flex-start;
      }

      /* Forms */
      .form-grid {
        padding: 10px;
        gap: 12px;
      }
      
      .form-field label {
        font-size: 13px;
        margin-bottom: 6px;
      }
      
      .form-field input,
      .form-field select,
      .form-field textarea {
        padding: 12px 14px;
        font-size: 16px;
        min-height: 50px;
      }

      .card-header,
      .card-body {
        padding: 12px;
      }
      
      .card-header h2 {
        font-size: 15px;
      }
      
      /* Time picker smaller */
      .time-picker-row select {
        width: 70px;
        min-width: 70px;
        max-width: 70px;
        min-height: 48px;
        font-size: 16px;
        padding: 10px 8px;
      }
      
      .time-picker-row .time-separator {
        font-size: 22px;
        width: 16px;
      }

      /* Mobile Table Scroll */
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        font-size: 11px;
        -webkit-overflow-scrolling: touch;
      }
      
      table th, table td {
        padding: 6px 5px;
        min-width: 45px;
      }
      
      table th:first-child, table td:first-child {
        position: sticky;
        right: 0;
        background: #f8fafc;
        z-index: 2;
        box-shadow: -2px 0 4px rgba(0,0,0,0.1);
      }
      
      /* Mobile buttons - הקטנה משמעותית */
      .btn {
        padding: 8px 12px !important;
        font-size: 12px !important;
        min-height: 38px !important;
      }
      
      .btn-back {
        font-size: 12px !important;
        padding: 7px 10px !important;
        min-height: 36px !important;
      }
      
      /* ===== הקטנת כפתורים בעמוד צוות ===== */
      #teamRecordsPage .btn,
      #teamPage .btn,
      #managementPage .btn {
        padding: 6px 10px !important;
        font-size: 11px !important;
        min-height: 34px !important;
      }
      
      /* Modal small mobile */
      .modal {
        padding: 4px;
      }
      
      .modal-content {
        padding: 14px;
        margin: 4px;
        border-radius: 14px;
      }
      
      .modal-header h3 {
        font-size: 16px;
      }
      
      .close-btn {
        width: 36px;
        height: 36px;
        font-size: 20px;
      }
      
      /* Floating submit */
      .mobile-floating-submit {
        bottom: 75px;
        left: 8px;
        right: 8px;
        padding: 8px;
        border-radius: 14px;
      }
      
      /* Alert */
      .alert {
        font-size: 13px;
        padding: 12px 14px;
        left: 8px;
        right: 8px;
      }
      
      /* Mobile bottom nav */
      .mobile-bottom-nav {
        padding: 6px 0;
      }
      
      .mobile-nav-item {
        padding: 6px 10px;
        font-size: 10px;
        min-width: 56px;
      }
      
      .mobile-nav-item i {
        font-size: 18px;
      }
    }

    /* File Upload Styles */
    .file-upload-container {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      background: #f8fafc;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .file-upload-container:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    .file-upload-container.dragover {
      border-color: #3b82f6;
      background: #dbeafe;
    }
    
    .file-list {
      margin-top: 10px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-top: 8px;
    }
    
    .file-item-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .file-item-remove {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Edit Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e2e8f0;
    }

    .modal-header h3 {
      margin: 0;
      color: #1e293b;
      font-size: 22px;
    }

    .close-btn {
      background: #fee2e2;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      color: #dc2626;
      font-size: 20px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: #fecaca;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px solid #e2e8f0;
    }

    .required-label::after {
      content: ' *';
      color: #dc2626;
      font-weight: bold;
    }
</style>
</head>
<body>
<!-- =============== Login Screen =============== -->
<div id="loginScreen">
  <div class="login-card">
    <img src="./logo.png" alt="תעשיידע" style="max-width: 80px; margin-bottom: 15px;">
    <h1 style="font-size: 32px; font-weight: 800; color: #1e293b; margin: 0 0 5px 0; letter-spacing: -0.5px;">תעשיידע</h1>
    <p style="font-size: 16px; color: #64748b; margin: 0 0 20px 0;">מערכת נוכחות</p>
    
    <form onsubmit="return doLogin(event);" id="loginForm">
      <div class="form-group">
        <label for="loginEmpNum">מספר עובד</label>
        <input type="text" id="loginEmpNum" placeholder="הזן מספר עובד" required>
      </div>
      
      <div class="form-group">
        <label for="empCode">קוד אישי</label>
        <input type="password" id="empCode" placeholder="הזן קוד אישי" required>
      </div>
      
      <button type="submit" class="btn-login" id="loginBtn">
        <i class="fas fa-sign-in-alt"></i>
        כניסה למערכת
      </button>
    </form>
    
    <div class="login-error" id="loginError">
      <i class="fas fa-exclamation-circle"></i>
      <span>מספר עובד או קוד שגויים</span>
    </div>
  </div>
</div>

<!-- =============== Main App =============== -->
<div id="mainApp" class="hidden">
  
  <!-- Mobile Header with Greeting -->
  <div class="mobile-greeting" id="mobileGreeting">
    <img src="./logo.png" alt="לוגו" class="mobile-logo">
    <span id="mobileUserGreeting">שלום</span>
  </div>
  
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" data-roles="instructor,manager,operations_controller,system_admin">
    <i class="fas fa-bars" id="mobileMenuIcon"></i>
  </button>
  
  <!-- Mobile Overlay -->
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="./logo.png" alt="תעשיידע" style="max-width: 50px; margin-bottom: 8px;">
      <h2 style="font-size: 18px; font-weight: 700; color: #1e293b; margin: 0;">תעשיידע</h2>
      <span style="font-size: 12px; color: #64748b;">מערכת נוכחות</span>
    </div>
    
    <div class="sidebar-user">
      <div class="user-avatar" id="userAvatar">ע</div>
      <div class="user-info">
        <h3 id="userName">עידן נחום</h3>
        <p id="userRole">מנהל מערכת</p>
      </div>
    </div>
    
    <nav class="sidebar-nav" id="sidebarNav">
      <a href="#" class="nav-item active" onclick="showPage(event, 'dashboard')" data-roles="all">
        <i class="fas fa-chart-line"></i>
        <span>לוח בקרה</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'add-record')" data-roles="instructor">
        <i class="fas fa-plus-circle"></i>
        <span>הוספת רשומה</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'records')" data-roles="instructor">
        <i class="fas fa-table"></i>
        <span>רשומות נוכחות</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'team-records')" data-roles="manager">
        <i class="fas fa-users"></i>
        <span>רשומות הצוות</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'reports')" data-roles="manager,operations_controller,system_admin">
        <i class="fas fa-file-alt"></i>
        <span>דוחות</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'admin')" data-roles="system_admin">
        <i class="fas fa-cog"></i>
        <span>הגדרות מערכת</span>
      </a>
    </nav>
    
    <div class="sidebar-footer">
      <button class="btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        יציאה מהמערכת
      </button>
    </div>
  </div>
  
  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-bottom-nav" id="mobileBottomNav">
    <div class="mobile-bottom-nav-inner">
      <button class="mobile-nav-item active" onclick="mobileNavTo('dashboard')" id="mobileNavDashboard" data-roles="all">
        <i class="fas fa-home"></i>
        <span>ראשי</span>
      </button>
      <button class="mobile-nav-item" onclick="mobileNavTo('add-record')" id="mobileNavAdd" data-roles="instructor">
        <i class="fas fa-plus-circle"></i>
        <span>הוספה</span>
      </button>
      <button class="mobile-nav-item" onclick="mobileNavTo('records')" id="mobileNavRecords" data-roles="instructor">
        <i class="fas fa-list"></i>
        <span>רשומות</span>
      </button>
      <button class="mobile-nav-item" onclick="mobileNavTo('team-records')" id="mobileNavTeamRecords" data-roles="manager,operations_controller,system_admin,payroll_officer">
        <i class="fas fa-users"></i>
        <span>צוות</span>
      </button>
      <button class="mobile-nav-item" onclick="toggleMobileMenu()" id="mobileNavMenu" data-roles="all">
        <i class="fas fa-bars"></i>
        <span>עוד</span>
      </button>
      <button class="mobile-nav-item" onclick="logout()" style="color: #dc2626;" data-roles="all">
        <i class="fas fa-sign-out-alt"></i>
        <span>יציאה</span>
      </button>
    </div>
  </nav>
  
  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Alert -->
    <div class="alert" id="alertBox">
      <i class="fas fa-check-circle"></i>
      <span id="alertText"></span>
    </div>
    
    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page">
      <div class="page-header">
        <h1>לוח בקרה</h1>
        <p id="dashboardMonthLabel">סקירה כללית</p>
      </div>
      
      <!-- Payroll Officer Dashboard -->
      <div id="payrollDashboard" style="display: none;">
        <div class="content-card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="card-title"><i class="fas fa-users" style="margin-left: 8px; color: #3b82f6;"></i>סיכום לפי מדריך - חודש נוכחי</h2>
            <button class="btn" onclick="exportPayrollToExcel()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 20px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-file-excel"></i>
              ייצוא ל-Excel
            </button>
          </div>
          <div class="card-body" style="overflow-x: auto;">
            <table id="payrollSummaryTable" class="admin-table" style="width: 100%;">
              <thead>
                <tr>
                  <th style="text-align: right; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">שם המדריך</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">צוות</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">ימי עבודה</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ שעות קורס</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ שעות הכשרה</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ שעות ביטול</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">קילומטר-סה"כ</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ הוצאות</th>
                </tr>
              </thead>
              <tbody id="payrollSummaryTableBody">
                <!-- יתמלא ע"י JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Admin/Controller Dashboard (All Employees Summary) -->
      <div id="adminControllerDashboard" style="display: none;">
        <div class="content-card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <h2 class="card-title"><i class="fas fa-users-cog" style="margin-left: 8px; color: #3b82f6;"></i>סיכום כל העובדים - חודש נוכחי</h2>
            <button class="btn" onclick="exportAdminDashboardToExcel()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 20px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-file-excel"></i>
              ייצוא ל-Excel
            </button>
          </div>
          
          <!-- Filters (Admin and Payroll only) -->
          <div id="adminDashboardFilters" class="card-body" style="background: #f8fafc; padding: 15px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <label style="font-weight: 500; color: #475569; font-size: 14px;">סינון:</label>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <select id="filterEmploymentType" onchange="updateAdminDashboard()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
                <option value="all">כל סוגי ההעסקה</option>
                <option value="תעשיידע">תעשיידע</option>
                <option value="מעוף">מעוף</option>
                <option value="מנפאואר">מנפאואר</option>
                <option value="עצמאי">עצמאי</option>
              </select>
              <select id="filterTeam" onchange="updateAdminDashboard()" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px;">
                <option value="all">כל הצוותים</option>
                <option value="גיל">גיל</option>
                <option value="לינוי">לינוי</option>
              </select>
              <button onclick="clearAdminFilters()" style="padding: 8px 16px; background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer; font-size: 14px;">
                <i class="fas fa-redo"></i> אפס סינונים
              </button>
            </div>
          </div>

          <div class="card-body" style="overflow-x: auto;">
            <table id="adminDashboardTable" class="admin-table" style="width: 100%;">
              <thead>
                <tr>
                  <th style="width: 30px; text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;"></th>
                  <th style="text-align: right; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">מספר עובד</th>
                  <th style="text-align: right; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">שם עובד</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">צוות</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סוג העסקה</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">רשומות</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ שעות</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ ק"מ</th>
                  <th style="text-align: center; padding: 12px 8px; background: #f1f5f9; font-weight: 600;">סה"כ הוצאות</th>
                </tr>
              </thead>
              <tbody id="adminDashboardTableBody">
                <!-- יתמלא ע"י JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Regular Dashboard Content -->
      <div id="regularDashboardContent">
      <div class="stats-grid">
        <div class="stat-card blue" onclick="showPage(event, 'records')" style="cursor: pointer; transition: transform 0.2s;"
             onmouseover="this.style.transform='translateY(-5px)'"
             onmouseout="this.style.transform='translateY(0)'">
          <div class="stat-card-header">
            <span class="stat-card-title">ימי עבודה</span>
            <div class="stat-card-icon">
              <i class="fas fa-calendar-check"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalRecordsStat">0</div>
          <div class="stat-card-label">תאריכים שונים בחודש</div>
        </div>
        
        <div class="stat-card purple">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ שעות</span>
            <div class="stat-card-icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalHoursStat">0</div>
          <div class="stat-card-label">שעות עבודה</div>
        </div>
        
        <div class="stat-card green">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ הוצאות</span>
            <div class="stat-card-icon">
              <i class="fas fa-shekel-sign"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalExpensesStat">0 ₪</div>
          <div class="stat-card-label">הוצאות והחזרים</div>
        </div>
        
        <div class="stat-card orange" onclick="showPage(event, 'records')" style="cursor: pointer; transition: transform 0.2s;"
             onmouseover="this.style.transform='translateY(-5px)'"
             onmouseout="this.style.transform='translateY(0)'">
          <div class="stat-card-header">
            <span class="stat-card-title">קילומטרים</span>
            <div class="stat-card-icon">
              <i class="fas fa-road"></i>
            </div>
          </div>
          <div class="stat-card-value" id="pendingRecordsStat">0</div>
          <div class="stat-card-label">סה"כ נסיעות</div>
        </div>
      </div>
      
      <!-- כפתורי פעולות -->
      <div style="text-align: center; margin-top: 40px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <button id="dashboardAddRecordBtn" class="btn btn-primary" onclick="showPage(event, 'add-record')" style="font-size: 15px; width: 220px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);">
          <i class="fas fa-plus"></i>
          הוסף רשומה חדשה
        </button>
        <button class="btn" onclick="exportToExcel()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 15px; width: 220px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); border: 1px solid rgba(255, 255, 255, 0.1);">
          <i class="fas fa-file-excel"></i>
          ייצוא ל-Excel
        </button>
      </div>

      <!-- טבלת סיכום -->
      <div class="content-card" style="margin-top: 40px;">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-list-alt" style="margin-left: 8px; color: #3b82f6;"></i>סיכום פעילות</h2>
        </div>
        <div class="card-body">
          <table id="summaryTable">
            <thead>
              <tr>
                <th>סוג פעילות</th>
                <th>סה"כ שעות</th>
                <th>סה"כ קילומטר</th>
              </tr>
            </thead>
            <tbody id="summaryTableBody">
              <!-- יתמלא ע"י JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
      </div><!-- End regularDashboardContent -->
    </div>

    <!-- Add Record Page -->
    <div id="addRecordPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 20px;">
          <h1 style="margin: 0; font-size: 24px;">הוספת רשומה חדשה</h1>
          <div id="formUserInfoHeader" style="display: flex; gap: 15px; background: #f1f5f9; padding: 6px 16px; border-radius: 10px; font-size: 14px; font-weight: 600; color: #475569; border: 1px solid #e2e8f0;">
            <span>מספר עובד: <span id="displayEmpNum"></span></span>
            <span>שם עובד: <span id="displayEmpName"></span></span>
          </div>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-success" onclick="addRecord()" title="הוסף רשומה" style="width: 48px; height: 48px; min-width: 48px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 12px;">
            <i class="fas fa-check" style="font-size: 18px;"></i>
          </button>
          <button class="btn btn-primary" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה" style="width: 48px; height: 48px; min-width: 48px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 12px;">
            <i class="fas fa-arrow-right" style="font-size: 18px;"></i>
          </button>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
        
        <div class="content-card">
          <div class="card-header" style="padding: 12px 16px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
            <h3 class="card-title" style="font-size: 15px; color: #1e40af; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-clock"></i>
              זמנים
            </h3>
          </div>
          <div class="card-body" style="padding: 16px;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; align-items: end;">
              <!-- תאריך -->
              <div class="form-field" style="margin: 0;">
                <label for="recDate" style="display: block; margin-bottom: 6px;">תאריך <span style="color: #ef4444;">*</span></label>
                <input type="date" id="recDate" required style="width: 100%; max-width: 160px;">
              </div>
              <!-- סה"כ שעות -->
              <div class="form-field" style="margin: 0; text-align: center;">
                <label for="hoursField" style="display: block; margin-bottom: 6px;">סה"כ שעות</label>
                <div style="display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 2px solid #cbd5e1; border-radius: 12px; padding: 8px 20px; min-width: 80px;">
                  <span id="hoursDisplay" style="font-size: 22px; font-weight: 700; color: #1e40af;">0:00</span>
                </div>
                <input type="hidden" id="hoursField" step="0.01" min="0" max="24" readonly>
              </div>
              <!-- שעת התחלה -->
              <div class="form-field" style="margin: 0;">
                <label style="display: block; margin-bottom: 6px;">שעת התחלה <span style="color: #ef4444;">*</span></label>
                <div class="time-picker-row">
                  <select id="startHour" onchange="updateTimeField('start'); calculateHours()" required>
                    <option value="">שעה</option>
                  </select>
                  <span class="time-separator">:</span>
                  <select id="startMinute" onchange="updateTimeField('start'); calculateHours()" required>
                    <option value="">דקות</option>
                  </select>
                  <input type="hidden" id="startTime">
                </div>
              </div>
              <!-- שעת סיום -->
              <div class="form-field" style="margin: 0;">
                <label style="display: block; margin-bottom: 6px;">שעת סיום <span style="color: #ef4444;">*</span></label>
                <div class="time-picker-row">
                  <select id="endHour" onchange="updateTimeField('end'); calculateHours()" required>
                    <option value="">שעה</option>
                  </select>
                  <span class="time-separator">:</span>
                  <select id="endMinute" onchange="updateTimeField('end'); calculateHours()" required>
                    <option value="">דקות</option>
                  </select>
                  <input type="hidden" id="endTime">
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="content-card">
          <div class="card-header" style="padding: 12px 16px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
            <h3 class="card-title" style="font-size: 15px; color: #166534; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-briefcase"></i>
              פרטי פעילות
            </h3>
          </div>
          <div class="card-body" style="padding: 16px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div class="form-field">
                <label for="activityType">סוג פעילות <span style="color: #ef4444;">*</span></label>
                <select id="activityType" required style="max-width: 100%;">
                  <option value="">בחר</option>
                  <option value="ביטול זמן">ביטול זמן</option>
                  <option value="הכשרה">הכשרה</option>
                  <option value="סדנה">סדנה</option>
                  <option value="סיור">סיור</option>
                  <option value="קורס">קורס</option>
                  <option value="תפעול">תפעול</option>
                </select>
              </div>
              <div class="form-field">
                <label for="schoolField">בית ספר <span style="color: #ef4444;">*</span></label>
                <select id="schoolField" onchange="updateMunicipalityFromSchool()" required style="max-width: 100%;">
                  <option value="">בחר בית ספר</option>
                </select>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div class="form-field">
                <label for="municipality">רשות <span style="color: #ef4444;">*</span></label>
                <input type="text" id="municipality" readonly required style="background: #f1f5f9; max-width: 100%;">
              </div>
              <div class="form-field">
                <label for="programField">תוכנית <span style="color: #ef4444;">*</span></label>
                <select id="programField" required style="max-width: 100%;">
                  <option value="">בחר תוכנית</option>
                  <option value="השמיים אינם הגבול">השמיים אינם הגבול</option>
                  <option value="התנסות בתעשייה">התנסות בתעשייה</option>
                  <option value="ביומימיקרי">ביומימיקרי</option>
                  <option value="ביומימיקרי לחטיבות">ביומימיקרי לחטיבות</option>
                  <option value="בינה מלאכותית">בינה מלאכותית</option>
                  <option value="יישומי AI">יישומי AI</option>
                  <option value="מייקרים טכנו-כיף">מייקרים טכנו-כיף</option>
                  <option value="מנהיגות ירוקה">מנהיגות ירוקה</option>
                  <option value="מקורות">מקורות</option>
                  <option value="משחקי קופסה">משחקי קופסה</option>
                  <option value="פורצות דרך">פורצות דרך</option>
                  <option value="רוקחים עולם">רוקחים עולם</option>
                  <option value="טכנולוגיות החלל">טכנולוגיות החלל</option>
                  <option value="תמיר">תמיר</option>
                </select>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="form-field">
                <label for="sessionNum">מספר מפגש <span style="color: #ef4444;">*</span></label>
                <select id="sessionNum" required style="max-width: 120px;">
                  <option value="">בחר</option>
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                  <option value="13">13</option>
                  <option value="14">14</option>
                  <option value="15">15</option>
                  <option value="16">16</option>
                </select>
              </div>
              <div class="form-field">
                <label for="kmField">קילומטר</label>
                <input type="number" id="kmField" step="0.1" min="0" placeholder="הלוך חזור" style="max-width: 120px;">
              </div>
            </div>
          </div>
        </div>
        
        <div class="content-card">
          <div class="card-header" style="padding: 12px 16px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
            <h3 class="card-title" style="font-size: 15px; color: #92400e; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-receipt"></i>
              הוצאות
            </h3>
          </div>
          <div class="card-body" style="padding: 16px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
              <div class="form-field">
                <label for="totalExpenses">סה"כ הוצאות (₪)</label>
                <input type="number" id="totalExpenses" step="0.01" min="0" placeholder="0.00" style="max-width: 120px;">
              </div>
              <div class="form-field">
                <label for="expensesDetail">פירוט הוצאות</label>
                <input type="text" id="expensesDetail" placeholder="פרט את ההוצאות" style="max-width: 100%;">
              </div>
            </div>
            <div class="form-field">
              <label for="attachments">צרף מסמכים/תמונות</label>
              <div class="file-upload-container" onclick="document.getElementById('attachments').click()" id="fileDropZone" style="padding: 12px;">
                <i class="fas fa-cloud-upload-alt" style="font-size: 24px; color: #3b82f6; margin-bottom: 6px;"></i>
                <p style="margin: 0; color: #64748b; font-size: 13px;">לחץ או גרור קבצים לכאן</p>
                <small style="color: #94a3b8; font-size: 11px;">תמונות, PDF, Word - עד 5MB לקובץ</small>
              </div>
              <input type="file" id="attachments" multiple accept="image/*,.pdf,.doc,.docx,.xlsx" style="display: none;" onchange="handleFileSelect(event)">
              <div id="fileList" class="file-list"></div>
            </div>
          </div>
        </div>
        
        <div class="content-card">
          <div class="card-header" style="padding: 12px 16px; background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);">
            <h3 class="card-title" style="font-size: 15px; color: #6b21a8; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-sticky-note"></i>
              הערות
            </h3>
          </div>
          <div class="card-body" style="padding: 16px;">
            <div class="form-field">
              <label for="notesField">הערות נוספות</label>
              <textarea id="notesField" rows="4" style="height: 100px; max-width: 100%;"></textarea>
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- Mobile Floating Submit Button -->
      <div class="mobile-floating-submit">
        <button class="btn btn-success" onclick="addRecord()" style="width: 100%; height: 50px; font-size: 16px; font-weight: 600; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
          <i class="fas fa-check"></i>
          שלח רשומה
        </button>
      </div>
    </div>

    <!-- Records Page -->
    <div id="recordsPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>רשומות נוכחות</h1>
          <p>כל הרשומות במערכת</p>
        </div>
        <button class="btn btn-primary" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה" style="width: 48px; height: 48px; min-width: 48px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 12px;">
          <i class="fas fa-arrow-right" style="font-size: 18px;"></i>
        </button>
      </div>
      
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">סה"כ <span id="totalRecordsCount">0</span> רשומות</h2>
          <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="exportToExcel()" style="background: #10b981; color: white;">
              <i class="fas fa-file-excel"></i>
              ייצוא ל-Excel
            </button>
            <button class="btn btn-primary" onclick="syncFromSharePoint(JSON.parse(localStorage.getItem('currentUser') || '{}').empNum)">
              <i class="fas fa-sync"></i>
              רענן נתונים
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="recordsTable">
            <p style="text-align: center; color: #94a3b8; padding: 40px;">אין רשומות להצגה</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Records Page (for manager, operations_controller, system_admin, payroll_officer) -->
    <div id="teamRecordsPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>סיכום נוכחות</h1>
          <p id="teamRecordsSubtitle">סיכום לפי עובד - לחץ על שם לפירוט</p>
        </div>
        <button class="btn btn-primary" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה" style="width: 48px; height: 48px; min-width: 48px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 12px;">
          <i class="fas fa-arrow-right" style="font-size: 18px;"></i>
        </button>
      </div>

      <div class="content-card">
        <div class="card-header" style="flex-direction: column; gap: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 10px;">
            <h2 class="card-title">סיכום צוות <span id="teamName"></span></h2>
            <button class="btn" onclick="exportTeamToExcel()" style="background: #10b981; color: white;">
              <i class="fas fa-file-excel"></i>
              ייצוא ל-Excel
            </button>
          </div>
          <!-- Month/Year Filter -->
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; background: #f8fafc; padding: 12px; border-radius: 8px; width: 100%;">
            <label style="font-weight: 500; color: #475569;">תקופה:</label>
            <select id="teamMonthFilter" onchange="loadTeamRecords()" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">
              <option value="1">ינואר</option>
              <option value="2">פברואר</option>
              <option value="3">מרץ</option>
              <option value="4">אפריל</option>
              <option value="5">מאי</option>
              <option value="6">יוני</option>
              <option value="7">יולי</option>
              <option value="8">אוגוסט</option>
              <option value="9">ספטמבר</option>
              <option value="10">אוקטובר</option>
              <option value="11">נובמבר</option>
              <option value="12">דצמבר</option>
            </select>
            <select id="teamYearFilter" onchange="loadTeamRecords()" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
            <button class="btn" onclick="loadTeamRecords()" style="background: #3b82f6; color: white; padding: 8px 16px;">
              <i class="fas fa-sync-alt"></i>
              רענן
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="teamRecordsTable">
            <p style="text-align: center; color: #94a3b8; padding: 40px;">בחר חודש ושנה לצפייה בסיכום</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Page (for manager, operations_controller, system_admin) -->
    <div id="reportsPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div>
          <h1>דוחות</h1>
          <p>סיכומים וסטטיסטיקות</p>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="btn" onclick="openExportModal()" style="background: #10b981; color: white;">
            <i class="fas fa-file-excel"></i>
            ייצוא ל-Excel
          </button>
          <button class="btn btn-primary" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה" style="width: 48px; height: 48px; min-width: 48px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 12px;">
            <i class="fas fa-arrow-right" style="font-size: 18px;"></i>
          </button>
        </div>
      </div>
      
      <!-- Filters Section -->
      <div class="content-card" style="margin-bottom: 20px;">
        <div class="card-body" style="padding: 15px;">
          <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
            <div class="form-group" style="margin: 0; min-width: 120px;">
              <label style="font-size: 12px; margin-bottom: 4px;">חודש</label>
              <select id="reportMonth" class="form-input" onchange="loadReportData()" style="padding: 8px;">
                <option value="1">ינואר</option>
                <option value="2">פברואר</option>
                <option value="3">מרץ</option>
                <option value="4">אפריל</option>
                <option value="5">מאי</option>
                <option value="6">יוני</option>
                <option value="7">יולי</option>
                <option value="8">אוגוסט</option>
                <option value="9">ספטמבר</option>
                <option value="10">אוקטובר</option>
                <option value="11">נובמבר</option>
                <option value="12">דצמבר</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0; min-width: 100px;">
              <label style="font-size: 12px; margin-bottom: 4px;">שנה</label>
              <select id="reportYear" class="form-input" onchange="loadReportData()" style="padding: 8px;">
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0; min-width: 120px;">
              <label style="font-size: 12px; margin-bottom: 4px;">צוות</label>
              <select id="reportTeam" class="form-input" onchange="loadReportData()" style="padding: 8px;">
                <option value="all">הכל</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0; min-width: 140px;" id="employmentTypeFilterContainer">
              <label style="font-size: 12px; margin-bottom: 4px;">סוג העסקה</label>
              <select id="reportEmploymentType" class="form-input" onchange="loadReportData()" style="padding: 8px;">
                <option value="all">הכל</option>
                <option value="תעשיידע">תעשיידע</option>
                <option value="מעוף">מעוף</option>
                <option value="מנפאואר">מנפאואר</option>
                <option value="עצמאי">עצמאי</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0; min-width: 120px;">
              <label style="font-size: 12px; margin-bottom: 4px;">סוג פעילות</label>
              <select id="reportActivityType" class="form-input" onchange="loadReportData()" style="padding: 8px;">
                <option value="all">הכל</option>
                <option value="ביטול זמן">ביטול זמן</option>
                <option value="הכשרה">הכשרה</option>
                <option value="סדנה">סדנה</option>
                <option value="סיור">סיור</option>
                <option value="קורס">קורס</option>
                <option value="תפעול">תפעול</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="loadReportData()" style="height: 38px; margin-top: 18px;">
              <i class="fas fa-sync-alt"></i>
              רענן
            </button>
          </div>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card blue">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ רשומות הצוות</span>
            <div class="stat-card-icon"><i class="fas fa-clipboard-list"></i></div>
          </div>
          <div class="stat-card-value" id="teamTotalRecords">0</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ שעות הצוות</span>
            <div class="stat-card-icon"><i class="fas fa-clock"></i></div>
          </div>
          <div class="stat-card-value" id="teamTotalHours">0</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ ק"מ</span>
            <div class="stat-card-icon"><i class="fas fa-road"></i></div>
          </div>
          <div class="stat-card-value" id="teamTotalKm">0</div>
        </div>
        <div class="stat-card green">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ הוצאות הצוות</span>
            <div class="stat-card-icon"><i class="fas fa-shekel-sign"></i></div>
          </div>
          <div class="stat-card-value" id="teamTotalExpenses">0 ₪</div>
        </div>
      </div>
      
      <div class="content-card" style="margin-top: 20px;">
        <div class="card-header">
          <h2 class="card-title">סיכום לפי עובד</h2>
        </div>
        <div class="card-body">
          <div id="reportsByEmployee">
            <p style="text-align: center; color: #94a3b8; padding: 40px;">טוען נתונים...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Page (for system_admin only) -->
    <div id="adminPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>הגדרות מערכת</h1>
          <p>ניהול משתמשים והגדרות</p>
        </div>
        <button class="btn btn-primary" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה" style="width: 48px; height: 48px; min-width: 48px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 12px;">
          <i class="fas fa-arrow-right" style="font-size: 18px;"></i>
        </button>
      </div>
      
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">פעולות מנהל</h2>
        </div>
        <div class="card-body">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <button class="btn btn-primary" onclick="viewAllRecords()" style="padding: 20px;">
              <i class="fas fa-database"></i><br>
              צפייה בכל הרשומות
            </button>
            <button class="btn" onclick="exportAllToExcel()" style="background: #10b981; color: white; padding: 20px;">
              <i class="fas fa-file-excel"></i><br>
              ייצוא כל הנתונים
            </button>
            <button class="btn" onclick="syncFromSharePoint()" style="background: #3b82f6; color: white; padding: 20px;">
              <i class="fas fa-sync-alt"></i><br>
              סנכרון מ-SharePoint
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>עריכת רשומה</h3>
          <button class="close-btn" onclick="closeEditModal()">×</button>
        </div>
        
        <div class="form-grid">
          <div class="form-field">
            <label for="editDate" class="required-label">תאריך</label>
            <input type="date" id="editDate" required>
          </div>
          <div class="form-field">
            <label class="required-label">שעת התחלה</label>
            <div class="time-picker-row">
              <select id="editStartHour" onchange="updateTimeField('editStart'); calculateEditHours()" required>
                <option value="">שעה</option>
              </select>
              <span class="time-separator">:</span>
              <select id="editStartMinute" onchange="updateTimeField('editStart'); calculateEditHours()" required>
                <option value="">דקות</option>
              </select>
              <input type="hidden" id="editStartTime">
            </div>
          </div>
          <div class="form-field">
            <label class="required-label">שעת סיום</label>
            <div class="time-picker-row">
              <select id="editEndHour" onchange="updateTimeField('editEnd'); calculateEditHours()" required>
                <option value="">שעה</option>
              </select>
              <span class="time-separator">:</span>
              <select id="editEndMinute" onchange="updateTimeField('editEnd'); calculateEditHours()" required>
                <option value="">דקות</option>
              </select>
              <input type="hidden" id="editEndTime">
            </div>
          </div>
          <div class="form-field">
            <label for="editHours">סה"כ שעות</label>
            <input type="number" id="editHours" step="0.01" min="0" max="24" readonly style="background: #f1f5f9; cursor: not-allowed;">
          </div>
          <div class="form-field">
            <label for="editActivity" class="required-label">סוג פעילות</label>
            <select id="editActivity" required>
              <option value="">בחר</option>
              <option value="ביטול זמן">ביטול זמן</option>
              <option value="הכשרה">הכשרה</option>
              <option value="סדנה">סדנה</option>
              <option value="סיור">סיור</option>
              <option value="קורס">קורס</option>
              <option value="תפעול">תפעול</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editSchool" class="required-label">בית ספר</label>
            <select id="editSchool" onchange="updateEditMunicipality()" required>
              <option value="">בחר בית ספר</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editMunicipality" class="required-label">רשות</label>
            <input type="text" id="editMunicipality" readonly style="background: #f1f5f9;" required>
          </div>
          <div class="form-field">
            <label for="editProgram" class="required-label">תוכנית</label>
            <select id="editProgram" required>
              <option value="">בחר תוכנית</option>
              <option value="השמיים אינם הגבול">השמיים אינם הגבול</option>
              <option value="התנסות בתעשייה">התנסות בתעשייה</option>
              <option value="ביומימיקרי">ביומימיקרי</option>
              <option value="ביומימיקרי לחטיבות">ביומימיקרי לחטיבות</option>
              <option value="בינה מלאכותית">בינה מלאכותית</option>
              <option value="יישומי AI">יישומי AI</option>
              <option value="מייקרים טכנו-כיף">מייקרים טכנו-כיף</option>
              <option value="מנהיגות ירוקה">מנהיגות ירוקה</option>
              <option value="מקורות">מקורות</option>
              <option value="משחקי קופסה">משחקי קופסה</option>
              <option value="פורצות דרך">פורצות דרך</option>
              <option value="רוקחים עולם">רוקחים עולם</option>
              <option value="טכנולוגיות החלל">טכנולוגיות החלל</option>
              <option value="תמיר">תמיר</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editSession" class="required-label">מספר מפגש</label>
            <select id="editSession" required>
              <option value="">בחר</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editKm">קילומטר</label>
            <input type="number" id="editKm" step="0.1" min="0" placeholder="לדוגמה: 25.5">
          </div>
          <div class="form-field">
            <label for="editTotalExpenses">סה"כ הוצאות (₪)</label>
            <input type="number" id="editTotalExpenses" step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-field">
            <label for="editExpensesDetail">פירוט הוצאות</label>
            <textarea id="editExpensesDetail" rows="2" placeholder="פרט את ההוצאות"></textarea>
          </div>
          <div class="form-field">
            <label for="editNotes">הערות</label>
            <textarea id="editNotes" rows="3"></textarea>
          </div>
          <div class="form-field">
            <label for="editAttachments">קבצים מצורפים</label>
            <input type="file" id="editAttachments" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx">
            <small style="color: #64748b; font-size: 12px;">ניתן לצרף מספר קבצים (PDF, תמונות, מסמכים)</small>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn" onclick="closeEditModal()" style="background: #e2e8f0; color: #475569;">
            <i class="fas fa-times"></i>
            ביטול
          </button>
          <button class="btn btn-success" onclick="saveEdit()">
            <i class="fas fa-save"></i>
            שמירה
          </button>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h3>ייצוא לאקסל</h3>
          <button class="close-btn" onclick="closeExportModal()">×</button>
        </div>
        
        <div style="padding: 20px;">
          <p style="margin-bottom: 15px; color: #64748b;">בחר סוג ייצוא:</p>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn" onclick="exportReportToExcel('all')" style="background: #3b82f6; color: white; padding: 15px;">
              <i class="fas fa-list"></i>
              כל השורות (מפורט)
            </button>
            <button class="btn" onclick="exportReportToExcel('grouped')" style="background: #10b981; color: white; padding: 15px;">
              <i class="fas fa-chart-bar"></i>
              מקובץ לפי עובד (סיכום)
            </button>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn" onclick="closeExportModal()" style="background: #e2e8f0; color: #475569;">
            <i class="fas fa-times"></i>
            ביטול
          </button>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
      <div class="modal-content" style="max-width: 340px; margin: 16px; padding: 0; border-radius: 20px; overflow: hidden;">
        <div class="modal-header" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 20px; border-radius: 0;">
          <h3 style="color: #dc2626; margin: 0; font-size: 18px;">
            <i class="fas fa-sign-out-alt" style="margin-left: 8px;"></i>
            יציאה מהמערכת
          </h3>
          <button class="close-btn" onclick="closeLogoutModal()" style="background: rgba(220,38,38,0.1); color: #dc2626;">×</button>
        </div>
        
        <div style="padding: 28px 24px; text-align: center; background: white;">
          <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
            <i class="fas fa-question" style="font-size: 24px; color: #dc2626;"></i>
          </div>
          <p style="color: #475569; font-size: 16px; margin-bottom: 0; line-height: 1.6;">האם אתה בטוח שברצונך להתנתק?</p>
        </div>
        
        <div class="modal-footer" style="justify-content: center; gap: 12px; padding: 20px; background: #f8fafc; border-top: 1px solid #e2e8f0;">
          <button class="btn" onclick="closeLogoutModal()" style="background: white; color: #475569; min-width: 110px; border: 1px solid #e2e8f0; padding: 12px 20px; font-size: 15px;">
            <i class="fas fa-times"></i>
            ביטול
          </button>
          <button class="btn" onclick="confirmLogout()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; min-width: 110px; padding: 12px 20px; font-size: 15px; box-shadow: 0 4px 12px rgba(239,68,68,0.3);">
            <i class="fas fa-sign-out-alt"></i>
            אישור
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// =============== Configuration ===============

const LOGIC_APP_URL = "https://prod-23.israelcentral.logic.azure.com:443/workflows/39fabd0c7a1b418286fe5ec53a720f61/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=JSq3DkhLej1JC18oCJ3CtV7hjUdX_vu1E2j94LLsw_g";

// =============== Fixed Lists (Constant Values) ===============
const TEAMS_LIST = [
  'גיל',
  'לינוי',
  'הכל'
];

const EMPLOYMENT_TYPES = [
  'תעשיידע',
  'מעוף',
  'מנפאואר',
  'עצמאי'
];

const ACTIVITY_TYPES = [
  'ביטול זמן',
  'הכשרה',
  'סדנה',
  'סיור',
  'קורס',
  'תפעול'
];

const PROGRAMS_LIST = [
  'השמיים אינם הגבול',
  'התנסות בתעשייה',
  'ביומימיקרי',
  'ביומימיקרי לחטיבות',
  'בינה מלאכותית',
  'יישומי AI',
  'מייקרים טכנו-כיף',
  'מנהיגות ירוקה',
  'מקורות',
  'משחקי קופסה',
  'פורצות דרך',
  'רוקחים עולם',
  'טכנולוגיות החלל',
  'תמיר'
];

// =============== State ===============
let records = [];
let currentUser = '';
let editingIndex = -1;

// =============== Helper: Decimal Hours to HH:MM Format ===============
function formatHoursDisplay(decimalHours) {
  const num = parseFloat(decimalHours) || 0;
  const hours = Math.floor(num);
  const minutes = Math.round((num - hours) * 60);
  return `${hours}:${minutes.toString().padStart(2, '0')}`;
}

// =============== Helper: Extract SharePoint Lookup Value ===============
function extractLookupValue(field, defaultValue = '') {
  if (!field) return defaultValue;
  if (typeof field === 'string') {
    try {
      const parsed = JSON.parse(field);
      if (parsed && parsed.Value) return parsed.Value;
      return field;
    } catch (e) {
      return field;
    }
  }
  if (typeof field === 'object' && field.Value) {
    return field.Value;
  }
  return defaultValue;
}

// =============== Users ===============
// Authentication moved to server-side for security

// =============== Schools Data ===============
const schoolsData = [
  {"רשות":"בנימינה","בית ספר":"מתנ\"ס"},
  {"רשות":"ג'דיידה מכר","בית ספר":"ג'דיידה יסודי"},
  {"רשות":"הרצליה","בית ספר":"ויצו פנינים אילנות"},
  {"רשות":"חיפה","בית ספר":"לאובק"},
  {"רשות":"ירושלים","בית ספר":"ביכורים"},
  {"רשות":"כיסרא סמיה","בית ספר":"כיסרא סמיה"},
  {"רשות":"ירכא","בית ספר":"ירכא אל-רואי"},
  {"רשות":"ירכא","בית ספר":"ירכא אל-אמין"},
  {"רשות":"ג'וליס","בית ספר":"דרכא"},
  {"רשות":"עין קיניה","בית ספר":"עין קיניה"},
  {"רשות":"בוקעתא","בית ספר":"בוקעתא"},
  {"רשות":"מג'דל שמס","בית ספר":"מג'דל שמס"},
  {"רשות":"יהוד","בית ספר":"הרצל"},
  {"רשות":"יהוד","בית ספר":"יהודה הלוי"},
  {"רשות":"יהוד","בית ספר":"היובל"},
  {"רשות":"אשכול","בית ספר":"נופי הבשור"},
  {"רשות":"מנשה","בית ספר":"נטעים"},
  {"רשות":"מטה יהודה","בית ספר":"אלון"},
  {"רשות":"מטה יהודה","בית ספר":"מתיתיהו"},
  {"רשות":"מטה יהודה","בית ספר":"האלה"},
  {"רשות":"מטה יהודה","בית ספר":"הרטוב היסודי"},
  {"רשות":"מטה יהודה","בית ספר":"עין הרים"},
  {"רשות":"מטה יהודה","בית ספר":"השחר"},
  {"רשות":"מטה יהודה","בית ספר":"יסודי עין נקובא-ראפה"},
  {"רשות":"מטה יהודה","בית ספר":"קרוב"},
  {"רשות":"מטה יהודה","בית ספר":"נווה שלום"},
  {"רשות":"מטה יהודה","בית ספר":"קסם"},
  {"רשות":"מסעדה","בית ספר":"מסעדה יסודי"},
  {"רשות":"נהריה","בית ספר":"גולדה"},
  {"רשות":"נהריה","בית ספר":"ישיבת אבירי יעקב"},
  {"רשות":"נהריה","בית ספר":"מדעים"},
  {"רשות":"נהריה","בית ספר":"רמב\"ם"},
  {"רשות":"נתניה","בית ספר":"בר אילן"},
  {"רשות":"נתניה","בית ספר":"אלדד"},
  {"רשות":"נתניה","בית ספר":"ריגלר"},
  {"רשות":"נתניה","בית ספר":"אלתרמן"},
  {"רשות":"נתניה","בית ספר":"אורט גוטמן"},
  {"רשות":"נתניה","בית ספר":"שחפים חנ\"מ (אלומות לשעבר)"},
  {"רשות":"עין אלאסד","בית ספר":"עין אלאסד"},
  {"רשות":"עכו","בית ספר":"גורדון"},
  {"רשות":"עכו","בית ספר":"העליה השניה"},
  {"רשות":"עכו","בית ספר":"חילמי"},
  {"רשות":"עמק הירדן - אפיקים","בית ספר":"אפיקי ירדן"},
  {"רשות":"עמק הירדן - אשדות יעקב","בית ספר":"מול גלעד"},
  {"רשות":"עמק הירדן - גינוסר","בית ספר":"נופי ארבל"},
  {"רשות":"עמק הירדן - דגניה א'","בית ספר":"בית חינוך דגניה"},
  {"רשות":"עמק הירדן - כנרת","בית ספר":"כנרת"},
  {"רשות":"קריית טבעון","בית ספר":"כפר הנוער רמת הדסה"},
  {"רשות":"קריית שמונה","בית ספר":"מתנ\"ס קריית שמונה"},
  {"רשות":"קריית שמונה","בית ספר":"עוזיאל"},
  {"רשות":"ראשון לציון","בית ספר":"גימנסיה"},
  {"רשות":"ראשון לציון","בית ספר":"תיכון המעיין"},
  {"רשות":"רחובות","בית ספר":"בכור לוי"},
  {"רשות":"רחובות","בית ספר":"נבון רחובות"},
  {"רשות":"בוסתן הגליל","בית ספר":"מיטר"},
  {"רשות":"אופקים","בית ספר":"בן גוריון"},
  {"רשות":"אשדוד","בית ספר":"חווה חקלאית - אשכול"},
  {"רשות":"אשדוד","בית ספר":"חווה חקלאית - יחד"},
  {"רשות":"אשדוד","בית ספר":"מקיף ה'"},
  {"רשות":"אשדוד","בית ספר":"מקיף ט'"},
  {"רשות":"אשכול","בית ספר":"מרחבי אשכול"},
  {"רשות":"אשכול","בית ספר":"שדות אשכול"},
  {"רשות":"אשכול","בית ספר":"שמש גבולות"},
  {"רשות":"אשקלון","בית ספר":"אילנות"},
  {"רשות":"אשקלון","בית ספר":"בראשית"},
  {"רשות":"אשקלון","בית ספר":"דרכא מקיף ה'"},
  {"רשות":"אשקלון","בית ספר":"נוף ים ב'"},
  {"רשות":"באר יעקב","בית ספר":"צאלון"},
  {"רשות":"באר שבע","בית ספר":"התומר"},
  {"רשות":"באר שבע","בית ספר":"חווה חקלאית - התומר"},
  {"רשות":"באר שבע","בית ספר":"שובו"},
  {"רשות":"באר שבע","בית ספר":"חווה חקלאית - רננות"},
  {"רשות":"באר שבע","בית ספר":"מקיף ג'"},
  {"רשות":"גדרה","בית ספר":"דרכא רמון"},
  {"רשות":"דימונה","בית ספר":"נווה עמרם"},
  {"רשות":"יבנה","בית ספר":"ביאליק"},
  {"רשות":"יבנה","בית ספר":"נבון יבנה"},
  {"רשות":"יבנה","בית ספר":"פרדס צפוני"},
  {"רשות":"יד בנימין","בית ספר":"יד בנימין"},
  {"רשות":"לכיש","בית ספר":"רבקה גובר"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"באר גנים"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"חופים"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"מורשה"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"ניצן"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"ניצני קליף"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"שדות סילבר"},
  {"רשות":"מודיעין","בית ספר":"תיכון ב'"},
  {"רשות":"נס ציונה","בית ספר":"בן גוריון"},
  {"רשות":"קריית גת","בית ספר":"אורט גרוס"},
  {"רשות":"קריית גת","בית ספר":"אורט מאיר"},
  {"רשות":"קריית גת","בית ספר":"בן צבי"},
  {"רשות":"קריית גת","בית ספר":"דוד אלעזר"},
  {"רשות":"קריית גת","בית ספר":"משואה"},
  {"רשות":"קריית מלאכי","בית ספר":"דרור"},
  {"רשות":"קריית מלאכי","בית ספר":"עמל גבעתי"},
  {"רשות":"רמלה","בית ספר":"חטיבת עידנים"},
  {"רשות":"רמלה","בית ספר":"מקיף יגאל אלון"},
  {"רשות":"רמלה","בית ספר":"תיכון פרופ נגר"},
  {"רשות":"שדרות","בית ספר":"חניתה ב'"},
  {"רשות":"אבן שמואל","בית ספר":"שפיר"},
  {"רשות":"שפיר","בית ספר":"תתמ\"ד"},
  {"רשות":"שער הנגב","בית ספר":"שדות רוחמה"}
];

// Sort and add Zoom at beginning
schoolsData.sort((a, b) => a['בית ספר'].localeCompare(b['בית ספר'], 'he'));
schoolsData.unshift({"רשות":"זום","בית ספר":"זום"});

// =============== Role Management ===============
function normalizeRole(role) {
  if (!role) return 'instructor';
  
  // Handle SharePoint object format: {"Value": "System Admin", ...}
  let roleValue = role;
  if (typeof role === 'object' && role.Value) {
    roleValue = role.Value;
  } else if (typeof role === 'string' && role.includes('"Value"')) {
    try {
      const parsed = JSON.parse(role);
      roleValue = parsed.Value || role;
    } catch(e) {
      roleValue = role;
    }
  }
  
  const roleMap = {
    // System Admin variations
    'System Admin': 'system_admin',
    'system admin': 'system_admin',
    'system_admin': 'system_admin',
    'Admin': 'system_admin',
    'admin': 'system_admin',
    'Administrator': 'system_admin',
    'administrator': 'system_admin',
    'Admin Assistant': 'system_admin',
    'admin assistant': 'system_admin',
    'עוזרת אדמין': 'system_admin',
    'עוזר אדמין': 'system_admin',
    'מנהל מערכת': 'system_admin',
    'אדמין': 'system_admin',
    // Manager variations
    'Manager': 'manager',
    'manager': 'manager',
    'מנהל': 'manager',
    'מנהלת': 'manager',
    'מנהל פעילות': 'manager',
    'מנהלת פעילות': 'manager',
    'מנהל/ת פעילות': 'manager',
    'מנהל פעילויות': 'manager',
    'מנהלת פעילויות': 'manager',
    'מנהל/ת פעילויות': 'manager',
    'מנהל צוות': 'manager',
    'מנהלת צוות': 'manager',
    'מנהל/ת צוות': 'manager',
    // Payroll Officer variations
    'Payroll Officer': 'payroll_officer',
    'payroll officer': 'payroll_officer',
    'payroll_officer': 'payroll_officer',
    'Payroll': 'payroll_officer',
    'payroll': 'payroll_officer',
    'אחראית שכר': 'payroll_officer',
    'אחראי שכר': 'payroll_officer',
    // Operations Controller variations
    'Operations Controller': 'operations_controller',
    'operations controller': 'operations_controller',
    'operations_controller': 'operations_controller',
    'Controller': 'operations_controller',
    'controller': 'operations_controller',
    'מבקרת תפעול': 'operations_controller',
    'מבקר תפעול': 'operations_controller',
    // Instructor variations
    'Instructor': 'instructor',
    'instructor': 'instructor',
    'מדריך': 'instructor',
    'מדריכה': 'instructor',
    'מדריך/ה': 'instructor'
  };
  
  const normalizedValue = typeof roleValue === 'string' ? roleValue.trim() : String(roleValue);
  return roleMap[normalizedValue] || 'instructor';
}

function getRoleDisplayName(role) {
  const normalizedRole = normalizeRole(role);
  const roleNames = {
    'system_admin': 'מנהל מערכת',
    'manager': 'מנהל/ת פעילויות',
    'payroll_officer': 'אחראית שכר',
    'operations_controller': 'מבקרת תפעול',
    'instructor': 'מדריך/ה'
  };
  return roleNames[normalizedRole] || 'משתמש';
}

function getCurrentUserData() {
  try {
    const saved = localStorage.getItem('currentUser');
    return saved ? JSON.parse(saved) : null;
  } catch(e) {
    return null;
  }
}

function updateMenuByRole(role) {
  // Handle sidebar nav items via data-roles
  const navItems = document.querySelectorAll('#sidebarNav .nav-item');
  navItems.forEach(item => {
    const allowedRoles = item.getAttribute('data-roles');
    if (allowedRoles === 'all') {
      item.style.display = 'flex';
    } else {
      const roles = allowedRoles.split(',');
      item.style.display = roles.includes(role) ? 'flex' : 'none';
    }
  });

  // Handle mobile bottom nav items via data-roles
  const mobileNavItems = document.querySelectorAll('#mobileBottomNav .mobile-nav-item');
  mobileNavItems.forEach(item => {
    const allowedRoles = item.getAttribute('data-roles');
    if (!allowedRoles || allowedRoles === 'all') {
      item.style.display = 'flex';
    } else {
      const roles = allowedRoles.split(',');
      item.style.display = roles.includes(role) ? 'flex' : 'none';
    }
  });

  // Handle mobile menu toggle via data-roles
  const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
  if (mobileMenuToggle) {
    const allowedRoles = mobileMenuToggle.getAttribute('data-roles');
    if (!allowedRoles || allowedRoles === 'all') {
      mobileMenuToggle.style.display = 'flex';
    } else {
      const roles = allowedRoles.split(',');
      mobileMenuToggle.style.display = roles.includes(role) ? 'flex' : 'none';
    }
  }

  // Hide dashboard "add record" button for non-instructors
  const dashboardAddBtn = document.getElementById('dashboardAddRecordBtn');
  if (dashboardAddBtn) {
    dashboardAddBtn.style.display = (role === 'instructor') ? 'flex' : 'none';
  }

  // Show appropriate dashboard based on role
  const payrollDashboard = document.getElementById('payrollDashboard');
  const adminControllerDashboard = document.getElementById('adminControllerDashboard');
  const regularDashboardContent = document.getElementById('regularDashboardContent');
  
  // Hide all dashboards first
  if (payrollDashboard) payrollDashboard.style.display = 'none';
  if (adminControllerDashboard) adminControllerDashboard.style.display = 'none';
  if (regularDashboardContent) regularDashboardContent.style.display = 'none';
  
  // Show the appropriate dashboard
  if (role === 'payroll_officer') {
    if (payrollDashboard) payrollDashboard.style.display = 'block';
  } else if (role === 'system_admin' || role === 'operations_controller') {
    if (adminControllerDashboard) adminControllerDashboard.style.display = 'block';
    // Show filters only for admin and payroll (payroll already handled above)
    const filters = document.getElementById('adminDashboardFilters');
    if (filters && role === 'system_admin') {
      filters.style.display = 'flex';
    } else if (filters) {
      filters.style.display = 'none';
    }
  } else {
    if (regularDashboardContent) regularDashboardContent.style.display = 'block';
  }
}

function hasPermission(action, targetTeam = null) {
  const user = getCurrentUserData();
  if (!user) return false;
  
  const role = user.role;
  
  switch(action) {
    case 'view_own':
      return true;
    case 'view_team':
      return ['manager', 'operations_controller', 'system_admin'].includes(role);
    case 'view_all':
      return ['operations_controller', 'system_admin', 'payroll_officer'].includes(role);
    case 'edit_own':
      return role === 'instructor';
    case 'edit_team':
      if (role === 'manager') {
        return user.team === targetTeam;
      }
      return ['operations_controller', 'system_admin'].includes(role);
    case 'edit_all':
      return ['operations_controller', 'system_admin'].includes(role);
    case 'delete':
      return ['operations_controller', 'system_admin'].includes(role);
    case 'admin':
      return role === 'system_admin';
    default:
      return false;
  }
}

function canEditRecord(record) {
  const user = getCurrentUserData();
  if (!user) return false;

  const role = user.role;

  // system_admin and operations_controller can edit all records
  if (role === 'system_admin' || role === 'operations_controller') {
    return true;
  }

  // manager can edit team records
  if (role === 'manager') {
    return true;
  }

  // instructor can edit only their own records until end of record's month
  if (role === 'instructor') {
    const recordEmpNum = record.empNum || record.employeeId;
    const userEmpNum = user.empNum || localStorage.getItem('employeeId');

    // Must be own record
    if (String(recordEmpNum) !== String(userEmpNum)) {
      return false;
    }

    // Check if still within the record's month
    const recordDateStr = record.date || record.attendanceDate;
    if (!recordDateStr) return false;

    const recordDate = new Date(recordDateStr);
    const now = new Date();

    // Get the last day of the record's month (day 0 of next month = last day of this month)
    const recordYear = recordDate.getFullYear();
    const recordMonth = recordDate.getMonth();
    const lastDayOfRecordMonth = new Date(recordYear, recordMonth + 1, 0);
    lastDayOfRecordMonth.setHours(23, 59, 59, 999);

    return now <= lastDayOfRecordMonth;
  }

  // payroll_officer and others = view only, no edit
  return false;
}

function canDeleteRecord(record) {
  const user = getCurrentUserData();
  if (!user) return false;
  
  const role = user.role;
  
  // payroll_officer = view only, no delete
  return role === 'system_admin' || role === 'operations_controller';
}

function canAddRecord() {
  const user = getCurrentUserData();
  if (!user) return false;
  return user.role === 'instructor';
}

// =============== Sync from SharePoint ===============
function generateRecordKey(rec) {
  return `${rec.empNum || rec.employeeId}_${rec.date || rec.attendanceDate}_${rec.start || rec.startTime}_${rec.activity || rec.activityType}`;
}

function generateRecordId() {
  return 'rec_' + Date.now() + '_' + Math.random().toString(16).slice(2);
}

async function syncFromSharePoint(employeeId) {
  await loadMyRecordsFromServer();
}

async function loadMyRecordsFromServer() {
  const employeeId = localStorage.getItem("employeeId");
  if (!employeeId) {
    records = [];
    renderRecordsTable();
    updateStats();
    return;
  }

  try {
    showAlert('🔄 טוען רשומות מהשרת...', 'info');
    
    const role = localStorage.getItem("role") || '';
    const team = localStorage.getItem("team") || '';
    
    const res = await fetch(LOGIC_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "getHistory",
        employeeId: employeeId,
        role: role,
        team: team
      })
    });

    const data = await res.json();

    if (!data.success || !Array.isArray(data.records)) {
      console.warn("No records or failed:", data);
      records = [];
      renderRecordsTable();
      updateStats();
      showAlert('✅ אין רשומות קיימות', 'info');
      return;
    }

    // Helper to extract value from SharePoint lookup fields
    const extractValue = (field) => {
      if (!field) return '';
      if (typeof field === 'string') return field;
      if (typeof field === 'object' && field.Value) return field.Value;
      return '';
    };
    
    // Map server records to local format
    records = data.records.map(rec => ({
      recordId: rec.ID || rec.Id || rec.id || rec.recordId || null,
      id: rec.ID || rec.Id || rec.id || `${rec.employeeId}_${rec.attendanceDate}_${rec.startTime}`,
      empNum: rec.employeeId?.toString() || employeeId,
      empName: extractValue(rec.employeeName) || extractValue(rec.EmployeeName) || '',
      team: extractValue(rec.team) || extractValue(rec.Team) || '',
      date: rec.attendanceDate || '',
      start: rec.startTime || '',
      end: rec.endTime || '',
      hours: rec.workHours || 0,
      activity: extractValue(rec.activityType) || extractValue(rec.ActivityType) || '',
      school: extractValue(rec.schoolName) || extractValue(rec.SchoolName) || '',
      municipality: extractValue(rec.municipality) || extractValue(rec.Municipality) || '',
      program: extractValue(rec.programName) || extractValue(rec.ProgramName) || '',
      session: rec.sessionNumber || '',
      km: rec.kilometers || 0,
      totalExpenses: rec.totalExpenses || 0,
      expensesDetail: rec.expensesDetails || '',
      notes: rec.notes || '',
      employmentType: extractValue(rec.employmentType) || extractValue(rec.EmploymentType) || 'תעשיידע',
      attachments: []
    }));

    renderRecordsTable();
    updateStats();
    showAlert(`✅ נטענו ${records.length} רשומות`, 'success');
  } catch (error) {
    console.error('Load records error:', error);
    // Don't reset records on error - keep existing data
    showAlert('⚠️ שגיאה בטעינת רשומות', 'error');
  }
}

async function updateRecordOnServer(updatedRecord, originalDate, originalStartTime) {
  if (!updatedRecord.recordId) {
    console.error('Cannot update record: missing recordId');
    return false;
  }
  
  const payload = {
    action: "updateRecord",
    recordId: Number(updatedRecord.recordId),
    employeeId: String(updatedRecord.empNum),
    employeeName: String(updatedRecord.empName || localStorage.getItem("employeeName") || ''),
    attendanceDate: String(updatedRecord.date),
    startTime: String(updatedRecord.start),
    endTime: String(updatedRecord.end),
    workHours: Number(updatedRecord.hours) || 0,
    activityType: String(updatedRecord.activity),
    schoolName: String(updatedRecord.school),
    municipality: String(updatedRecord.municipality),
    programName: String(updatedRecord.program),
    sessionNumber: Number(updatedRecord.session) || 0,
    kilometers: Number(updatedRecord.km) || 0,
    totalExpenses: Number(updatedRecord.totalExpenses) || 0,
    expensesDetails: String(updatedRecord.expensesDetail || ''),
    notes: String(updatedRecord.notes || ''),
    employmentType: String(updatedRecord.employmentType || localStorage.getItem("employmentType") || 'תעשיידע'),
    team: String(updatedRecord.team || localStorage.getItem("team") || '')
  };

  const res = await fetch(LOGIC_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  return res.ok;
}

async function deleteRecordOnServer(record) {
  if (!record.recordId) {
    console.error('Cannot delete record: missing recordId');
    return false;
  }
  
  const res = await fetch(LOGIC_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "deleteRecord",
      recordId: Number(record.recordId)
    })
  });

  return res.ok;
}

// =============== Login ===============
async function doLogin(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  
  const employeeId = document.getElementById('loginEmpNum').value.trim();
  const personalCode = document.getElementById('empCode').value.trim();
  const loginBtn = document.querySelector('#loginForm button[type="submit"]');
  const errorEl = document.getElementById('loginError');
  
  errorEl.classList.remove('show');
  
  if (!employeeId || !personalCode) {
    errorEl.textContent = 'נא להזין מספר עובד וקוד אישי';
    errorEl.classList.add('show');
    return false;
  }
  
  if (loginBtn) {
    loginBtn.disabled = true;
    loginBtn.textContent = 'מתחבר...';
  }
  
  try {
    const response = await fetch(LOGIC_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        action: "auth",
        employeeId: employeeId, 
        personalCode: personalCode 
      })
    });
    
    const data = await response.json();
    console.log('Login response:', JSON.stringify(data));
    console.log('Role from server:', data.role, '| Role field:', data.Role);
    
    if (data.success) {
      currentUser = data.employeeName;
      
      // Extract role - handle SharePoint lookup format {Value: "..."}
      let rawRole = data.role || data.Role || 'instructor';
      if (typeof rawRole === 'object' && rawRole !== null && rawRole.Value) {
        rawRole = rawRole.Value;
      }
      
      console.log('Server role:', data.role);
      console.log('Extracted role:', rawRole);
      
      const empData = {
        empNum: employeeId,
        empName: data.employeeName,
        role: normalizeRole(rawRole),
        team: extractLookupValue(data.team || data.Team, ''),
        employmentType: extractLookupValue(data.employmentType || data.EmploymentType, 'תעשיידע')
      };
      console.log('Normalized role:', empData.role);
      localStorage.setItem('currentUser', JSON.stringify(empData));
      localStorage.setItem('employeeName', data.employeeName);
      localStorage.setItem('employeeId', employeeId);
      localStorage.setItem('role', empData.role);
      localStorage.setItem('employmentType', extractLookupValue(data.employmentType, 'תעשיידע'));
      localStorage.setItem('team', extractLookupValue(data.team || data.Team, ''));
      
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      
      document.getElementById('userName').textContent = empData.empName;
      document.getElementById('userRole').textContent = getRoleDisplayName(empData.role);
      document.getElementById('userAvatar').textContent = empData.empName ? empData.empName.charAt(0) : 'ע';
      document.getElementById('mobileUserGreeting').textContent = 'שלום, ' + empData.empName;
      
      updateMenuByRole(empData.role);
      loadFromLocalStorage();
      
      await syncFromSharePoint(empData.empNum);
      
      updateStats();
      initInactivityTimer();
      showPage(null, 'dashboard');
    } else {
      errorEl.textContent = data.message || 'מספר עובד או קוד אישי שגויים';
      errorEl.classList.add('show');
    }
  } catch (error) {
    errorEl.textContent = 'שגיאת תקשורת - נסה שוב';
    errorEl.classList.add('show');
  } finally {
    if (loginBtn) {
      loginBtn.disabled = false;
      loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> כניסה למערכת';
    }
  }
  
  return false;
}

function logout() {
  document.getElementById('logoutModal').style.display = 'flex';
}

function closeLogoutModal() {
  document.getElementById('logoutModal').style.display = 'none';
}

function confirmLogout() {
  closeLogoutModal();
  localStorage.removeItem('currentUser');
  localStorage.removeItem('employeeId');
  localStorage.removeItem('employeeName');
  currentUser = '';
  location.reload();
}

// =============== Inactivity Timeout (30 minutes) ===============
let inactivityTimer;
const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    showAlert('⏰ המערכת ננעלה עקב חוסר פעילות', 'info');
    setTimeout(() => {
      localStorage.removeItem('currentUser');
      currentUser = '';
      location.reload();
    }, 2000);
  }, INACTIVITY_TIMEOUT);
}

function initInactivityTimer() {
  // Reset timer on any user activity
  ['click', 'touchstart', 'keypress', 'scroll', 'mousemove'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer, { passive: true });
  });
  resetInactivityTimer();
}

// Start inactivity timer when user is logged in and auto-load records
document.addEventListener('DOMContentLoaded', async () => {
  const savedUser = localStorage.getItem('currentUser');
  const employeeId = localStorage.getItem('employeeId');
  
  if (savedUser && employeeId) {
    initInactivityTimer();
    // Auto-load records from server on page load
    await loadMyRecordsFromServer();
  }
});

// =============== Mobile Menu ===============
function toggleMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('mobileOverlay');
  const icon = document.getElementById('mobileMenuIcon');
  
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
  
  if (sidebar.classList.contains('open')) {
    icon.className = 'fas fa-times';
  } else {
    icon.className = 'fas fa-bars';
  }
}

function closeMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('mobileOverlay');
  const icon = document.getElementById('mobileMenuIcon');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
  icon.className = 'fas fa-bars';
}

function mobileNavTo(pageName) {
  showPage(null, pageName);
  updateMobileNavActive(pageName);
}

function updateMobileNavActive(pageName) {
  document.querySelectorAll('.mobile-nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  if (pageName === 'dashboard') {
    document.getElementById('mobileNavDashboard')?.classList.add('active');
  } else if (pageName === 'add-record') {
    document.getElementById('mobileNavAdd')?.classList.add('active');
  } else if (pageName === 'records') {
    document.getElementById('mobileNavRecords')?.classList.add('active');
  } else if (pageName === 'team-records') {
    document.getElementById('mobileNavTeamRecords')?.classList.add('active');
  }
}

// =============== Page Navigation ===============
function showPage(event, pageName) {
  if (event) {
    event.preventDefault();
  }
  
  // Role guard: non-instructors cannot access 'records' page, redirect to 'team-records'
  const role = localStorage.getItem("role") || '';
  if (pageName === 'records' && role !== 'instructor') {
    pageName = 'team-records';
  }
  
  // Role guard: payroll_officer can only access dashboard and team-records
  if (role === 'payroll_officer' && pageName !== 'dashboard' && pageName !== 'team-records') {
    pageName = 'team-records';
  }
  
  // Close mobile menu when navigating
  closeMobileMenu();
  
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  
  const pageMap = {
    'dashboard': 'dashboardPage',
    'add-record': 'addRecordPage',
    'records': 'recordsPage',
    'team-records': 'teamRecordsPage',
    'reports': 'reportsPage',
    'admin': 'adminPage'
  };
  
  const pageId = pageMap[pageName];
  if (pageId) {
    document.getElementById(pageId).classList.remove('hidden');
  }
  
  if (event && event.target.closest('.nav-item')) {
    event.target.closest('.nav-item').classList.add('active');
  }
  
  // Update mobile bottom nav
  updateMobileNavActive(pageName);
  
  if (pageName === 'dashboard') {
    updateDashboard();
    renderSummaryTable();
  }
  if (pageName === 'records') renderRecordsTable();
  if (pageName === 'team-records') loadTeamRecords();
  if (pageName === 'reports') initReportsPage();
  if (pageName === 'add-record') {
    // Populate employee info in header
    const user = getCurrentUserData();
    if (user) {
      document.getElementById('displayEmpNum').textContent = user.empNum || '';
      document.getElementById('displayEmpName').textContent = user.empName || '';
    }
  }
}

// =============== Team Records Functions ===============
let teamRecordsCache = [];
let expandedEmployees = {};

async function loadTeamRecords() {
  const user = getCurrentUserData();
  if (!user) return;

  // Set default month/year to current
  const now = new Date();
  const monthSelect = document.getElementById('teamMonthFilter');
  const yearSelect = document.getElementById('teamYearFilter');

  if (monthSelect && !monthSelect.dataset.initialized) {
    monthSelect.value = now.getMonth() + 1;
    monthSelect.dataset.initialized = 'true';
  }
  if (yearSelect && !yearSelect.dataset.initialized) {
    yearSelect.value = now.getFullYear();
    yearSelect.dataset.initialized = 'true';
  }

  const selectedMonth = monthSelect ? parseInt(monthSelect.value) : now.getMonth() + 1;
  const selectedYear = yearSelect ? parseInt(yearSelect.value) : now.getFullYear();

  const teamName = document.getElementById('teamName');
  if (user.role === 'system_admin' || user.role === 'operations_controller' || user.role === 'payroll_officer') {
    teamName.textContent = '(כל הצוותים)';
  } else if (user.role === 'manager') {
    teamName.textContent = user.team || '';
  }

  // Show loading
  document.getElementById('teamRecordsTable').innerHTML = `
    <p style="text-align: center; color: #64748b; padding: 40px;">
      <i class="fas fa-spinner fa-spin"></i> טוען נתונים לחודש ${selectedMonth}/${selectedYear}...
    </p>
  `;

  try {
    // Get team records from server - filtered by month/year
    const response = await fetch(LOGIC_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getHistory',
        employeeId: user.empNum,
        role: user.role,
        team: user.team,
        month: selectedMonth,
        year: selectedYear
      })
    });

    const data = await response.json();

    if (data.success && Array.isArray(data.records)) {
      teamRecordsCache = data.records;
      renderTeamSummary(data.records);
    } else {
      const debugInfo = user.role === 'manager' 
        ? `<br><small style="font-size: 12px; color: #64748b;">מנהל: ${user.empName || ''} | צוות: ${user.team || 'לא משויך'}</small>`
        : '';
      document.getElementById('teamRecordsTable').innerHTML = `
        <p style="text-align: center; color: #64748b; padding: 40px;">
          <i class="fas fa-info-circle"></i> אין רשומות להצגה
          ${debugInfo}
          <br><br>
          <small style="font-size: 13px;">ודא שהמדריכים משויכים לצוות שלך ב-SharePoint</small>
        </p>
      `;
    }
  } catch (error) {
    console.error('Error loading team records:', error);
    // Fallback to local records
    renderTeamSummary(records);
  }
}

function renderTeamSummary(recordsList) {
  if (!recordsList || recordsList.length === 0) {
    document.getElementById('teamRecordsTable').innerHTML = `
      <p style="text-align: center; color: #64748b; padding: 40px;">
        <i class="fas fa-info-circle"></i> אין רשומות להצגה לחודש זה
        <br><br>
        <span style="font-size: 14px;">אם אתה מנהל צוות, ייתכן שהמדריכים עדיין לא הזינו רשומות, או שהם לא משויכים לצוות שלך.</span>
      </p>
    `;
    return;
  }

  // Group by employee and calculate summary
  const employeeSummary = {};
  recordsList.forEach(rec => {
    const empId = rec.employeeId || rec.empNum || rec.EmployeeId;
    const empName = rec.employeeName || rec.empName || rec.EmployeeName || 'לא ידוע';
    const team = rec.team || rec.Team || '-';
    const empType = rec.employmentType || rec.EmploymentType || 'תעשיידע';
    const hours = parseFloat(rec.workHours || rec.hours || rec.WorkHours || 0);
    const km = parseFloat(rec.kilometers || rec.km || rec.Kilometers || 0);
    const expenses = parseFloat(rec.totalExpenses || rec.TotalExpenses || 0);

    if (!employeeSummary[empId]) {
      employeeSummary[empId] = {
        empId,
        empName,
        team,
        employmentType: empType,
        totalRecords: 0,
        totalHours: 0,
        totalKm: 0,
        totalExpenses: 0
      };
    }

    employeeSummary[empId].totalRecords++;
    employeeSummary[empId].totalHours += hours;
    employeeSummary[empId].totalKm += km;
    employeeSummary[empId].totalExpenses += expenses;
  });

  const summaryList = Object.values(employeeSummary);
  const grandTotalHours = summaryList.reduce((sum, emp) => sum + emp.totalHours, 0);
  const grandTotalKm = summaryList.reduce((sum, emp) => sum + emp.totalKm, 0);
  const grandTotalExpenses = summaryList.reduce((sum, emp) => sum + emp.totalExpenses, 0);
  const grandTotalRecords = summaryList.reduce((sum, emp) => sum + emp.totalRecords, 0);

  const tableHTML = `
    <div style="margin-bottom: 15px;">
      <span style="color: #64748b;">סה"כ ${summaryList.length} עובדים | ${grandTotalRecords} רשומות</span>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width: 30px;"></th>
          <th>שם עובד</th>
          <th>צוות</th>
          <th>סוג העסקה</th>
          <th>רשומות</th>
          <th>סה"כ שעות</th>
          <th>סה"כ ק"מ</th>
          <th>סה"כ הוצאות</th>
        </tr>
      </thead>
      <tbody>
        ${summaryList.map(emp => `
          <tr class="employee-summary-row" onclick="toggleEmployeeDetails('${emp.empId}')" style="cursor: pointer;">
            <td><i class="fas fa-chevron-left" id="chevron-${emp.empId}" style="transition: transform 0.3s;"></i></td>
            <td><strong style="color: #3b82f6;">${emp.empName}</strong></td>
            <td>${emp.team || '-'}</td>
            <td>${emp.employmentType || '-'}</td>
            <td>${emp.totalRecords}</td>
            <td><strong>${formatHoursDisplay(emp.totalHours)}</strong></td>
            <td>${emp.totalKm.toFixed(1)}</td>
            <td>${emp.totalExpenses.toFixed(2)} ₪</td>
          </tr>
          <tr id="details-${emp.empId}" class="employee-details-row" style="display: none;">
            <td colspan="8" style="padding: 0; background: #f8fafc;">
              <div id="details-content-${emp.empId}" style="padding: 15px;">
                <i class="fas fa-spinner fa-spin"></i> טוען פרטים...
              </div>
            </td>
          </tr>
        `).join('')}
        <tr style="background: #f1f5f9; font-weight: bold; border-top: 2px solid #3b82f6;">
          <td colspan="4" style="text-align: left;">סה"כ:</td>
          <td>${grandTotalRecords}</td>
          <td style="color: #3b82f6;">${formatHoursDisplay(grandTotalHours)}</td>
          <td>${grandTotalKm.toFixed(1)}</td>
          <td>${grandTotalExpenses.toFixed(2)} ₪</td>
        </tr>
      </tbody>
    </table>
  `;

  document.getElementById('teamRecordsTable').innerHTML = tableHTML;
}

async function toggleEmployeeDetails(empId) {
  const detailsRow = document.getElementById(`details-${empId}`);
  const chevron = document.getElementById(`chevron-${empId}`);
  const detailsContent = document.getElementById(`details-content-${empId}`);

  if (expandedEmployees[empId]) {
    // Collapse
    detailsRow.style.display = 'none';
    chevron.style.transform = 'rotate(0deg)';
    expandedEmployees[empId] = false;
  } else {
    // Expand
    detailsRow.style.display = 'table-row';
    chevron.style.transform = 'rotate(-90deg)';
    expandedEmployees[empId] = true;

    // Load details if not already loaded
    if (!detailsContent.dataset.loaded) {
      try {
        const user = getCurrentUserData();
        const monthSelect = document.getElementById('teamMonthFilter');
        const yearSelect = document.getElementById('teamYearFilter');
        const selectedMonth = monthSelect ? parseInt(monthSelect.value) : new Date().getMonth() + 1;
        const selectedYear = yearSelect ? parseInt(yearSelect.value) : new Date().getFullYear();

        const response = await fetch(LOGIC_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'getEmployeeRecords',
            employeeId: empId,
            month: selectedMonth,
            year: selectedYear
          })
        });

        const data = await response.json();

        if (data.success && Array.isArray(data.records)) {
          renderEmployeeDetails(empId, data.records);
          detailsContent.dataset.loaded = 'true';
        } else {
          detailsContent.innerHTML = '<p style="color: #94a3b8;">אין רשומות</p>';
        }
      } catch (error) {
        console.error('Error loading employee details:', error);
        // Fallback: filter from cached records
        const empRecords = teamRecordsCache.filter(r =>
          (r.employeeId || r.empNum || r.EmployeeId) === empId
        );
        renderEmployeeDetails(empId, empRecords);
      }
    }
  }
}

function renderEmployeeDetails(empId, records) {
  const detailsContent = document.getElementById(`details-content-${empId}`);
  const user = getCurrentUserData();
  const canEdit = user.role === 'system_admin' || user.role === 'operations_controller' || user.role === 'manager';
  const canDelete = user.role === 'system_admin' || user.role === 'operations_controller';

  if (!records || records.length === 0) {
    detailsContent.innerHTML = '<p style="color: #94a3b8;">אין רשומות</p>';
    return;
  }

  const detailsHTML = `
    <table style="width: 100%; font-size: 13px; margin: 0;">
      <thead>
        <tr style="background: #e2e8f0;">
          <th>תאריך</th>
          <th>התחלה</th>
          <th>סיום</th>
          <th>שעות</th>
          <th>פעילות</th>
          <th>בית ספר</th>
          <th>רשות</th>
          <th>ק"מ</th>
          <th>הוצאות</th>
          <th>הערות</th>
          ${canEdit || canDelete ? '<th>פעולות</th>' : ''}
        </tr>
      </thead>
      <tbody>
        ${records.map(rec => {
          const recordId = rec.ID || rec.Id || rec.id || rec.recordId;
          const date = rec.attendanceDate || rec.date || rec.AttendanceDate || '';
          const start = rec.startTime || rec.start || rec.StartTime || '';
          const end = rec.endTime || rec.end || rec.EndTime || '';
          const hours = rec.workHours || rec.hours || rec.WorkHours || 0;
          const activity = rec.activityType || rec.activity || rec.ActivityType || '';
          const school = rec.schoolName || rec.school || rec.SchoolName || '';
          const municipality = rec.municipality || rec.Municipality || '';
          const km = rec.kilometers || rec.km || rec.Kilometers || 0;
          const expenses = rec.totalExpenses || rec.TotalExpenses || 0;
          const notes = rec.notes || rec.Notes || '';

          return `
            <tr>
              <td>${date}</td>
              <td>${start}</td>
              <td>${end}</td>
              <td><strong>${formatHoursDisplay(hours)}</strong></td>
              <td>${activity}</td>
              <td>${school || '-'}</td>
              <td>${municipality || '-'}</td>
              <td>${km}</td>
              <td>${expenses} ₪</td>
              <td>${notes || '-'}</td>
              ${canEdit || canDelete ? `
                <td>
                  ${canEdit ? `<button onclick="editTeamRecord(${recordId})" class="btn-icon" title="עריכה"><i class="fas fa-edit"></i></button>` : ''}
                  ${canDelete ? `<button onclick="deleteTeamRecord(${recordId})" class="btn-icon" style="color: #dc2626;" title="מחיקה"><i class="fas fa-trash"></i></button>` : ''}
                </td>
              ` : ''}
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;

  detailsContent.innerHTML = detailsHTML;
}

function editTeamRecord(recordId) {
  // Find record in cache and open edit modal
  const record = teamRecordsCache.find(r =>
    (r.ID || r.Id || r.id || r.recordId) == recordId
  );
  if (record) {
    // Map to local format and edit
    const localRecord = {
      recordId: recordId,
      empNum: record.employeeId || record.EmployeeId,
      empName: record.employeeName || record.EmployeeName,
      date: record.attendanceDate || record.AttendanceDate,
      start: record.startTime || record.StartTime,
      end: record.endTime || record.EndTime,
      hours: record.workHours || record.WorkHours,
      activity: record.activityType || record.ActivityType,
      school: record.schoolName || record.SchoolName,
      municipality: record.municipality || record.Municipality,
      program: record.programName || record.ProgramName,
      session: record.sessionNumber || record.SessionNumber,
      km: record.kilometers || record.Kilometers,
      totalExpenses: record.totalExpenses || record.TotalExpenses,
      expensesDetail: record.expensesDetails || record.ExpensesDetails,
      notes: record.notes || record.Notes,
      team: record.team || record.Team,
      employmentType: record.employmentType || record.EmploymentType
    };

    const idx = records.findIndex(r => r.recordId == recordId);
    if (idx >= 0) {
      editRecord(idx);
    } else {
      // Add to records temporarily and edit
      records.push(localRecord);
      editRecord(records.length - 1);
    }
  }
}

async function deleteTeamRecord(recordId) {
  if (!confirm('האם אתה בטוח שברצונך למחוק רשומה זו?')) return;

  try {
    const response = await fetch(LOGIC_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'deleteRecord',
        recordId: recordId
      })
    });

    if (response.ok) {
      showAlert('הרשומה נמחקה בהצלחה', 'success');
      loadTeamRecords(); // Reload
    } else {
      showAlert('שגיאה במחיקה', 'error');
    }
  } catch (error) {
    showAlert('שגיאה במחיקה', 'error');
  }
}

function loadReports() {
  document.getElementById('teamTotalRecords').textContent = '0';
  document.getElementById('teamTotalHours').textContent = '0:00';
  document.getElementById('teamTotalExpenses').textContent = '0 ₪';
  
  document.getElementById('reportsByEmployee').innerHTML = `
    <p style="text-align: center; color: #64748b; padding: 40px;">
      <i class="fas fa-info-circle"></i>
      דוחות יוצגו כאן לאחר סנכרון מ-SharePoint
    </p>
  `;
}

function exportTeamToExcel() {
  // Use all records (local records for now, team records when synced)
  const dataToExport = records;
  
  if (dataToExport.length === 0) {
    showAlert('⚠️ אין נתונים לייצוא', 'error');
    return;
  }
  
  // Export all records for the monthly report (approved status shown in column)
  const approvedRecords = dataToExport;
  
  // Create workbook with SheetJS (xlsx library)
  // Since we don't have xlsx library, create a multi-sheet CSV approach
  // Sheet 1: Detailed records
  let detailedCSV = 'מספר עובד,שם עובד,תאריך,שעת התחלה,שעת סיום,שעות,סוג פעילות,בית ספר,רשות,תוכנית,מספר מפגש,קילומטר,הוצאות,פירוט הוצאות,הערות\n';
  
  approvedRecords.forEach(rec => {
    detailedCSV += `${rec.empNum},${rec.empName},${rec.date},${rec.start || ''},${rec.end || ''},${rec.hours},${rec.activity},${rec.school || ''},${rec.municipality},${rec.program || ''},${rec.session || ''},${rec.km || 0},${rec.totalExpenses || 0},"${(rec.expensesDetail || '').replace(/"/g, '""')}","${(rec.notes || '').replace(/"/g, '""')}"\n`;
  });
  
  // Sheet 2: Summary by activity type (hours only) + general totals
  let summaryCSV = '\n\n--- גיליון מסכם ---\n\n';
  summaryCSV += 'סיכום שעות לפי סוג פעילות\n';
  summaryCSV += 'סוג פעילות,סה"כ שעות\n';
  
  // Group hours by activity type
  const hoursByActivity = {};
  approvedRecords.forEach(rec => {
    const activity = rec.activity || 'לא מוגדר';
    hoursByActivity[activity] = (hoursByActivity[activity] || 0) + (parseFloat(rec.hours) || 0);
  });
  
  Object.entries(hoursByActivity).forEach(([activity, hours]) => {
    summaryCSV += `${activity},${hours.toFixed(2)}\n`;
  });
  
  // General totals
  const totalKm = approvedRecords.reduce((sum, rec) => sum + (parseFloat(rec.km) || 0), 0);
  const totalExpenses = approvedRecords.reduce((sum, rec) => sum + (parseFloat(rec.totalExpenses) || 0), 0);
  const totalHours = approvedRecords.reduce((sum, rec) => sum + (parseFloat(rec.hours) || 0), 0);
  
  summaryCSV += '\n\nסיכום כללי\n';
  summaryCSV += `סה"כ שעות,${totalHours.toFixed(2)}\n`;
  summaryCSV += `סה"כ קילומטר,${totalKm.toFixed(1)}\n`;
  summaryCSV += `סה"כ הוצאות,${totalExpenses.toFixed(2)} ₪\n`;
  
  // Combine both sheets
  const fullCSV = detailedCSV + summaryCSV;
  
  const blob = new Blob(['\ufeff' + fullCSV], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  const monthName = new Date().toLocaleDateString('he-IL', { month: 'long', year: 'numeric' });
  link.download = `דוח_נוכחות_${monthName}.csv`;
  link.click();
  
  showAlert('✅ הקובץ יוצא בהצלחה!', 'success');
}

function viewAllRecords() {
  showPage(null, 'team-records');
}

function exportAllToExcel() {
  exportToExcel();
}

// =============== Alert ===============
function showAlert(message, type = 'success') {
  const alert = document.getElementById('alertBox');
  const alertText = document.getElementById('alertText');
  
  alert.className = `alert ${type} show`;
  alertText.textContent = message;
  
  setTimeout(() => {
    alert.classList.remove('show');
  }, 5000);
}

// =============== LocalStorage ===============
function saveToLocalStorage() {
  localStorage.setItem('attendanceRecords', JSON.stringify(records));
}

function loadFromLocalStorage() {
  try {
    const data = localStorage.getItem('attendanceRecords');
    if (data) {
      records = JSON.parse(data);
    }
  } catch(e) {
    console.error('שגיאה בטעינת נתונים:', e);
  }
}

// =============== SharePoint Sync ===============
// Real syncFromSharePoint is defined above in the login section

function mergeRecords(loadedRecords) {
  const existingIds = new Set(records.map(r => r.id));
  loadedRecords.forEach(rec => {
    if (!existingIds.has(rec.id)) {
      records.push(rec);
    }
  });
}

// =============== File to Base64 ===============
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}

// =============== Format Attachments ===============
function formatAttachments(attachments) {
  if (!attachments || attachments.length === 0) {
    return '';
  }
  
  return attachments.map(file => {
    const sizeKB = (file.size / 1024).toFixed(1);
    return `${file.name} (${sizeKB} KB)`;
  }).join(', ');
}

// =============== Submit to SharePoint ===============
async function submitAll() {
  if (records.length === 0) {
    showAlert('אין נתונים לשליחה', 'error');
    return;
  }
  
  const pending = records.filter(r => r.status !== 'נשלח');
  
  if (pending.length === 0) {
    showAlert('אין רשומות חדשות לשליחה', 'info');
    return;
  }
  
  showAlert(`🚀 שולח ${pending.length} דיווחים...`, 'info');
  
  let success = 0;
  let failed = 0;
  
  for (const rec of pending) {
    try {
    const payload = {
        action: "submit",
        employeeId: localStorage.getItem("employeeId") || rec.empNum,
        employeeName: localStorage.getItem("employeeName") || rec.empName,
        attendanceDate: rec.date,
        startTime: rec.start || '',
        endTime: rec.end || '',
        workHours: rec.hours ? Number(rec.hours).toFixed(2) : '0',
        activityType: rec.activity,
        schoolName: rec.school || '',
        municipality: rec.municipality || '',
        programName: rec.program || '',
        sessionNumber: rec.session || '',
        kilometers: rec.km || 0,
        totalExpenses: rec.totalExpenses || 0,
        expensesDetails: rec.expensesDetail || '',
        notes: rec.notes || '',
        attachments: rec.attachments || [],
        attachmentsNames: formatAttachments(rec.attachments || []),
        employmentType: String(localStorage.getItem("employmentType") || 'תעשיידע'),
        team: String(localStorage.getItem("team") || '')
      };
      
      const response = await fetch(LOGIC_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      console.log('Response:', response.status, response.statusText);
      
      if (response.ok) {
        rec.synced = true;
        success++;
      } else {
        failed++;
      }
    } catch(error) {
      console.error('שגיאה בשליחה:', error);
      failed++;
    }
  }
  
  saveToLocalStorage();
  updateStats();
  renderRecordsTable();
  
  if (failed === 0) {
    showAlert(`✅ כל הדיווחים (${success}) נשלחו בהצלחה!`, 'success');
  } else {
    showAlert(`⚠️ נשלחו ${success} דיווחים, ${failed} נכשלו`, 'error');
  }
}

// =============== Summary Table ===============
function renderSummaryTable() {
  const summaryData = {};
  let totalKm = 0;

  records.forEach(rec => {
    const activity = rec.activity || 'אחר';
    const hours = parseFloat(rec.hours) || 0;
    const km = parseFloat(rec.km) || 0;

    if (!summaryData[activity]) {
      summaryData[activity] = { hours: 0, km: 0 };
    }
    summaryData[activity].hours += hours;
    summaryData[activity].km += km;
    totalKm += km;
  });

  const tbody = document.getElementById('summaryTableBody');
  if (!tbody) return;

  if (Object.keys(summaryData).length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #94a3b8;">אין נתונים להצגה</td></tr>';
    return;
  }

  let html = '';
  for (const [activity, data] of Object.entries(summaryData)) {
    html += `
      <tr>
        <td style="font-weight: 500; color: #1e293b;">${activity}</td>
        <td>${formatHoursDisplay(data.hours)}</td>
        <td>${data.km.toFixed(1)}</td>
      </tr>
    `;
  }

  // שורת סיכום סופית
  const totalHours = records.reduce((sum, r) => sum + (parseFloat(r.hours) || 0), 0);
  html += `
    <tr style="background: #f8fafc; font-weight: 700;">
      <td style="color: #1e40af;">סה"כ כולל</td>
      <td style="color: #1e40af;">${formatHoursDisplay(totalHours)}</td>
      <td style="color: #1e40af;">${totalKm.toFixed(1)}</td>
    </tr>
  `;

  tbody.innerHTML = html;
}

// =============== Statistics ===============
function updateStats() {
  // Filter records for current month only
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
  
  const monthRecords = records.filter(r => {
    if (!r.date) return false;
    const recDate = new Date(r.date);
    return recDate.getMonth() === currentMonth && recDate.getFullYear() === currentYear;
  });
  
  const uniqueDates = new Set(monthRecords.map(r => r.date)).size;
  const totalHoursNum = monthRecords.reduce((sum, r) => sum + (parseFloat(r.hours) || 0), 0);
  const totalExpenses = monthRecords.reduce((sum, r) => sum + (parseFloat(r.totalExpenses) || 0), 0).toFixed(2);
  const totalKm = monthRecords.reduce((sum, r) => sum + (parseFloat(r.km) || 0), 0).toFixed(1);
  
  document.getElementById('totalRecordsStat').textContent = uniqueDates;
  document.getElementById('totalHoursStat').textContent = formatHoursDisplay(totalHoursNum);
  document.getElementById('totalExpensesStat').textContent = totalExpenses + ' ₪';
  document.getElementById('pendingRecordsStat').textContent = totalKm + ' ק"מ';
  
  // Update month label
  const monthLabel = document.getElementById('dashboardMonthLabel');
  if (monthLabel) {
    monthLabel.textContent = `סיכום חודש ${monthNames[currentMonth]} ${currentYear}`;
  }
}

// =============== Dashboard ===============
function updateDashboard() {
  updateStats();
  // Update appropriate dashboard based on role
  const role = localStorage.getItem("role") || '';
  if (role === 'payroll_officer') {
    updatePayrollSummaryTable();
  } else if (role === 'system_admin' || role === 'operations_controller') {
    updateAdminDashboard();
  }
}

// =============== Payroll Officer Functions ===============
async function updatePayrollSummaryTable() {
  const tbody = document.getElementById('payrollSummaryTableBody');
  if (!tbody) return;
  
  // Get current month for filtering
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  // Filter records to current month only
  const currentMonthRecords = records.filter(rec => {
    if (!rec.date) return false;
    const recDate = new Date(rec.date);
    return recDate.getMonth() === currentMonth && recDate.getFullYear() === currentYear;
  });
  
  // Group records by instructor
  const instructorData = {};
  
  currentMonthRecords.forEach(rec => {
    const name = rec.empName || rec.empNum || 'לא ידוע';
    if (!instructorData[name]) {
      instructorData[name] = {
        name: name,
        team: rec.team || '',
        workDays: new Set(),
        hoursCourse: 0,
        hoursTraining: 0,
        hoursCancel: 0,
        totalKm: 0,
        totalExpenses: 0
      };
    }
    
    // Add unique work days
    if (rec.date) {
      instructorData[name].workDays.add(rec.date);
    }
    
    // Sum hours by activity type
    const hours = parseFloat(rec.hours) || 0;
    const activity = (rec.activity || '').toLowerCase();
    if (activity.includes('קורס') || activity.includes('הפעלה')) {
      instructorData[name].hoursCourse += hours;
    } else if (activity.includes('הכשרה') || activity.includes('השתלמות')) {
      instructorData[name].hoursTraining += hours;
    } else if (activity.includes('ביטול')) {
      instructorData[name].hoursCancel += hours;
    } else {
      instructorData[name].hoursCourse += hours; // Default to course hours
    }
    
    // Sum kilometers and expenses
    instructorData[name].totalKm += parseFloat(rec.km) || 0;
    instructorData[name].totalExpenses += parseFloat(rec.totalExpenses) || 0;
    
    // Update team if empty
    if (!instructorData[name].team && rec.team) {
      instructorData[name].team = rec.team;
    }
  });
  
  // Render table
  const sortedInstructors = Object.values(instructorData).sort((a, b) => a.name.localeCompare(b.name, 'he'));
  
  if (sortedInstructors.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #64748b;">אין נתונים להצגה</td></tr>';
    return;
  }
  
  tbody.innerHTML = sortedInstructors.map(inst => `
    <tr>
      <td style="padding: 10px 8px; text-align: right; font-weight: 500;">${inst.name}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.team || '-'}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.workDays.size}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.hoursCourse.toFixed(1)}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.hoursTraining.toFixed(1)}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.hoursCancel.toFixed(1)}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.totalKm}</td>
      <td style="padding: 10px 8px; text-align: center;">${inst.totalExpenses.toFixed(0)} ₪</td>
    </tr>
  `).join('');
}

function exportPayrollToExcel() {
  // Get current month for filtering
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  // Filter records to current month only
  const currentMonthRecords = records.filter(rec => {
    if (!rec.date) return false;
    const recDate = new Date(rec.date);
    return recDate.getMonth() === currentMonth && recDate.getFullYear() === currentYear;
  });
  
  // Group records by instructor
  const instructorData = {};
  
  currentMonthRecords.forEach(rec => {
    const name = rec.empName || rec.empNum || 'לא ידוע';
    if (!instructorData[name]) {
      instructorData[name] = {
        name: name,
        team: rec.team || '',
        workDays: new Set(),
        hoursCourse: 0,
        hoursTraining: 0,
        hoursCancel: 0,
        totalKm: 0,
        totalExpenses: 0
      };
    }
    
    if (rec.date) instructorData[name].workDays.add(rec.date);
    
    const hours = parseFloat(rec.hours) || 0;
    const activity = (rec.activity || '').toLowerCase();
    if (activity.includes('קורס') || activity.includes('הפעלה')) {
      instructorData[name].hoursCourse += hours;
    } else if (activity.includes('הכשרה') || activity.includes('השתלמות')) {
      instructorData[name].hoursTraining += hours;
    } else if (activity.includes('ביטול')) {
      instructorData[name].hoursCancel += hours;
    } else {
      instructorData[name].hoursCourse += hours;
    }
    
    instructorData[name].totalKm += parseFloat(rec.km) || 0;
    instructorData[name].totalExpenses += parseFloat(rec.totalExpenses) || 0;
    if (!instructorData[name].team && rec.team) instructorData[name].team = rec.team;
  });
  
  const sortedInstructors = Object.values(instructorData).sort((a, b) => a.name.localeCompare(b.name, 'he'));
  
  if (sortedInstructors.length === 0) {
    showAlert('אין נתונים לייצוא', 'warning');
    return;
  }
  
  // Create CSV content
  const headers = ['שם המדריך', 'צוות', 'ימי עבודה', 'סה"כ שעות קורס', 'סה"כ שעות הכשרה', 'סה"כ שעות ביטול', 'קילומטר-סה"כ', 'סה"כ הוצאות'];
  
  let csvContent = '\uFEFF'; // BOM for Hebrew
  csvContent += headers.join(',') + '\n';
  
  sortedInstructors.forEach(inst => {
    const row = [
      `"${inst.name}"`,
      `"${inst.team || ''}"`,
      inst.workDays.size,
      inst.hoursCourse.toFixed(1),
      inst.hoursTraining.toFixed(1),
      inst.hoursCancel.toFixed(1),
      inst.totalKm,
      inst.totalExpenses.toFixed(0)
    ];
    csvContent += row.join(',') + '\n';
  });
  
  // Download file
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const filename = `סיכום_נוכחות_${currentYear}_${(currentMonth+1).toString().padStart(2,'0')}.csv`;
  
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  
  showAlert('הקובץ יורד...', 'success');
}

// =============== Time Picker Functions ===============
function populateTimeDropdowns() {
  const hourSelects = ['startHour', 'endHour', 'editStartHour', 'editEndHour'];
  const minuteSelects = ['startMinute', 'endMinute', 'editStartMinute', 'editEndMinute'];
  
  hourSelects.forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      select.innerHTML = '<option value="">שעה</option>';
      for (let h = 6; h <= 23; h++) {
        const val = h.toString().padStart(2, '0');
        select.innerHTML += `<option value="${val}">${val}</option>`;
      }
    }
  });
  
  minuteSelects.forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      select.innerHTML = '<option value="">דקות</option>';
      for (let m = 0; m < 60; m += 5) {
        const val = m.toString().padStart(2, '0');
        select.innerHTML += `<option value="${val}">${val}</option>`;
      }
    }
  });
}

function updateTimeField(prefix) {
  const hourSelect = document.getElementById(prefix + 'Hour');
  const minuteSelect = document.getElementById(prefix + 'Minute');
  const hiddenField = document.getElementById(prefix + 'Time');
  
  if (hourSelect && minuteSelect && hiddenField) {
    const hour = hourSelect.value;
    const minute = minuteSelect.value;
    if (hour && minute) {
      hiddenField.value = hour + ':' + minute;
    } else {
      hiddenField.value = '';
    }
  }
  
  // Update end time minimum when start time changes
  if (prefix === 'start') {
    updateEndTimeMinimum('start', 'end');
  } else if (prefix === 'editStart') {
    updateEndTimeMinimum('editStart', 'editEnd');
  }
}

function updateEndTimeMinimum(startPrefix, endPrefix) {
  const startHourSelect = document.getElementById(startPrefix + 'Hour');
  const endHourSelect = document.getElementById(endPrefix + 'Hour');
  
  if (!startHourSelect || !endHourSelect) return;
  
  const startHour = parseInt(startHourSelect.value) || 0;
  const currentEndHour = endHourSelect.value;
  
  // Save current selection
  const savedEndHour = currentEndHour;
  
  // Clear and rebuild end hour options
  endHourSelect.innerHTML = '<option value="">שעה</option>';
  
  for (let h = startHour; h <= 23; h++) {
    const hStr = h.toString().padStart(2, '0');
    const option = document.createElement('option');
    option.value = hStr;
    option.textContent = hStr;
    endHourSelect.appendChild(option);
  }
  
  // Restore selection if still valid
  if (savedEndHour && parseInt(savedEndHour) >= startHour) {
    endHourSelect.value = savedEndHour;
  } else if (startHour) {
    // Auto-select start hour as minimum
    endHourSelect.value = startHour.toString().padStart(2, '0');
    updateTimeField(endPrefix);
  }
}

function setTimeDropdowns(prefix, timeValue) {
  if (!timeValue) return;
  const parts = timeValue.split(':');
  if (parts.length >= 2) {
    const hour = parts[0].padStart(2, '0');
    const minute = parts[1].padStart(2, '0');
    const roundedMinute = (Math.round(parseInt(minute) / 5) * 5).toString().padStart(2, '0');
    
    const hourSelect = document.getElementById(prefix + 'Hour');
    const minuteSelect = document.getElementById(prefix + 'Minute');
    const hiddenField = document.getElementById(prefix + 'Time');
    
    if (hourSelect) hourSelect.value = hour;
    if (minuteSelect) minuteSelect.value = roundedMinute;
    if (hiddenField) hiddenField.value = hour + ':' + roundedMinute;
  }
}

// =============== Calculate Hours ===============
function calculateHours() {
  const startTime = document.getElementById('startTime').value;
  const endTime = document.getElementById('endTime').value;
  
  if (startTime && endTime) {
    const start = new Date('2000-01-01 ' + startTime);
    const end = new Date('2000-01-01 ' + endTime);
    
    let diff = (end - start) / 1000 / 60 / 60;
    
    if (diff < 0) {
      diff += 24;
    }
    
    const formatted = diff.toFixed(2);
    document.getElementById('hoursField').value = formatted;
    const hoursDisplay = document.getElementById('hoursDisplay');
    if (hoursDisplay) hoursDisplay.textContent = formatHoursDisplay(diff);
  } else {
    document.getElementById('hoursField').value = '';
    const hoursDisplay = document.getElementById('hoursDisplay');
    if (hoursDisplay) hoursDisplay.textContent = '0:00';
  }
}

function calculateEditHours() {
  const startTime = document.getElementById('editStartTime').value;
  const endTime = document.getElementById('editEndTime').value;
  
  if (startTime && endTime) {
    const start = new Date('2000-01-01 ' + startTime);
    const end = new Date('2000-01-01 ' + endTime);
    
    let diff = (end - start) / 1000 / 60 / 60;
    
    if (diff < 0) {
      diff += 24;
    }
    
    document.getElementById('editHours').value = diff.toFixed(2);
  }
}

// =============== Add Record ===============
async function addRecord() {
  const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
  const empNum = userData.empNum || '';
  const empName = userData.empName || '';
  
  console.log('=== DEBUG addRecord ===');
  console.log('userData:', userData);
  console.log('empNum:', empNum);
  console.log('empName:', empName);
  
  const date = document.getElementById('recDate').value;
  const startTime = document.getElementById('startTime').value;
  const endTime = document.getElementById('endTime').value;
  const hours = parseFloat(document.getElementById('hoursField').value) || 0;
  const activity = document.getElementById('activityType').value;
  
  const schoolSelect = document.getElementById('schoolField');
  let school = '';
  let municipality = '';
  
  if (schoolSelect.value) {
    try {
      const schoolData = JSON.parse(schoolSelect.value);
      school = schoolData['בית ספר'];
      municipality = schoolData['רשות'];
    } catch(e) {}
  }
  
  const program = document.getElementById('programField').value;
  const session = document.getElementById('sessionNum').value;
  const km = parseFloat(document.getElementById('kmField').value) || 0;
  const totalExpenses = parseFloat(document.getElementById('totalExpenses').value) || 0;
  const expensesDetail = document.getElementById('expensesDetail').value;
  const notes = document.getElementById('notesField').value;
  
  // Use selectedFiles array (populated by drag-drop or file picker)
  const attachments = [];
  if (selectedFiles && selectedFiles.length > 0) {
    for (const file of selectedFiles) {
      const base64 = await fileToBase64(file);
      attachments.push({
        name: file.name,
        type: file.type,
        size: file.size,
        content: base64
      });
    }
  }
  
  const missing = [];
  if (!date) missing.push('תאריך');
  if (!startTime) missing.push('שעת התחלה');
  if (!endTime) missing.push('שעת סיום');
  if (!hours) missing.push('שעות');
  if (!activity) missing.push('סוג פעילות');
  if (!school) missing.push('בית ספר');
  if (!municipality) missing.push('רשות');
  if (!program) missing.push('תוכנית');
  if (!session) missing.push('מספר מפגש');
  
  if (missing.length > 0) {
    showAlert('⚠️ אנא מלא את כל השדות החובה: ' + missing.join(', '), 'error');
    return;
  }
  
  const currentUserData = getCurrentUserData();
  const rawEmploymentType = currentUserData?.employmentType || localStorage.getItem("employmentType") || 'תעשיידע';
  const employmentType = extractLookupValue(rawEmploymentType, 'תעשיידע');
  
  const rawTeam = localStorage.getItem("team") || '';
  const team = extractLookupValue(rawTeam, '');
  
  const payload = {
    action: "submit",
    employeeId: String(localStorage.getItem("employeeId") || empNum),
    employeeName: String(localStorage.getItem("employeeName") || empName),
    attendanceDate: String(date),
    startTime: String(startTime),
    endTime: String(endTime),
    workHours: Number(hours),
    activityType: String(activity),
    schoolName: String(school),
    municipality: String(municipality),
    programName: String(program),
    sessionNumber: Number(session) || 0,
    kilometers: Number(km) || 0,
    totalExpenses: Number(totalExpenses) || 0,
    expensesDetails: String(expensesDetail || ''),
    notes: String(notes || ''),
    employmentType: String(employmentType),
    team: String(team)
  };
  
  // Send to SharePoint
  showAlert('🚀 שולח דיווח ל-SharePoint...', 'info');
  
  try {
    const response = await fetch(LOGIC_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      clearAddForm();
      await syncFromSharePoint(empNum);
      showAlert('✅ הדיווח נשלח בהצלחה!', 'success');
      showPage(null, 'dashboard');
    } else {
      showAlert('❌ שגיאה בשליחה: ' + response.status, 'error');
    }
  } catch (error) {
    console.error('Submit error:', error);
    showAlert('❌ שגיאה בשליחה לשרת', 'error');
  }
}

function clearAddForm() {
  document.getElementById('recDate').value = '';
  document.getElementById('startHour').value = '';
  document.getElementById('startMinute').value = '';
  document.getElementById('startTime').value = '';
  document.getElementById('endHour').value = '';
  document.getElementById('endMinute').value = '';
  document.getElementById('endTime').value = '';
  document.getElementById('hoursField').value = '';
  document.getElementById('activityType').value = '';
  document.getElementById('schoolField').value = '';
  document.getElementById('municipality').value = '';
  document.getElementById('programField').value = '';
  document.getElementById('sessionNum').value = '';
  document.getElementById('kmField').value = '';
  document.getElementById('totalExpenses').value = '';
  document.getElementById('expensesDetail').value = '';
  clearSelectedFiles(); // Clear drag-drop file selection
  document.getElementById('notesField').value = '';
}

// =============== Records Table ===============
function renderRecordsTable() {
  document.getElementById('totalRecordsCount').textContent = records.length;
  
  const totalHours = records.reduce((sum, rec) => sum + (rec.hours || 0), 0);
  const totalKm = records.reduce((sum, rec) => sum + (rec.km || 0), 0);
  
  if (records.length === 0) {
    document.getElementById('recordsTable').innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px;">אין רשומות להצגה</p>';
    return;
  }
  
  const user = getCurrentUserData();
  const userRole = user ? user.role : 'instructor';
  const showActionsColumn = userRole !== 'instructor';
  
  const tableHTML = `
    <table>
      <thead>
        <tr>
          <th>תאריך</th>
          <th>שעת התחלה</th>
          <th>שעת סיום</th>
          <th>סה"כ שעות</th>
          <th>פעילות</th>
          <th>בית ספר</th>
          <th>רשות</th>
          <th>ק"מ</th>
          ${showActionsColumn ? '<th>פעולות</th>' : ''}
        </tr>
      </thead>
      <tbody>
        ${records.map((rec, idx) => `
          <tr>
            <td>${rec.date}</td>
            <td style="text-align: center; font-family: 'Courier New', monospace;">
              ${rec.start || '--:--'}
            </td>
            <td style="text-align: center; font-family: 'Courier New', monospace;">
              ${rec.end || '--:--'}
            </td>
            <td style="text-align: center;">
              <strong style="color: #1e40af;">${formatHoursDisplay(rec.hours)}</strong>
            </td>
            <td>${rec.activity}</td>
            <td>${rec.school || '-'}</td>
            <td>${rec.municipality}</td>
            <td style="text-align: center;">${rec.km || 0}</td>
            ${showActionsColumn ? `
            <td style="white-space: nowrap;">
              ${canEditRecord(rec) ? `
              <button onclick="editRecord(${idx})" style="background: #dbeafe; color: #1e40af; padding: 4px 6px; border: none; border-radius: 4px; cursor: pointer; margin-left: 2px;" title="עריכה">
                <i class="fas fa-edit"></i>
              </button>
              ` : ''}
              ${canDeleteRecord(rec) ? `
              <button onclick="deleteRecord(${idx})" style="background: #fecaca; color: #b91c1c; padding: 4px 6px; border: none; border-radius: 4px; cursor: pointer;" title="מחיקה">
                <i class="fas fa-trash"></i>
              </button>
              ` : ''}
            </td>
            ` : ''}
          </tr>
        `).join('')}
        <tr style="background: #f8fafc; font-weight: bold; border-top: 2px solid #3b82f6;">
          <td style="text-align: left; padding-right: 20px;">סה"כ:</td>
          <td></td>
          <td></td>
          <td style="text-align: center; color: #3b82f6; font-size: 16px;">${formatHoursDisplay(totalHours)}</td>
          <td></td>
          <td></td>
          <td></td>
          <td style="text-align: center; color: #3b82f6;">${totalKm.toFixed(1)}</td>
          ${showActionsColumn ? '<td></td>' : ''}
        </tr>
      </tbody>
    </table>
  `;
  
  document.getElementById('recordsTable').innerHTML = tableHTML;
}

async function deleteRecord(index) {
  const rec = records[index];
  if (!rec) return;

  if (!canDeleteRecord(rec)) {
    showAlert('❌ אין לך הרשאה למחוק רשומות', 'error');
    return;
  }

  if (!confirm('האם אתה בטוח שברצונך למחוק רשומה זו?')) return;

  showAlert('🗑️ מוחק רשומה...', 'info');

  try {
    const ok = await deleteRecordOnServer(rec);

    if (!ok) {
      showAlert('❌ מחיקה נכשלה בשרת', 'error');
      return;
    }

    await loadMyRecordsFromServer();
    showAlert('✅ הרשומה נמחקה מהשרת בהצלחה', 'success');
  } catch (e) {
    console.error(e);
    showAlert('❌ שגיאה במחיקה מהשרת', 'error');
  }
}

// =============== Edit Record ===============
function editRecord(index) {
  const rec = records[index];
  
  if (!canEditRecord(rec)) {
    showAlert('❌ אין לך הרשאה לערוך רשומות', 'error');
    return;
  }
  
  editingIndex = index;
  
  document.getElementById('editDate').value = rec.date;
  setTimeDropdowns('editStart', rec.start || '');
  setTimeDropdowns('editEnd', rec.end || '');
  document.getElementById('editHours').value = rec.hours;
  document.getElementById('editActivity').value = rec.activity;
  
  const schoolSelect = document.getElementById('editSchool');
  schoolSelect.innerHTML = '<option value="">בחר בית ספר</option>';
  schoolsData.forEach(school => {
    const option = document.createElement('option');
    option.value = JSON.stringify(school);
    option.textContent = school['בית ספר'];
    if (school['בית ספר'] === rec.school) {
      option.selected = true;
    }
    schoolSelect.appendChild(option);
  });
  
  document.getElementById('editMunicipality').value = rec.municipality;
  document.getElementById('editProgram').value = rec.program || '';
  document.getElementById('editSession').value = rec.session || '';
  document.getElementById('editKm').value = rec.km || '';
  document.getElementById('editTotalExpenses').value = rec.totalExpenses || '';
  document.getElementById('editExpensesDetail').value = rec.expensesDetail || '';
  document.getElementById('editNotes').value = rec.notes || '';
  
  if (rec.school === 'זום') {
    document.getElementById('editKm').value = '0';
    document.getElementById('editKm').readOnly = true;
    document.getElementById('editKm').style.background = '#f1f5f9';
  } else {
    document.getElementById('editKm').readOnly = false;
    document.getElementById('editKm').style.background = 'white';
  }
  
  document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
  editingIndex = -1;
}

function updateEditMunicipality() {
  const schoolSelect = document.getElementById('editSchool');
  const municipalityInput = document.getElementById('editMunicipality');
  const kmField = document.getElementById('editKm');
  
  if (schoolSelect.value) {
    try {
      const school = JSON.parse(schoolSelect.value);
      municipalityInput.value = school['רשות'];
      
      if (school['בית ספר'] === 'זום') {
        kmField.value = '0';
        kmField.readOnly = true;
        kmField.style.background = '#f1f5f9';
        kmField.style.cursor = 'not-allowed';
      } else {
        kmField.readOnly = false;
        kmField.style.background = 'white';
        kmField.style.cursor = 'text';
      }
    } catch(e) {
      console.error('שגיאה בעידכון רשות:', e);
    }
  }
}

async function saveEdit() {
  if (editingIndex === -1) return;
  
  const originalDate = records[editingIndex].date;
  const originalStartTime = records[editingIndex].start;
  
  const date = document.getElementById('editDate').value;
  const startTime = document.getElementById('editStartTime').value;
  const endTime = document.getElementById('editEndTime').value;
  const hours = parseFloat(document.getElementById('editHours').value) || 0;
  const activity = document.getElementById('editActivity').value;
  const schoolSelect = document.getElementById('editSchool');
  const municipality = document.getElementById('editMunicipality').value;
  const program = document.getElementById('editProgram').value;
  const session = document.getElementById('editSession').value;
  const km = parseFloat(document.getElementById('editKm').value) || 0;
  const totalExpenses = parseFloat(document.getElementById('editTotalExpenses').value) || 0;
  const expensesDetail = document.getElementById('editExpensesDetail').value;
  const notes = document.getElementById('editNotes').value;
  const attachmentsInput = document.getElementById('editAttachments');
  let attachments = records[editingIndex].attachments || [];
  
  if (attachmentsInput.files.length > 0) {
    for (const file of attachmentsInput.files) {
      const base64 = await fileToBase64(file);
      attachments.push({ 
        name: file.name, 
        size: file.size,
        type: file.type,
        content: base64 
      });
    }
  }
  
  let school = '';
  if (schoolSelect.value) {
    try {
      const schoolData = JSON.parse(schoolSelect.value);
      school = schoolData['בית ספר'];
    } catch(e) {}
  }
  
  const missing = [];
  if (!date) missing.push('תאריך');
  if (!startTime) missing.push('שעת התחלה');
  if (!endTime) missing.push('שעת סיום');
  if (!hours) missing.push('שעות');
  if (!activity) missing.push('סוג פעילות');
  if (!school) missing.push('בית ספר');
  if (!municipality) missing.push('רשות');
  if (!program) missing.push('תוכנית');
  if (!session) missing.push('מספר מפגש');
  
  if (missing.length > 0) {
    showAlert('⚠️ אנא מלא את כל השדות החובה: ' + missing.join(', '), 'error');
    return;
  }
  
  records[editingIndex] = {
    ...records[editingIndex],
    date,
    start: startTime,
    end: endTime,
    hours,
    activity,
    school,
    municipality,
    location: '',
    program,
    session,
    km,
    totalExpenses,
    expensesDetail,
    notes,
    attachments,
    status: 'ממתין'
  };
  
  showAlert('🔄 מעדכן רשומה בשרת...', 'info');

  try {
    const ok = await updateRecordOnServer(records[editingIndex], originalDate, originalStartTime);

    if (!ok) {
      showAlert('⚠️ העדכון נשמר מקומית אבל נכשל בשרת', 'error');
      saveToLocalStorage();
      updateStats();
      renderRecordsTable();
      closeEditModal();
      return;
    }

    await loadMyRecordsFromServer();
    closeEditModal();
    showAlert('✅ הרשומה עודכנה בהצלחה ונשמרה בשרת', 'success');
  } catch (e) {
    console.error(e);
    showAlert('❌ שגיאה בעדכון הרשומה בשרת', 'error');
    saveToLocalStorage();
    updateStats();
    renderRecordsTable();
    closeEditModal();
  }
}

// =============== Schools Functions ===============
function populateSchools() {
  const schoolSelect = document.getElementById('schoolField');
  schoolSelect.innerHTML = '<option value="">בחר בית ספר</option>';
  
  schoolsData.forEach(school => {
    const option = document.createElement('option');
    option.value = JSON.stringify(school);
    option.textContent = school['בית ספר'];
    schoolSelect.appendChild(option);
  });
}

function updateMunicipalityFromSchool() {
  const schoolSelect = document.getElementById('schoolField');
  const municipalityInput = document.getElementById('municipality');
  const kmField = document.getElementById('kmField');
  
  if (schoolSelect.value) {
    try {
      const school = JSON.parse(schoolSelect.value);
      municipalityInput.value = school['רשות'];
      
      if (school['בית ספר'] === 'זום') {
        kmField.value = '0';
        kmField.readOnly = true;
        kmField.style.background = '#f1f5f9';
        kmField.style.cursor = 'not-allowed';
        kmField.removeAttribute('required');
      } else {
        kmField.readOnly = false;
        kmField.style.background = 'white';
        kmField.style.cursor = 'text';
      }
    } catch(e) {
      console.error('שגיאה בעידכון רשות:', e);
    }
  }
}

// =============== Export & Clear ===============
function exportToExcel() {
  if (records.length === 0) {
    showAlert('⚠️ אין נתונים לייצוא', 'error');
    return;
  }
  
  let csv = 'מספר עובד,שם עובד,תאריך,שעת התחלה,שעת סיום,שעות,סוג פעילות,בית ספר,רשות,תוכנית,מספר מפגש,קילומטר,הוצאות,פירוט הוצאות,הערות\n';
  
  records.forEach(rec => {
    csv += `${rec.empNum},${rec.empName},${rec.date},${rec.start || ''},${rec.end || ''},${rec.hours},${rec.activity},${rec.school || ''},${rec.municipality},${rec.program},${rec.session},${rec.km || 0},${rec.totalExpenses || 0},"${(rec.expensesDetail || '').replace(/"/g, '""')}","${(rec.notes || '').replace(/"/g, '""')}"\n`;
  });
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `נוכחות_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  
  showAlert('✅ הקובץ יוצא בהצלחה!', 'success');
}

// =============== Admin/Controller Dashboard Functions ===============
let adminEmployeeRecordsCache = {}; // Cache for expanded employee records

async function updateAdminDashboard() {
  const tbody = document.getElementById('adminDashboardTableBody');
  if (!tbody) return;
  
  const filterEmploymentType = document.getElementById('filterEmploymentType')?.value || 'all';
  const filterTeam = document.getElementById('filterTeam')?.value || 'all';
  
  // Get current month for filtering
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  // Get user role to check permissions
  const userRole = localStorage.getItem('role') || '';
  
  // First, try to get employee data (employmentType) from employees list
  let employeesMap = {};
  try {
    const employeesResponse = await fetch(LOGIC_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getEmployees', // This might not exist - will fail gracefully
        role: userRole
      })
    });
    
    if (employeesResponse.ok) {
      const employeesData = await employeesResponse.json();
      if (employeesData.success && Array.isArray(employeesData.employees)) {
        employeesData.employees.forEach(emp => {
          const extractValue = (field) => {
            if (!field) return '';
            if (typeof field === 'string') return field;
            if (typeof field === 'object' && field.Value) return field.Value;
            if (typeof field === 'object' && field.value) return field.value;
            return '';
          };
          
          employeesMap[emp.employeeId || emp.EmployeeId || emp.ID] = {
            employmentType: extractValue(emp.employmentType) || extractValue(emp.EmploymentType) || 'תעשיידע',
            team: extractValue(emp.team) || extractValue(emp.Team) || '-',
            name: extractValue(emp.employeeName) || extractValue(emp.EmployeeName) || ''
          };
        });
        console.log('Loaded employees data:', Object.keys(employeesMap).length, 'employees');
      }
    }
  } catch (err) {
    console.log('Could not load employees list (getEmployees action may not exist):', err.message);
  }
  
  // Fetch all records from server
  try {
    const employeeId = localStorage.getItem('employeeId');
    const team = localStorage.getItem('team') || '';
    
    const response = await fetch(LOGIC_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getHistory',
        employeeId: employeeId,
        role: userRole,
        team: team
      })
    });
    
    const data = await response.json();
    
    if (!data.success || !Array.isArray(data.records)) {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #64748b;">אין נתונים להצגה</td></tr>';
      return;
    }
    
    // Helper to extract value from SharePoint lookup fields
    const extractValue = (field) => {
      if (!field) return '';
      if (typeof field === 'string') return field;
      if (typeof field === 'object' && field.Value) return field.Value;
      if (typeof field === 'object' && field.value) return field.value;
      if (typeof field === 'object' && field.LookupValue) return field.LookupValue;
      return '';
    };
    
    // Helper to get employment type with all possible field names
    const getEmploymentType = (rec) => {
      const possibleFields = [
        rec.employmentType,
        rec.EmploymentType,
        rec.EmployeeType,
        rec.employeeType,
        rec['Employment_x0020_Type'],
        rec.SogHaasaka
      ];
      
      for (let field of possibleFields) {
        const value = extractValue(field);
        if (value && value !== '') {
          console.log('Found employmentType:', value, 'for employee', rec.employeeId);
          return value;
        }
      }
      
      return ''; // Return empty if not found
    };
    
    // Filter to current month
    const currentMonthRecords = data.records.filter(rec => {
      if (!rec.attendanceDate) return false;
      const recDate = new Date(rec.attendanceDate);
      return recDate.getMonth() === currentMonth && recDate.getFullYear() === currentYear;
    });
    
    // Group by employee
    const employeeData = {};
    
    currentMonthRecords.forEach(rec => {
      const empId = rec.employeeId || 'unknown';
      const empName = extractValue(rec.employeeName) || extractValue(rec.EmployeeName) || 'לא ידוע';
      
      // Try to get employmentType and team from employees list first
      const empFromList = employeesMap[empId];
      const team = (empFromList && empFromList.team) || extractValue(rec.team) || extractValue(rec.Team) || '-';
      const empType = (empFromList && empFromList.employmentType) || getEmploymentType(rec) || 'תעשיידע';
      
      if (!employeeData[empId]) {
        employeeData[empId] = {
          empId: empId,
          empName: (empFromList && empFromList.name) || empName,
          team: team,
          employmentType: empType,
          totalRecords: 0,
          totalHours: 0,
          totalKm: 0,
          totalExpenses: 0,
          records: []
        };
      } else {
        // עדכן employmentType רק אם הנוכחי לא ריק והשמור הוא ברירת מחדל
        if (empType && empType !== 'תעשיידע' && employeeData[empId].employmentType === 'תעשיידע') {
          employeeData[empId].employmentType = empType;
        }
        // עדכן team רק אם הנוכחי לא ריק והשמור ריק
        if (team && team !== '-' && (!employeeData[empId].team || employeeData[empId].team === '-')) {
          employeeData[empId].team = team;
        }
      }
      
      employeeData[empId].totalRecords++;
      employeeData[empId].totalHours += parseFloat(rec.workHours || rec.hours || 0);
      employeeData[empId].totalKm += parseFloat(rec.kilometers || rec.km || 0);
      employeeData[empId].totalExpenses += parseFloat(rec.totalExpenses || 0);
      employeeData[empId].records.push(rec);
    });
    
    // Apply filters
    let filteredEmployees = Object.values(employeeData);
    
    if (filterEmploymentType !== 'all') {
      filteredEmployees = filteredEmployees.filter(emp => emp.employmentType === filterEmploymentType);
    }
    
    if (filterTeam !== 'all') {
      filteredEmployees = filteredEmployees.filter(emp => emp.team === filterTeam);
    }
    
    // Sort by name
    filteredEmployees.sort((a, b) => a.empName.localeCompare(b.empName, 'he'));
    
    // Store in cache
    adminEmployeeRecordsCache = {};
    filteredEmployees.forEach(emp => {
      adminEmployeeRecordsCache[emp.empId] = emp.records;
    });
    
    // Render table
    if (filteredEmployees.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #64748b;">אין נתונים להצגה לפי הסינונים שנבחרו</td></tr>';
      return;
    }
    
    tbody.innerHTML = filteredEmployees.map(emp => `
      <tr class="employee-row" onclick="toggleAdminEmployeeDetails('${emp.empId}')" style="cursor: pointer;">
        <td style="padding: 10px 8px; text-align: center;">
          <i class="fas fa-chevron-left" id="admin-chevron-${emp.empId}" style="transition: transform 0.3s; color: #64748b;"></i>
        </td>
        <td style="padding: 10px 8px; text-align: right;">${emp.empId}</td>
        <td style="padding: 10px 8px; text-align: right; font-weight: 500; color: #3b82f6;">${emp.empName}</td>
        <td style="padding: 10px 8px; text-align: center;">${emp.team}</td>
        <td style="padding: 10px 8px; text-align: center;">${emp.employmentType}</td>
        <td style="padding: 10px 8px; text-align: center;">${emp.totalRecords}</td>
        <td style="padding: 10px 8px; text-align: center; font-weight: 600;">${emp.totalHours.toFixed(1)}</td>
        <td style="padding: 10px 8px; text-align: center;">${emp.totalKm.toFixed(0)}</td>
        <td style="padding: 10px 8px; text-align: center;">${emp.totalExpenses.toFixed(0)} ₪</td>
      </tr>
      <tr id="admin-details-${emp.empId}" class="employee-details-row" style="display: none;">
        <td colspan="9" style="padding: 0; background: #f8fafc;">
          <div id="admin-details-content-${emp.empId}" style="padding: 20px;">
            <!-- Will be filled when expanded -->
          </div>
        </td>
      </tr>
    `).join('');
    
  } catch (error) {
    console.error('Error loading admin dashboard:', error);
    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #ef4444;">שגיאה בטעינת נתונים</td></tr>';
  }
}

function toggleAdminEmployeeDetails(empId) {
  const detailsRow = document.getElementById(`admin-details-${empId}`);
  const chevron = document.getElementById(`admin-chevron-${empId}`);
  const detailsContent = document.getElementById(`admin-details-content-${empId}`);
  
  if (detailsRow.style.display === 'none') {
    // Expand
    detailsRow.style.display = 'table-row';
    chevron.style.transform = 'rotate(-90deg)';
    
    // Load details if not already loaded
    if (!detailsContent.dataset.loaded) {
      const records = adminEmployeeRecordsCache[empId] || [];
      
      if (records.length === 0) {
        detailsContent.innerHTML = '<p style="text-align: center; color: #64748b;">אין רשומות</p>';
      } else {
        const extractValue = (field) => {
          if (!field) return '';
          if (typeof field === 'string') return field;
          if (typeof field === 'object' && field.Value) return field.Value;
          return '';
        };
        
        detailsContent.innerHTML = `
          <table style="width: 100%; background: white; border-radius: 8px; overflow: hidden;">
            <thead>
              <tr style="background: #e0f2fe;">
                <th style="padding: 10px; text-align: right;">תאריך</th>
                <th style="padding: 10px; text-align: center;">התחלה</th>
                <th style="padding: 10px; text-align: center;">סיום</th>
                <th style="padding: 10px; text-align: center;">שעות</th>
                <th style="padding: 10px; text-align: right;">סוג פעילות</th>
                <th style="padding: 10px; text-align: right;">בית ספר</th>
                <th style="padding: 10px; text-align: center;">ק"מ</th>
                <th style="padding: 10px; text-align: center;">הוצאות</th>
              </tr>
            </thead>
            <tbody>
              ${records.map(rec => `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                  <td style="padding: 8px; text-align: right;">${rec.attendanceDate || ''}</td>
                  <td style="padding: 8px; text-align: center;">${rec.startTime || ''}</td>
                  <td style="padding: 8px; text-align: center;">${rec.endTime || ''}</td>
                  <td style="padding: 8px; text-align: center; font-weight: 600;">${(rec.workHours || 0).toFixed(1)}</td>
                  <td style="padding: 8px; text-align: right;">${extractValue(rec.activityType) || extractValue(rec.ActivityType) || ''}</td>
                  <td style="padding: 8px; text-align: right;">${extractValue(rec.schoolName) || extractValue(rec.SchoolName) || ''}</td>
                  <td style="padding: 8px; text-align: center;">${rec.kilometers || rec.km || 0}</td>
                  <td style="padding: 8px; text-align: center;">${(rec.totalExpenses || 0).toFixed(0)} ₪</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
      detailsContent.dataset.loaded = 'true';
    }
  } else {
    // Collapse
    detailsRow.style.display = 'none';
    chevron.style.transform = 'rotate(0deg)';
  }
}

function clearAdminFilters() {
  const filterEmploymentType = document.getElementById('filterEmploymentType');
  const filterTeam = document.getElementById('filterTeam');
  
  if (filterEmploymentType) filterEmploymentType.value = 'all';
  if (filterTeam) filterTeam.value = 'all';
  
  updateAdminDashboard();
}

function exportAdminDashboardToExcel() {
  // Similar to exportPayrollToExcel but with employee number column
  const filterEmploymentType = document.getElementById('filterEmploymentType')?.value || 'all';
  const filterTeam = document.getElementById('filterTeam')?.value || 'all';
  
  const now = new Date();
  const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
  
  let csv = 'מספר עובד,שם עובד,צוות,סוג העסקה,רשומות,סה"כ שעות,סה"כ ק"מ,סה"כ הוצאות\n';
  
  const tbody = document.querySelectorAll('#adminDashboardTableBody .employee-row');
  tbody.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 9) {
      const empNum = cells[1].textContent;
      const empName = cells[2].textContent;
      const team = cells[3].textContent;
      const empType = cells[4].textContent;
      const records = cells[5].textContent;
      const hours = cells[6].textContent;
      const km = cells[7].textContent;
      const expenses = cells[8].textContent.replace(' ₪', '');
      
      csv += `${empNum},${empName},${team},${empType},${records},${hours},${km},${expenses}\n`;
    }
  });
  
  const filename = `דוח_עובדים_${monthNames[now.getMonth()]}_${now.getFullYear()}.csv`;
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  
  showAlert('✅ הדוח יוצא בהצלחה!', 'success');
}

// =============== Reports Functions ===============
let reportRecords = [];

function initReportsPage() {
  const now = new Date();
  document.getElementById('reportMonth').value = now.getMonth() + 1;
  document.getElementById('reportYear').value = now.getFullYear();
  populateTeamFilter();
  loadReportData();
}

function populateTeamFilter() {
  const teamSelect = document.getElementById('reportTeam');
  if (!teamSelect) return;
  
  const currentValue = teamSelect.value;
  teamSelect.innerHTML = '<option value="all">הכל</option>';
  
  // Use constant list instead of dynamic
  TEAMS_LIST.forEach(team => {
    const option = document.createElement('option');
    option.value = team;
    option.textContent = team;
    teamSelect.appendChild(option);
  });
  
  // Restore previous selection
  if (currentValue && TEAMS_LIST.includes(currentValue)) {
    teamSelect.value = currentValue;
  }
}


function getFilteredRecordsByMonth(recordsList, month, year) {
  return recordsList.filter(rec => {
    if (!rec.date) return false;
    const recDate = new Date(rec.date);
    return recDate.getMonth() + 1 === parseInt(month) && recDate.getFullYear() === parseInt(year);
  });
}

async function loadReportData() {
  const month = document.getElementById('reportMonth').value;
  const year = document.getElementById('reportYear').value;
  const employmentType = document.getElementById('reportEmploymentType')?.value || 'all';
  const team = document.getElementById('reportTeam')?.value || 'all';
  const activityType = document.getElementById('reportActivityType')?.value || 'all';
  
  const user = getCurrentUserData();
  if (!user) return;
  
  showAlert('טוען נתוני דוח...', 'info');
  
  try {
    const response = await fetch(LOGIC_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'getHistory',
        employeeId: user.empNum,
        role: user.role,
        team: user.team
      })
    });
    
    if (!response.ok) {
      reportRecords = getFilteredRecordsByMonth(records, month, year);
    } else {
      const data = await response.json();
      if (data.success && Array.isArray(data.records)) {
        reportRecords = data.records.map(rec => ({
          recordId: rec.ID || rec.Id || rec.id,
          empNum: rec.employeeId,
          empName: rec.employeeName,
          date: rec.attendanceDate,
          start: rec.startTime,
          end: rec.endTime,
          hours: rec.workHours || 0,
          activity: rec.activityType,
          school: rec.schoolName,
          municipality: rec.municipality,
          program: rec.programName,
          session: rec.sessionNumber,
          km: rec.kilometers || 0,
          totalExpenses: rec.totalExpenses || 0,
          expensesDetail: rec.expensesDetails,
          notes: rec.notes,
          employmentType: rec.employmentType,
          team: rec.team
        }));
      } else {
        reportRecords = getFilteredRecordsByMonth(records, month, year);
      }
    }
    
    reportRecords = getFilteredRecordsByMonth(reportRecords, month, year);
    
    if (employmentType !== 'all') {
      reportRecords = reportRecords.filter(rec => rec.employmentType === employmentType);
    }
    
    if (team !== 'all') {
      reportRecords = reportRecords.filter(rec => rec.team === team);
    }
    
    if (activityType !== 'all') {
      reportRecords = reportRecords.filter(rec => rec.activity === activityType);
    }
    
    updateReportStats();
    renderReportByEmployee();
    showAlert(`נטענו ${reportRecords.length} רשומות לחודש ${month}/${year}`, 'success');
  } catch (error) {
    console.error('Load report data error:', error);
    reportRecords = getFilteredRecordsByMonth(records, month, year);
    updateReportStats();
    renderReportByEmployee();
  }
}

function updateReportStats() {
  const totalRecords = reportRecords.length;
  const totalHours = reportRecords.reduce((sum, rec) => sum + (parseFloat(rec.hours) || 0), 0);
  const totalKm = reportRecords.reduce((sum, rec) => sum + (parseFloat(rec.km) || 0), 0);
  const totalExpenses = reportRecords.reduce((sum, rec) => sum + (parseFloat(rec.totalExpenses) || 0), 0);
  
  document.getElementById('teamTotalRecords').textContent = totalRecords;
  document.getElementById('teamTotalHours').textContent = formatHoursDisplay(totalHours);
  document.getElementById('teamTotalKm').textContent = totalKm.toFixed(1);
  document.getElementById('teamTotalExpenses').textContent = `${totalExpenses.toFixed(0)} ₪`;
}

function renderReportByEmployee() {
  const container = document.getElementById('reportsByEmployee');
  
  if (reportRecords.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px;">אין רשומות לתקופה הנבחרת</p>';
    return;
  }
  
  const byEmployee = {};
  reportRecords.forEach(rec => {
    const key = rec.empName || 'לא ידוע';
    if (!byEmployee[key]) {
      byEmployee[key] = { empNum: rec.empNum, hours: 0, km: 0, expenses: 0, count: 0 };
    }
    byEmployee[key].hours += parseFloat(rec.hours) || 0;
    byEmployee[key].km += parseFloat(rec.km) || 0;
    byEmployee[key].expenses += parseFloat(rec.totalExpenses) || 0;
    byEmployee[key].count++;
  });
  
  let html = `
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>שם עובד</th>
            <th>מספר עובד</th>
            <th>רשומות</th>
            <th>שעות</th>
            <th>ק"מ</th>
            <th>הוצאות</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  Object.keys(byEmployee).sort().forEach(name => {
    const emp = byEmployee[name];
    html += `
      <tr>
        <td>${name}</td>
        <td>${emp.empNum}</td>
        <td>${emp.count}</td>
        <td><strong>${formatHoursDisplay(emp.hours)}</strong></td>
        <td>${emp.km.toFixed(0)}</td>
        <td>${emp.expenses.toFixed(0)} ₪</td>
      </tr>
    `;
  });
  
  const totals = {
    count: reportRecords.length,
    hours: reportRecords.reduce((s, r) => s + (parseFloat(r.hours) || 0), 0),
    km: reportRecords.reduce((s, r) => s + (parseFloat(r.km) || 0), 0),
    expenses: reportRecords.reduce((s, r) => s + (parseFloat(r.totalExpenses) || 0), 0)
  };
  
  html += `
      <tr style="background: #f8fafc; font-weight: bold; border-top: 2px solid #3b82f6;">
        <td colspan="2">סה"כ</td>
        <td>${totals.count}</td>
        <td style="color: #3b82f6;">${totals.hours.toFixed(1)}</td>
        <td style="color: #3b82f6;">${totals.km.toFixed(0)}</td>
        <td style="color: #3b82f6;">${totals.expenses.toFixed(0)} ₪</td>
      </tr>
        </tbody>
      </table>
    </div>
  `;
  
  container.innerHTML = html;
}

function openExportModal() {
  if (reportRecords.length === 0) {
    showAlert('⚠️ אין נתונים לייצוא', 'error');
    return;
  }
  document.getElementById('exportModal').style.display = 'flex';
}

function closeExportModal() {
  document.getElementById('exportModal').style.display = 'none';
}

function exportReportToExcel(type = 'all') {
  if (reportRecords.length === 0) {
    showAlert('⚠️ אין נתונים לייצוא', 'error');
    return;
  }
  
  const month = document.getElementById('reportMonth').value;
  const year = document.getElementById('reportYear').value;
  const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
  
  let csv = '';
  let filename = '';
  
  if (type === 'all') {
    csv = 'מספר עובד,שם עובד,תאריך,שעת התחלה,שעת סיום,שעות,סוג פעילות,בית ספר,רשות,תוכנית,מספר מפגש,קילומטר,הוצאות,פירוט הוצאות,הערות\n';
    
    reportRecords.forEach(rec => {
      csv += `${rec.empNum},${rec.empName},${rec.date},${rec.start || ''},${rec.end || ''},${rec.hours},${rec.activity},${rec.school || ''},${rec.municipality},${rec.program || ''},${rec.session || ''},${rec.km || 0},${rec.totalExpenses || 0},"${(rec.expensesDetail || '').replace(/"/g, '""')}","${(rec.notes || '').replace(/"/g, '""')}"\n`;
    });
    
    filename = `דוח_נוכחות_מלא_${monthNames[parseInt(month) - 1]}_${year}.csv`;
  } else {
    csv = 'שם עובד,מספר רשומות,סה"כ שעות,סה"כ ק"מ,סה"כ הוצאות\n';
    
    const byEmployee = {};
    reportRecords.forEach(rec => {
      const key = rec.empName || 'לא ידוע';
      if (!byEmployee[key]) {
        byEmployee[key] = { hours: 0, km: 0, expenses: 0, count: 0 };
      }
      byEmployee[key].hours += parseFloat(rec.hours) || 0;
      byEmployee[key].km += parseFloat(rec.km) || 0;
      byEmployee[key].expenses += parseFloat(rec.totalExpenses) || 0;
      byEmployee[key].count++;
    });
    
    Object.entries(byEmployee).forEach(([name, data]) => {
      csv += `${name},${data.count},${data.hours.toFixed(2)},${data.km.toFixed(1)},${data.expenses.toFixed(2)}\n`;
    });
    
    const totalHours = reportRecords.reduce((sum, r) => sum + (parseFloat(r.hours) || 0), 0);
    const totalKm = reportRecords.reduce((sum, r) => sum + (parseFloat(r.km) || 0), 0);
    const totalExpenses = reportRecords.reduce((sum, r) => sum + (parseFloat(r.totalExpenses) || 0), 0);
    csv += `סה"כ,${reportRecords.length},${totalHours.toFixed(2)},${totalKm.toFixed(1)},${totalExpenses.toFixed(2)}\n`;
    
    filename = `דוח_נוכחות_מקובץ_${monthNames[parseInt(month) - 1]}_${year}.csv`;
  }
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  
  closeExportModal();
  showAlert('✅ הדוח יוצא בהצלחה!', 'success');
}

// =============== File Upload Functions ===============
let selectedFiles = [];

function initFileUpload() {
  const dropZone = document.getElementById('fileDropZone');
  if (!dropZone) return;
  
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
  
  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });
  
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    addFiles(files);
  });
}

function handleFileSelect(event) {
  const files = event.target.files;
  addFiles(files);
}

function addFiles(fileList) {
  const maxSize = 5 * 1024 * 1024; // 5MB
  
  for (let i = 0; i < fileList.length; i++) {
    const file = fileList[i];
    
    if (file.size > maxSize) {
      showAlert(`הקובץ ${file.name} גדול מדי (מקסימום 5MB)`, 'error');
      continue;
    }
    
    if (!selectedFiles.find(f => f.name === file.name)) {
      selectedFiles.push(file);
    }
  }
  
  renderFileList();
}

function renderFileList() {
  const container = document.getElementById('fileList');
  if (!container) return;
  
  if (selectedFiles.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  const getIcon = (name) => {
    const ext = name.split('.').pop().toLowerCase();
    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'fa-image';
    if (ext === 'pdf') return 'fa-file-pdf';
    if (['doc', 'docx'].includes(ext)) return 'fa-file-word';
    if (['xls', 'xlsx'].includes(ext)) return 'fa-file-excel';
    return 'fa-file';
  };
  
  container.innerHTML = selectedFiles.map((file, idx) => `
    <div class="file-item">
      <div class="file-item-name">
        <i class="fas ${getIcon(file.name)}" style="color: #3b82f6;"></i>
        <span>${file.name}</span>
        <small style="color: #94a3b8;">(${(file.size / 1024).toFixed(1)} KB)</small>
      </div>
      <button type="button" class="file-item-remove" onclick="removeFile(${idx})">
        <i class="fas fa-times" style="font-size: 12px;"></i>
      </button>
    </div>
  `).join('');
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  renderFileList();
}

function clearSelectedFiles() {
  selectedFiles = [];
  renderFileList();
  const input = document.getElementById('attachments');
  if (input) input.value = '';
}

async function uploadFilesToSharePoint(recordId) {
  if (selectedFiles.length === 0) return true;
  
  // Note: File upload to SharePoint requires additional Logic App configuration
  // For now, we'll store file names as references
  const fileNames = selectedFiles.map(f => f.name).join(', ');
  console.log('Files to upload:', fileNames);
  
  // TODO: Implement actual file upload when Logic App is configured
  showAlert(`${selectedFiles.length} קבצים מוכנים להעלאה`, 'info');
  return true;
}

function clearAllData() {
  if (!confirm('⚠️ אזהרה! פעולה זו תמחק את כל הנתונים!\n\nהאם אתה בטוח לחלוטין?')) {
    return;
  }
  
  if (!confirm('האם אתה באמת בטוח? פעולה זו בלתי הפיכה!')) {
    return;
  }
  
  records = [];
  saveToLocalStorage();
  updateStats();
  renderRecordsTable();
  updateDashboard();
  
  showAlert('🗑️ כל הנתונים נמחקו!', 'success');
}

// =============== Initialize ===============
window.addEventListener('DOMContentLoaded', function() {
  populateSchools();
  populateTimeDropdowns();
  initFileUpload();
  
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    try {
      const empData = JSON.parse(savedUser);
      currentUser = empData.empName;
      
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      
      document.getElementById('userName').textContent = empData.empName;
      document.getElementById('userRole').textContent = getRoleDisplayName(empData.role || 'instructor');
      document.getElementById('userAvatar').textContent = empData.empName ? empData.empName.charAt(0) : 'ע';
      document.getElementById('mobileUserGreeting').textContent = 'שלום, ' + empData.empName;
      
      updateMenuByRole(empData.role || 'instructor');
      loadFromLocalStorage();
      updateStats();
      showPage(null, 'dashboard');
      
      // Load records from server
      if (localStorage.getItem('employeeId')) {
        loadMyRecordsFromServer();
      }
    } catch(e) {
      console.error('שגיאה:', e);
    }
  }
});
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('ServiceWorker registration successful');
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
  });
}
</script>
</body>

</html>
