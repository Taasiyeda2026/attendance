
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e40af">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="נוכחות">
  <title>מערכת נוכחות - תעשיידע</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/attached_assets/logo_1768952966068.png">
  <link rel="apple-touch-icon" href="/attached_assets/logo_1768952966068.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Heebo', sans-serif;
      background: #f8fafc;
      color: #1e293b;
      direction: rtl;
      font-size: 14px;
    }

    .hidden { display: none !important; }

    /* ============= Login Screen ============= */
    #loginScreen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f1f5f9;
      padding: 20px;
    }

    .login-card {
      background: white;
      padding: 35px 30px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
      max-width: 360px;
      width: 100%;
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .login-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(0,0,0,0.15), 0 5px 15px rgba(0,0,0,0.1);
    }

    .login-logo {
      max-width: 160px;
      margin-bottom: 20px;
    }

    .login-card h2 {
      color: #1e293b;
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .login-card p {
      color: #64748b;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .form-group {
      margin-bottom: 14px;
      text-align: right;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: #475569;
      font-weight: 500;
      font-size: 13px;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Heebo', sans-serif;
      transition: all 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-login {
      width: 100%;
      padding: 12px;
      background: #1e40af;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Heebo', sans-serif;
      transition: all 0.2s;
      margin-top: 8px;
      box-shadow: 0 3px 10px rgba(30, 64, 175, 0.18);
    }

    .btn-login:hover {
      background: #1e3a8a;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(30, 64, 175, 0.35);
    }

    .btn-login:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(30, 64, 175, 0.2);
    }

    .login-error {
      color: #ef4444;
      background: #fee2e2;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
      display: none;
    }

    .login-error.show {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* ============= Main App Layout ============= */
    #mainApp {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: white;
      border-left: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
      box-shadow: -2px 0 10px rgba(0,0,0,0.05);
    }

    .sidebar-header {
      padding: 16px 14px;
      border-bottom: 1px solid #e2e8f0;
      text-align: center;
    }

    .sidebar-logo {
      max-width: 130px;
    }

    .sidebar-user {
      padding: 14px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
    }

    .user-info h3 {
      font-size: 14px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .user-info p {
      font-size: 12px;
      color: #64748b;
    }

    .sidebar-nav {
      flex: 1;
      padding: 12px 10px;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      color: #64748b;
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 3px;
      transition: all 0.2s;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
    }

    .nav-item:hover {
      background: #f1f5f9;
      color: #3b82f6;
    }

    .nav-item.active {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: #3b82f6;
    }

    .nav-item i {
      margin-left: 10px;
      font-size: 15px;
      width: 20px;
    }

    .sidebar-footer {
      padding: 12px;
      border-top: 1px solid #e2e8f0;
    }

    .btn-logout {
      width: 100%;
      padding: 10px;
      background: #fee2e2;
      color: #dc2626;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Heebo', sans-serif;
    }

    .btn-logout:hover {
      background: #fecaca;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-right: 240px;
      padding: 20px;
    }

    .page-header {
      margin-bottom: 20px;
    }

    .page-header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 4px;
    }

    .page-header p {
      color: #64748b;
      font-size: 13px;
    }

    /* Dashboard Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .stat-card-title {
      color: #64748b;
      font-size: 12px;
      font-weight: 500;
    }

    .stat-card-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .stat-card.blue .stat-card-icon {
      background: #eff6ff;
      color: #3b82f6;
    }

    .stat-card.purple .stat-card-icon {
      background: #f3e8ff;
      color: #a855f7;
    }

    .stat-card.green .stat-card-icon {
      background: #ecfdf5;
      color: #10b981;
    }

    .stat-card.orange .stat-card-icon {
      background: #fff7ed;
      color: #f59e0b;
    }

    .stat-card-value {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .stat-card-label {
      font-size: 11px;
      color: #94a3b8;
    }

    /* Content Card */
    .content-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .content-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .card-header {
      padding: 16px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
    }

    .card-body {
      padding: 16px;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    table thead {
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
    }

    table th {
      padding: 10px 12px;
      text-align: right;
      font-weight: 600;
      color: #475569;
      font-size: 12px;
    }

    table td {
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      color: #64748b;
      font-size: 12px;
    }

    table t tr:hover {
      background: #f8fafc;
    }

    /* Status Badge */
    .status-badge {
      padding: 4px 10px;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-badge.sent {
      background: #dcfce7;
      color: #16a34a;
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #d97706;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Heebo', sans-serif;
      transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    /* Alert */
    .alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s;
    }

    .alert.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .alert.success {
      background: #dcfce7;
      color: #16a34a;
    }

    .alert.error {
      background: #fee2e2;
      color: #dc2626;
    }

    .alert.info {
      background: #dbeafe;
      color: #3b82f6;
    }

    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-bottom: 14px;
      padding: 16px;
    }
    
    @media (max-width: 1200px) {
      .form-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-field label {
      display: block;
      margin-bottom: 8px;
      color: #475569;
      font-weight: 500;
      font-size: 14px;
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 15px;
      font-family: 'Heebo', sans-serif;
      transition: all 0.2s;
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-field input:-moz-read-only {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    .form-field input:read-only {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    /* Page */
    .page {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 200;
      background: #1e40af;
      color: white;
      border: none;
      border-radius: 8px;
      width: 44px;
      height: 44px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }

    /* Responsive - Tablet */
    @media (max-width: 1024px) {
      .sidebar {
        width: 220px;
      }
      .main-content {
        margin-right: 220px;
        padding: 16px;
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Responsive - Mobile */
    @media (max-width: 768px) {
      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .mobile-overlay.active {
        display: block;
      }

      .sidebar {
        position: fixed;
        right: -260px;
        width: 260px;
        transition: right 0.3s ease;
        z-index: 150;
      }

      .sidebar.open {
        right: 0;
      }

      .main-content {
        margin-right: 0;
        padding: 60px 12px 12px 12px;
      }

      .page-header h1 {
        font-size: 20px;
      }

      .page-header p {
        font-size: 12px;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .stat-card {
        padding: 12px;
      }

      .stat-card-value {
        font-size: 20px;
      }

      .stat-card-icon {
        width: 30px;
        height: 30px;
        font-size: 14px;
      }

      .content-card {
        border-radius: 10px;
      }

      .card-header {
        padding: 12px;
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }

      .card-body {
        padding: 12px;
      }

      .form-grid {
        grid-template-columns: 1fr;
        padding: 12px;
        gap: 12px;
      }

      .form-field input,
      .form-field select,
      .form-field textarea {
        padding: 10px 12px;
        font-size: 14px;
      }

      .btn {
        padding: 10px 14px;
        font-size: 13px;
        width: 100%;
      }

      .form-actions {
        flex-direction: column;
      }

      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      table th,
      table td {
        padding: 8px 10px;
        font-size: 11px;
      }

      .modal-content {
        padding: 20px;
        margin: 10px;
        max-height: 85vh;
      }
    }

    /* Responsive - Small Mobile */
    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-card-header {
        flex-direction: row-reverse;
      }

      .login-card {
        padding: 25px 20px;
        margin: 10px;
      }

      .login-card h2 {
        font-size: 20px;
      }
    }

    /* Edit Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e2e8f0;
    }

    .modal-header h3 {
      margin: 0;
      color: #1e293b;
      font-size: 22px;
    }

    .close-btn {
      background: #fee2e2;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      color: #dc2626;
      font-size: 20px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: #fecaca;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px solid #e2e8f0;
    }

    .required-label::after {
      content: ' *';
      color: #dc2626;
      font-weight: bold;
    }
</style>
  <link rel="manifest" href="./manifest.json">
  
  <meta name="theme-color" content="#1e40af">
  
  <link rel="icon" type="image/png" href="./favicon.png">
  <link rel="apple-touch-icon" href="./icon-192.png">
</head>
<body>
<!-- =============== Login Screen =============== -->
<div id="loginScreen">
  <div class="login-card">
    <img src="/attached_assets/logo_1768952966068.png" alt="תעשיידע" style="max-width: 80px; margin-bottom: 15px;">
    <h1 style="font-size: 32px; font-weight: 800; color: #1e293b; margin: 0 0 5px 0; letter-spacing: -0.5px;">תעשיידע</h1>
    <p style="font-size: 16px; color: #64748b; margin: 0 0 20px 0;">מערכת נוכחות</p>
    
    <form onsubmit="return doLogin(event);" id="loginForm">
      <div class="form-group">
        <label for="loginEmpNum">מספר עובד</label>
        <input type="text" id="loginEmpNum" placeholder="הזן מספר עובד" required>
      </div>
      
      <div class="form-group">
        <label for="empCode">קוד אישי</label>
        <input type="password" id="empCode" placeholder="הזן קוד אישי" required>
      </div>
      
      <button type="submit" class="btn-login" id="loginBtn">
        <i class="fas fa-sign-in-alt"></i>
        כניסה למערכת
      </button>
    </form>
    
    <div class="login-error" id="loginError">
      <i class="fas fa-exclamation-circle"></i>
      <span>מספר עובד או קוד שגויים</span>
    </div>
  </div>
</div>

<!-- =============== Main App =============== -->
<div id="mainApp" class="hidden">
  
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
    <i class="fas fa-bars" id="mobileMenuIcon"></i>
  </button>
  
  <!-- Mobile Overlay -->
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="/attached_assets/logo_1768952966068.png" alt="תעשיידע" style="max-width: 50px; margin-bottom: 8px;">
      <h2 style="font-size: 18px; font-weight: 700; color: #1e293b; margin: 0;">תעשיידע</h2>
      <span style="font-size: 12px; color: #64748b;">מערכת נוכחות</span>
    </div>
    
    <div class="sidebar-user">
      <div class="user-avatar">ע</div>
      <div class="user-info">
        <h3 id="userName">עידן נחום</h3>
        <p id="userRole">מנהל מערכת</p>
      </div>
    </div>
    
    <nav class="sidebar-nav" id="sidebarNav">
      <a href="#" class="nav-item active" onclick="showPage(event, 'dashboard')" data-roles="all">
        <i class="fas fa-chart-line"></i>
        <span>לוח בקרה</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'add-record')" data-roles="all">
        <i class="fas fa-plus-circle"></i>
        <span>הוספת רשומה</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'records')" data-roles="all">
        <i class="fas fa-table"></i>
        <span>רשומות נוכחות</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'team-records')" data-roles="manager,operations_controller,system_admin">
        <i class="fas fa-users"></i>
        <span>רשומות הצוות</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'reports')" data-roles="manager,operations_controller,system_admin">
        <i class="fas fa-file-alt"></i>
        <span>דוחות</span>
      </a>
      <a href="#" class="nav-item" onclick="showPage(event, 'admin')" data-roles="system_admin">
        <i class="fas fa-cog"></i>
        <span>הגדרות מערכת</span>
      </a>
    </nav>
    
    <div class="sidebar-footer">
      <button class="btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        יציאה מהמערכת
      </button>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Alert -->
    <div class="alert" id="alertBox">
      <i class="fas fa-check-circle"></i>
      <span id="alertText"></span>
    </div>
    
    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page">
      <div class="page-header">
        <h1>לוח בקרה</h1>
        <p>סקירה כללית של הנוכחות וההשתייעדות</p>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card blue" onclick="showPage(event, 'records')" style="cursor: pointer; transition: transform 0.2s;"
             onmouseover="this.style.transform='translateY(-5px)'"
             onmouseout="this.style.transform='translateY(0)'">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ רשומות</span>
            <div class="stat-card-icon">
              <i class="fas fa-clipboard-list"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalRecordsStat">0</div>
          <div class="stat-card-label">רשומות נוכחות</div>
        </div>
        
        <div class="stat-card purple">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ שעות</span>
            <div class="stat-card-icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalHoursStat">0</div>
          <div class="stat-card-label">שעות עבודה</div>
        </div>
        
        <div class="stat-card green">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ הוצאות</span>
            <div class="stat-card-icon">
              <i class="fas fa-shekel-sign"></i>
            </div>
          </div>
          <div class="stat-card-value" id="totalExpensesStat">0 ₪</div>
          <div class="stat-card-label">הוצאות והחזרים</div>
        </div>
        
        <div class="stat-card orange" onclick="showPage(event, 'records')" style="cursor: pointer; transition: transform 0.2s;"
             onmouseover="this.style.transform='translateY(-5px)'"
             onmouseout="this.style.transform='translateY(0)'">
          <div class="stat-card-header">
            <span class="stat-card-title">ממתינות לשליחה</span>
            <div class="stat-card-icon">
              <i class="fas fa-hourglass-half"></i>
            </div>
          </div>
          <div class="stat-card-value" id="pendingRecordsStat">0</div>
          <div class="stat-card-label">רשומות חדשות</div>
        </div>
      </div>
      
      <!-- כפתורי פעולות -->
      <div style="text-align: center; margin-top: 40px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="showPage(event, 'add-record')" style="font-size: 15px; padding: 12px 24px; border-radius: 10px; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-plus"></i>
          הוסף רשומה חדשה
        </button>
        <button class="btn" onclick="exportToExcel()" style="background: #10b981; color: white; font-size: 15px; padding: 12px 24px; border-radius: 10px; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-file-excel"></i>
          ייצוא ל-Excel
        </button>
      </div>
    </div>

    <!-- Add Record Page -->
    <div id="addRecordPage" class="page hidden">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h1>הוספת רשומה חדשה</h1>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-success" onclick="addRecord()" title="הוסף רשומה" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-check"></i>
          </button>
          <button class="btn btn-primary" onclick="showPage(event, 'dashboard')" title="חזור ללוח בקרה" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
      
      <div class="content-card">
        <div class="card-body">
          <div class="form-grid">
            <div class="form-field">
              <label for="empNum">מספר עובד</label>
              <input type="text" id="empNum" readonly>
            </div>
            <div class="form-field">
              <label for="empName">שם עובד</label>
              <input type="text" id="empName" readonly>
            </div>
            <div class="form-field">
              <label for="recDate">תאריך <span style="color: #ef4444;">*</span></label>
              <input type="date" id="recDate" required>
            </div>
            <div class="form-field">
              <label for="startTime">שעת התחלה <span style="color: #ef4444;">*</span></label>
              <input type="time" id="startTime" onchange="calculateHours()" required>
            </div>
            <div class="form-field">
              <label for="endTime">שעת סיום <span style="color: #ef4444;">*</span></label>
              <input type="time" id="endTime" onchange="calculateHours()" required>
            </div>
            <div class="form-field">
              <label for="hoursField">סה"כ שעות</label>
              <input type="number" id="hoursField" step="0.01" min="0" max="24" readonly style="background: #f1f5f9; cursor: not-allowed;">
            </div>
            <div class="form-field">
              <label for="activityType">סוג פעילות <span style="color: #ef4444;">*</span></label>
              <select id="activityType" required>
                <option value="">בחר</option>
                <option value="ביטול זמן">ביטול זמן</option>
                <option value="הכשרה">הכשרה</option>
                <option value="סדנה">סדנה</option>
                <option value="סיור">סיור</option>
                <option value="קורס">קורס</option>
                <option value="תפעול">תפעול</option>
              </select>
            </div>
            <div class="form-field">
              <label for="schoolField">בית ספר <span style="color: #ef4444;">*</span></label>
              <select id="schoolField" onchange="updateMunicipalityFromSchool()" required>
                <option value="">בחר בית ספר</option>
              </select>
            </div>
            <div class="form-field">
              <label for="municipality">רשות <span style="color: #ef4444;">*</span></label>
              <input type="text" id="municipality" readonly required style="background: #f1f5f9;">
            </div>
            <div class="form-field">
              <label for="programField">תוכנית <span style="color: #ef4444;">*</span></label>
              <select id="programField" required>
                <option value="">בחר תוכנית</option>
                <option value="השמיים אינם הגבול">השמיים אינם הגבול</option>
                <option value="התנסות בתעשייה">התנסות בתעשייה</option>
                <option value="ביומימיקרי">ביומימיקרי</option>
                <option value="ביומימיקרי לחטיבות">ביומימיקרי לחטיבות</option>
                <option value="בינה מלאכותית">בינה מלאכותית</option>
                <option value="יישומי AI">יישומי AI</option>
                <option value="מייקרים טכנו-כיף">מייקרים טכנו-כיף</option>
                <option value="מנהיגות ירוקה">מנהיגות ירוקה</option>
                <option value="מקורות">מקורות</option>
                <option value="משחקי קופסה">משחקי קופסה</option>
                <option value="פורצות דרך">פורצות דרך</option>
                <option value="רוקחים עולם">רוקחים עולם</option>
                <option value="טכנולוגיות החלל">טכנולוגיות החלל</option>
                <option value="תמיר">תמיר</option>
              </select>
            </div>
            <div class="form-field">
              <label for="sessionNum">מספר מפגש <span style="color: #ef4444;">*</span></label>
              <select id="sessionNum" required>
                <option value="">בחר</option>
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
              </select>
            </div>
            <div class="form-field">
              <label for="kmField">קילומטר</label>
              <input type="number" id="kmField" step="0.1" min="0" placeholder="לדוגמה: 25.5">
            </div>
            <div class="form-field">
              <label for="totalExpenses">סה"כ הוצאות (₪)</label>
              <input type="number" id="totalExpenses" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="form-field">
              <label for="expensesDetail">פירוט הוצאות</label>
              <textarea id="expensesDetail" rows="2" placeholder="פרט את ההוצאות"></textarea>
            </div>
            <div class="form-field">
              <label for="attachments">צרף מסמכים/תמונות</label>
              <input type="file" id="attachments" multiple accept="image/*,.pdf,.doc,.docx">
              <small style="color: #64748b; font-size: 12px; display: block; margin-top: 5px;">ניתן להעלות מספר קבצים</small>
            </div>
            <div class="form-field">
              <label for="notesField">הערות</label>
              <textarea id="notesField" rows="3"></textarea>
            </div>
          </div>
          
        </div>
      </div>
    </div>

    <!-- Records Page -->
    <div id="recordsPage" class="page hidden">
      <div class="page-header">
        <h1>רשומות נוכחות</h1>
        <p>כל הרשומות במערכת</p>
      </div>
      
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">סה"כ <span id="totalRecordsCount">0</span> רשומות</h2>
          <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="exportToExcel()" style="background: #10b981; color: white;">
              <i class="fas fa-file-excel"></i>
              ייצוא ל-Excel
            </button>
            <button class="btn" onclick="clearAllData()" style="background: #dc2626; color: white;">
              <i class="fas fa-trash"></i>
              איפוס כל הנתונים
            </button>
            <button class="btn btn-primary" onclick="submitAll()">
              <i class="fas fa-paper-plane"></i>
              שלח דיווח
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="recordsTable">
            <p style="text-align: center; color: #94a3b8; padding: 40px;">אין רשומות להצגה</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Records Page (for manager, operations_controller, system_admin) -->
    <div id="teamRecordsPage" class="page hidden">
      <div class="page-header">
        <h1>רשומות הצוות</h1>
        <p id="teamRecordsSubtitle">צפייה ועריכה של רשומות הצוות</p>
      </div>
      
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">רשומות צוות <span id="teamName"></span></h2>
          <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="exportTeamToExcel()" style="background: #10b981; color: white;">
              <i class="fas fa-file-excel"></i>
              ייצוא ל-Excel
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="teamRecordsTable">
            <p style="text-align: center; color: #94a3b8; padding: 40px;">טוען רשומות צוות...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Page (for manager, operations_controller, system_admin) -->
    <div id="reportsPage" class="page hidden">
      <div class="page-header">
        <h1>דוחות</h1>
        <p>סיכומים וסטטיסטיקות</p>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card blue">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ רשומות הצוות</span>
            <div class="stat-card-icon"><i class="fas fa-clipboard-list"></i></div>
          </div>
          <div class="stat-card-value" id="teamTotalRecords">0</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ שעות הצוות</span>
            <div class="stat-card-icon"><i class="fas fa-clock"></i></div>
          </div>
          <div class="stat-card-value" id="teamTotalHours">0</div>
        </div>
        <div class="stat-card green">
          <div class="stat-card-header">
            <span class="stat-card-title">סה"כ הוצאות הצוות</span>
            <div class="stat-card-icon"><i class="fas fa-shekel-sign"></i></div>
          </div>
          <div class="stat-card-value" id="teamTotalExpenses">0 ₪</div>
        </div>
      </div>
      
      <div class="content-card" style="margin-top: 20px;">
        <div class="card-header">
          <h2 class="card-title">סיכום לפי עובד</h2>
        </div>
        <div class="card-body">
          <div id="reportsByEmployee">
            <p style="text-align: center; color: #94a3b8; padding: 40px;">טוען נתונים...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Page (for system_admin only) -->
    <div id="adminPage" class="page hidden">
      <div class="page-header">
        <h1>הגדרות מערכת</h1>
        <p>ניהול משתמשים והגדרות</p>
      </div>
      
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">פעולות מנהל</h2>
        </div>
        <div class="card-body">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <button class="btn btn-primary" onclick="viewAllRecords()" style="padding: 20px;">
              <i class="fas fa-database"></i><br>
              צפייה בכל הרשומות
            </button>
            <button class="btn" onclick="exportAllToExcel()" style="background: #10b981; color: white; padding: 20px;">
              <i class="fas fa-file-excel"></i><br>
              ייצוא כל הנתונים
            </button>
            <button class="btn" onclick="syncFromSharePoint()" style="background: #3b82f6; color: white; padding: 20px;">
              <i class="fas fa-sync-alt"></i><br>
              סנכרון מ-SharePoint
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>עריכת רשומה</h3>
          <button class="close-btn" onclick="closeEditModal()">×</button>
        </div>
        
        <div class="form-grid">
          <div class="form-field">
            <label for="editDate" class="required-label">תאריך</label>
            <input type="date" id="editDate" required>
          </div>
          <div class="form-field">
            <label for="editStartTime" class="required-label">שעת התחלה</label>
            <input type="time" id="editStartTime" onchange="calculateEditHours()" required>
          </div>
          <div class="form-field">
            <label for="editEndTime" class="required-label">שעת סיום</label>
            <input type="time" id="editEndTime" onchange="calculateEditHours()" required>
          </div>
          <div class="form-field">
            <label for="editHours">סה"כ שעות</label>
            <input type="number" id="editHours" step="0.01" min="0" max="24" readonly style="background: #f1f5f9; cursor: not-allowed;">
          </div>
          <div class="form-field">
            <label for="editActivity" class="required-label">סוג פעילות</label>
            <select id="editActivity" required>
              <option value="">בחר</option>
              <option value="ביטול זמן">ביטול זמן</option>
              <option value="הכשרה">הכשרה</option>
              <option value="סדנה">סדנה</option>
              <option value="סיור">סיור</option>
              <option value="קורס">קורס</option>
              <option value="תפעול">תפעול</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editSchool" class="required-label">בית ספר</label>
            <select id="editSchool" onchange="updateEditMunicipality()" required>
              <option value="">בחר בית ספר</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editMunicipality" class="required-label">רשות</label>
            <input type="text" id="editMunicipality" readonly style="background: #f1f5f9;" required>
          </div>
          <div class="form-field">
            <label for="editProgram" class="required-label">תוכנית</label>
            <select id="editProgram" required>
              <option value="">בחר תוכנית</option>
              <option value="השמיים אינם הגבול">השמיים אינם הגבול</option>
              <option value="התנסות בתעשייה">התנסות בתעשייה</option>
              <option value="ביומימיקרי">ביומימיקרי</option>
              <option value="ביומימיקרי לחטיבות">ביומימיקרי לחטיבות</option>
              <option value="בינה מלאכותית">בינה מלאכותית</option>
              <option value="יישומי AI">יישומי AI</option>
              <option value="מייקרים טכנו-כיף">מייקרים טכנו-כיף</option>
              <option value="מנהיגות ירוקה">מנהיגות ירוקה</option>
              <option value="מקורות">מקורות</option>
              <option value="משחקי קופסה">משחקי קופסה</option>
              <option value="פורצות דרך">פורצות דרך</option>
              <option value="רוקחים עולם">רוקחים עולם</option>
              <option value="טכנולוגיות החלל">טכנולוגיות החלל</option>
              <option value="תמיר">תמיר</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editSession" class="required-label">מספר מפגש</label>
            <select id="editSession" required>
              <option value="">בחר</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
            </select>
          </div>
          <div class="form-field">
            <label for="editKm">קילומטר</label>
            <input type="number" id="editKm" step="0.1" min="0" placeholder="לדוגמה: 25.5">
          </div>
          <div class="form-field">
            <label for="editTotalExpenses">סה"כ הוצאות (₪)</label>
            <input type="number" id="editTotalExpenses" step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-field">
            <label for="editExpensesDetail">פירוט הוצאות</label>
            <textarea id="editExpensesDetail" rows="2" placeholder="פרט את ההוצאות"></textarea>
          </div>
          <div class="form-field">
            <label for="editNotes">הערות</label>
            <textarea id="editNotes" rows="3"></textarea>
          </div>
          <div class="form-field">
            <label for="editAttachments">קבצים מצורפים</label>
            <input type="file" id="editAttachments" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx">
            <small style="color: #64748b; font-size: 12px;">ניתן לצרף מספר קבצים (PDF, תמונות, מסמכים)</small>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn" onclick="closeEditModal()" style="background: #e2e8f0; color: #475569;">
            <i class="fas fa-times"></i>
            ביטול
          </button>
          <button class="btn btn-success" onclick="saveEdit()">
            <i class="fas fa-save"></i>
            שמירה
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// =============== Configuration ===============

// Logic App URL moved to server-side for security

// =============== State ===============
let records = [];
let currentUser = '';
let editingIndex = -1;

// =============== Users ===============
// Authentication moved to server-side for security

// =============== Schools Data ===============
const schoolsData = [
  {"רשות":"בנימינה","בית ספר":"מתנ\"ס"},
  {"רשות":"ג'דיידה מכר","בית ספר":"ג'דיידה יסודי"},
  {"רשות":"הרצליה","בית ספר":"ויצו פנינים אילנות"},
  {"רשות":"חיפה","בית ספר":"לאובק"},
  {"רשות":"ירושלים","בית ספר":"ביכורים"},
  {"רשות":"כיסרא סמיה","בית ספר":"כיסרא סמיה"},
  {"רשות":"ירכא","בית ספר":"ירכא אל-רואי"},
  {"רשות":"ירכא","בית ספר":"ירכא אל-אמין"},
  {"רשות":"ג'וליס","בית ספר":"דרכא"},
  {"רשות":"עין קיניה","בית ספר":"עין קיניה"},
  {"רשות":"בוקעתא","בית ספר":"בוקעתא"},
  {"רשות":"מג'דל שמס","בית ספר":"מג'דל שמס"},
  {"רשות":"יהוד","בית ספר":"הרצל"},
  {"רשות":"יהוד","בית ספר":"יהודה הלוי"},
  {"רשות":"יהוד","בית ספר":"היובל"},
  {"רשות":"אשכול","בית ספר":"נופי הבשור"},
  {"רשות":"מנשה","בית ספר":"נטעים"},
  {"רשות":"מטה יהודה","בית ספר":"אלון"},
  {"רשות":"מטה יהודה","בית ספר":"מתיתיהו"},
  {"רשות":"מטה יהודה","בית ספר":"האלה"},
  {"רשות":"מטה יהודה","בית ספר":"הרטוב היסודי"},
  {"רשות":"מטה יהודה","בית ספר":"עין הרים"},
  {"רשות":"מטה יהודה","בית ספר":"השחר"},
  {"רשות":"מטה יהודה","בית ספר":"יסודי עין נקובא-ראפה"},
  {"רשות":"מטה יהודה","בית ספר":"קרוב"},
  {"רשות":"מטה יהודה","בית ספר":"נווה שלום"},
  {"רשות":"מטה יהודה","בית ספר":"קסם"},
  {"רשות":"מסעדה","בית ספר":"מסעדה יסודי"},
  {"רשות":"נהריה","בית ספר":"גולדה"},
  {"רשות":"נהריה","בית ספר":"ישיבת אבירי יעקב"},
  {"רשות":"נהריה","בית ספר":"מדעים"},
  {"רשות":"נהריה","בית ספר":"רמב\"ם"},
  {"רשות":"נתניה","בית ספר":"בר אילן"},
  {"רשות":"נתניה","בית ספר":"אלדד"},
  {"רשות":"נתניה","בית ספר":"ריגלר"},
  {"רשות":"נתניה","בית ספר":"אלתרמן"},
  {"רשות":"נתניה","בית ספר":"אורט גוטמן"},
  {"רשות":"נתניה","בית ספר":"שחפים חנ\"מ (אלומות לשעבר)"},
  {"רשות":"עין אלאסד","בית ספר":"עין אלאסד"},
  {"רשות":"עכו","בית ספר":"גורדון"},
  {"רשות":"עכו","בית ספר":"העליה השניה"},
  {"רשות":"עכו","בית ספר":"חילמי"},
  {"רשות":"עמק הירדן - אפיקים","בית ספר":"אפיקי ירדן"},
  {"רשות":"עמק הירדן - אשדות יעקב","בית ספר":"מול גלעד"},
  {"רשות":"עמק הירדן - גינוסר","בית ספר":"נופי ארבל"},
  {"רשות":"עמק הירדן - דגניה א'","בית ספר":"בית חינוך דגניה"},
  {"רשות":"עמק הירדן - כנרת","בית ספר":"כנרת"},
  {"רשות":"קריית טבעון","בית ספר":"כפר הנוער רמת הדסה"},
  {"רשות":"קריית שמונה","בית ספר":"מתנ\"ס קריית שמונה"},
  {"רשות":"קריית שמונה","בית ספר":"עוזיאל"},
  {"רשות":"ראשון לציון","בית ספר":"גימנסיה"},
  {"רשות":"ראשון לציון","בית ספר":"תיכון המעיין"},
  {"רשות":"רחובות","בית ספר":"בכור לוי"},
  {"רשות":"רחובות","בית ספר":"נבון רחובות"},
  {"רשות":"בוסתן הגליל","בית ספר":"מיטר"},
  {"רשות":"אופקים","בית ספר":"בן גוריון"},
  {"רשות":"אשדוד","בית ספר":"חווה חקלאית - אשכול"},
  {"רשות":"אשדוד","בית ספר":"חווה חקלאית - יחד"},
  {"רשות":"אשדוד","בית ספר":"מקיף ה'"},
  {"רשות":"אשדוד","בית ספר":"מקיף ט'"},
  {"רשות":"אשכול","בית ספר":"מרחבי אשכול"},
  {"רשות":"אשכול","בית ספר":"שדות אשכול"},
  {"רשות":"אשכול","בית ספר":"שמש גבולות"},
  {"רשות":"אשקלון","בית ספר":"אילנות"},
  {"רשות":"אשקלון","בית ספר":"בראשית"},
  {"רשות":"אשקלון","בית ספר":"דרכא מקיף ה'"},
  {"רשות":"אשקלון","בית ספר":"נוף ים ב'"},
  {"רשות":"באר יעקב","בית ספר":"צאלון"},
  {"רשות":"באר שבע","בית ספר":"התומר"},
  {"רשות":"באר שבע","בית ספר":"חווה חקלאית - התומר"},
  {"רשות":"באר שבע","בית ספר":"שובו"},
  {"רשות":"באר שבע","בית ספר":"חווה חקלאית - רננות"},
  {"רשות":"באר שבע","בית ספר":"מקיף ג'"},
  {"רשות":"גדרה","בית ספר":"דרכא רמון"},
  {"רשות":"דימונה","בית ספר":"נווה עמרם"},
  {"רשות":"יבנה","בית ספר":"ביאליק"},
  {"רשות":"יבנה","בית ספר":"נבון יבנה"},
  {"רשות":"יבנה","בית ספר":"פרדס צפוני"},
  {"רשות":"יד בנימין","בית ספר":"יד בנימין"},
  {"רשות":"לכיש","בית ספר":"רבקה גובר"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"באר גנים"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"חופים"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"מורשה"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"ניצן"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"ניצני קליף"},
  {"רשות":"מ.א חוף אשקלון","בית ספר":"שדות סילבר"},
  {"רשות":"מודיעין","בית ספר":"תיכון ב'"},
  {"רשות":"נס ציונה","בית ספר":"בן גוריון"},
  {"רשות":"קריית גת","בית ספר":"אורט גרוס"},
  {"רשות":"קריית גת","בית ספר":"אורט מאיר"},
  {"רשות":"קריית גת","בית ספר":"בן צבי"},
  {"רשות":"קריית גת","בית ספר":"דוד אלעזר"},
  {"רשות":"קריית גת","בית ספר":"משואה"},
  {"רשות":"קריית מלאכי","בית ספר":"דרור"},
  {"רשות":"קריית מלאכי","בית ספר":"עמל גבעתי"},
  {"רשות":"רמלה","בית ספר":"חטיבת עידנים"},
  {"רשות":"רמלה","בית ספר":"מקיף יגאל אלון"},
  {"רשות":"רמלה","בית ספר":"תיכון פרופ נגר"},
  {"רשות":"שדרות","בית ספר":"חניתה ב'"},
  {"רשות":"אבן שמואל","בית ספר":"שפיר"},
  {"רשות":"שפיר","בית ספר":"תתמ\"ד"},
  {"רשות":"שער הנגב","בית ספר":"שדות רוחמה"}
];

// Sort and add Zoom at beginning
schoolsData.sort((a, b) => a['בית ספר'].localeCompare(b['בית ספר'], 'he'));
schoolsData.unshift({"רשות":"זום","בית ספר":"זום"});

// =============== Role Management ===============
function getRoleDisplayName(role) {
  const roleNames = {
    'system_admin': 'מנהל מערכת',
    'manager': 'מנהל/ת פעילויות',
    'operations_controller': 'עוזרת אדמין',
    'instructor': 'מדריך/ה'
  };
  return roleNames[role] || 'משתמש';
}

function getCurrentUserData() {
  try {
    const saved = localStorage.getItem('currentUser');
    return saved ? JSON.parse(saved) : null;
  } catch(e) {
    return null;
  }
}

function updateMenuByRole(role) {
  const navItems = document.querySelectorAll('#sidebarNav .nav-item');
  navItems.forEach(item => {
    const allowedRoles = item.getAttribute('data-roles');
    if (allowedRoles === 'all') {
      item.style.display = 'flex';
    } else {
      const roles = allowedRoles.split(',');
      item.style.display = roles.includes(role) ? 'flex' : 'none';
    }
  });
}

function hasPermission(action, targetTeam = null) {
  const user = getCurrentUserData();
  if (!user) return false;
  
  const role = user.role;
  
  switch(action) {
    case 'view_own':
      return true;
    case 'view_team':
      return ['manager', 'operations_controller', 'system_admin'].includes(role);
    case 'view_all':
      return ['operations_controller', 'system_admin'].includes(role);
    case 'edit_own':
      return true;
    case 'edit_team':
      if (role === 'manager') {
        return user.team === targetTeam;
      }
      return ['operations_controller', 'system_admin'].includes(role);
    case 'edit_all':
      return ['operations_controller', 'system_admin'].includes(role);
    case 'admin':
      return role === 'system_admin';
    default:
      return false;
  }
}

// =============== Login ===============
async function doLogin(event) {
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  }
  
  const employeeId = document.getElementById('loginEmpNum').value.trim();
  const personalCode = document.getElementById('empCode').value.trim();
  const loginBtn = document.querySelector('#loginForm button[type="submit"]');
  const errorEl = document.getElementById('loginError');
  
  errorEl.classList.remove('show');
  
  if (!employeeId || !personalCode) {
    errorEl.textContent = 'נא להזין מספר עובד וקוד אישי';
    errorEl.classList.add('show');
    return false;
  }
  
  if (loginBtn) {
    loginBtn.disabled = true;
    loginBtn.textContent = 'מתחבר...';
  }
  
  try {
    const response = await fetch(
  'https://prod-23.israelcentral.logic.azure.com:443/workflows/39fabd0c7a1b418286fe5ec53a720f61/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=JSq3DkhLej1JC18oCJ3CtV7hjUdX_vu1E2j94LLsw_g',
  {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        employeeId: parseInt(employeeId, 10), 
        personalCode: parseInt(personalCode, 10) 
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      currentUser = data.employeeName;
      const empData = {
        empNum: data.employeeId.toString(),
        empName: data.employeeName,
        role: data.role || 'instructor',
        team: data.team || null
      };
      localStorage.setItem('currentUser', JSON.stringify(empData));
      
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      
      document.getElementById('empNum').value = empData.empNum;
      document.getElementById('empName').value = empData.empName;
      document.getElementById('userName').textContent = empData.empName;
      document.getElementById('userRole').textContent = getRoleDisplayName(empData.role);
      
      updateMenuByRole(empData.role);
      loadFromLocalStorage();
      updateStats();
      showPage(null, 'dashboard');
    } else {
      errorEl.textContent = data.message || 'מספר עובד או קוד אישי שגויים';
      errorEl.classList.add('show');
    }
  } catch (error) {
    errorEl.textContent = 'שגיאת תקשורת - נסה שוב';
    errorEl.classList.add('show');
  } finally {
    if (loginBtn) {
      loginBtn.disabled = false;
      loginBtn.textContent = 'התחברות';
    }
  }
  
  return false;
}

function logout() {
  if (confirm('האם אתה בטוח שברצונך להתנתק?')) {
    localStorage.removeItem('currentUser');
    currentUser = '';
    location.reload();
  }
}

// =============== Mobile Menu ===============
function toggleMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('mobileOverlay');
  const icon = document.getElementById('mobileMenuIcon');
  
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
  
  if (sidebar.classList.contains('open')) {
    icon.className = 'fas fa-times';
  } else {
    icon.className = 'fas fa-bars';
  }
}

function closeMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('mobileOverlay');
  const icon = document.getElementById('mobileMenuIcon');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
  icon.className = 'fas fa-bars';
}

// =============== Page Navigation ===============
function showPage(event, pageName) {
  if (event) {
    event.preventDefault();
  }
  
  // Close mobile menu when navigating
  closeMobileMenu();
  
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  
  const pageMap = {
    'dashboard': 'dashboardPage',
    'add-record': 'addRecordPage',
    'records': 'recordsPage',
    'team-records': 'teamRecordsPage',
    'reports': 'reportsPage',
    'admin': 'adminPage'
  };
  
  const pageId = pageMap[pageName];
  if (pageId) {
    document.getElementById(pageId).classList.remove('hidden');
  }
  
  if (event && event.target.closest('.nav-item')) {
    event.target.closest('.nav-item').classList.add('active');
  }
  
  if (pageName === 'dashboard') updateDashboard();
  if (pageName === 'records') renderRecordsTable();
  if (pageName === 'team-records') loadTeamRecords();
  if (pageName === 'reports') loadReports();
}

// =============== Team Records Functions ===============
function loadTeamRecords() {
  const user = getCurrentUserData();
  if (!user) return;
  
  const teamName = document.getElementById('teamName');
  if (user.role === 'system_admin' || user.role === 'operations_controller') {
    teamName.textContent = '(כל הצוותים)';
  } else if (user.role === 'manager') {
    teamName.textContent = user.team || '';
  }
  
  document.getElementById('teamRecordsTable').innerHTML = `
    <p style="text-align: center; color: #64748b; padding: 40px;">
      <i class="fas fa-info-circle"></i>
      רשומות הצוות יוצגו כאן לאחר סנכרון מ-SharePoint
    </p>
  `;
}

function loadReports() {
  document.getElementById('teamTotalRecords').textContent = '0';
  document.getElementById('teamTotalHours').textContent = '0';
  document.getElementById('teamTotalExpenses').textContent = '0 ₪';
  
  document.getElementById('reportsByEmployee').innerHTML = `
    <p style="text-align: center; color: #64748b; padding: 40px;">
      <i class="fas fa-info-circle"></i>
      דוחות יוצגו כאן לאחר סנכרון מ-SharePoint
    </p>
  `;
}

function exportTeamToExcel() {
  showAlert('פונקציה זו תהיה זמינה לאחר סנכרון מ-SharePoint', 'info');
}

function viewAllRecords() {
  showPage(null, 'team-records');
}

function exportAllToExcel() {
  exportToExcel();
}

// =============== Alert ===============
function showAlert(message, type = 'success') {
  const alert = document.getElementById('alertBox');
  const alertText = document.getElementById('alertText');
  
  alert.className = `alert ${type} show`;
  alertText.textContent = message;
  
  setTimeout(() => {
    alert.classList.remove('show');
  }, 5000);
}

// =============== LocalStorage ===============
function saveToLocalStorage() {
  localStorage.setItem('attendanceRecords', JSON.stringify(records));
}

function loadFromLocalStorage() {
  try {
    const data = localStorage.getItem('attendanceRecords');
    if (data) {
      records = JSON.parse(data);
    }
  } catch(e) {
    console.error('שגיאה בטעינת נתונים:', e);
  }
}

// =============== SharePoint Sync ===============
function syncFromSharePoint() {
  showAlert('✅ המערכת מוכנה לעבודה!', 'success');
}

function mergeRecords(loadedRecords) {
  const existingIds = new Set(records.map(r => r.id));
  loadedRecords.forEach(rec => {
    if (!existingIds.has(rec.id)) {
      records.push(rec);
    }
  });
}

// =============== File to Base64 ===============
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}

// =============== Format Attachments ===============
function formatAttachments(attachments) {
  if (!attachments || attachments.length === 0) {
    return '';
  }
  
  return attachments.map(file => {
    const sizeKB = (file.size / 1024).toFixed(1);
    return `${file.name} (${sizeKB} KB)`;
  }).join(', ');
}

// =============== Submit to SharePoint ===============
async function submitAll() {
  if (records.length === 0) {
    showAlert('אין נתונים לשליחה', 'error');
    return;
  }
  
  const pending = records.filter(r => r.status !== 'נשלח');
  
  if (pending.length === 0) {
    showAlert('אין רשומות חדשות לשליחה', 'info');
    return;
  }
  
  showAlert(`🚀 שולח ${pending.length} דיווחים...`, 'info');
  
  let success = 0;
  let failed = 0;
  
  for (const rec of pending) {
    try {
      console.log('=== DEBUG submitToSharePoint ===');
      console.log('rec:', rec);
      
      const payload = {
        employeeId: rec.empNum,
        employeeName: rec.empName,
        workDate: rec.date,
        startTime: rec.start || '',
        endTime: rec.end || '',
        hours: rec.hours,
        activityType: rec.activity,
        school: rec.school || '',
        municipality: rec.municipality,
        program: rec.program,
        sessionNumber: rec.session,
        km: rec.km || 0,
        totalExpenses: rec.totalExpenses || 0,
        expensesDetails: rec.expensesDetail || '',
        notes: rec.notes || '',
        attachments: rec.attachments || [],
        attachmentsNames: formatAttachments(rec.attachments || [])
      };
      
      console.log('=== PAYLOAD ===', JSON.stringify(payload, null, 2));
      
      const response = await fetch(
  'https://prod-23.israelcentral.logic.azure.com:443/workflows/39fabd0c7a1b418286fe5ec53a720f61/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=JSq3DkhLej1JC18oCJ3CtV7hjUdX_vu1E2j94LLsw_g',
  {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      
      console.log('Response:', response.status, response.statusText);
      
      if (response.ok) {
        rec.status = 'נשלח';
        success++;
      } else {
        failed++;
      }
    } catch(error) {
      console.error('שגיאה בשליחה:', error);
      failed++;
    }
  }
  
  saveToLocalStorage();
  updateStats();
  renderRecordsTable();
  
  if (failed === 0) {
    showAlert(`✅ כל הדיווחים (${success}) נשלחו בהצלחה!`, 'success');
  } else {
    showAlert(`⚠️ נשלחו ${success} דיווחים, ${failed} נכשלו`, 'error');
  }
}

// =============== Statistics ===============
function updateStats() {
  const totalRecords = records.length;
  const totalHours = records.reduce((sum, r) => sum + (parseFloat(r.hours) || 0), 0).toFixed(2);
  const totalExpenses = records.reduce((sum, r) => sum + (parseFloat(r.totalExpenses) || 0), 0).toFixed(2);
  const pending = records.filter(r => r.status !== 'נשלח').length;
  
  document.getElementById('totalRecordsStat').textContent = totalRecords;
  document.getElementById('totalHoursStat').textContent = totalHours;
  document.getElementById('totalExpensesStat').textContent = totalExpenses + ' ₪';
  document.getElementById('pendingRecordsStat').textContent = pending;
}

// =============== Dashboard ===============
function updateDashboard() {
  updateStats();
  // הטבלה הוסרה - רק מעדכנים סטטיסטיקה
}

// =============== Calculate Hours ===============
function calculateHours() {
  const startTime = document.getElementById('startTime').value;
  const endTime = document.getElementById('endTime').value;
  
  if (startTime && endTime) {
    const start = new Date('2000-01-01 ' + startTime);
    const end = new Date('2000-01-01 ' + endTime);
    
    let diff = (end - start) / 1000 / 60 / 60;
    
    if (diff < 0) {
      diff += 24;
    }
    
    document.getElementById('hoursField').value = diff.toFixed(2);
  }
}

function calculateEditHours() {
  const startTime = document.getElementById('editStartTime').value;
  const endTime = document.getElementById('editEndTime').value;
  
  if (startTime && endTime) {
    const start = new Date('2000-01-01 ' + startTime);
    const end = new Date('2000-01-01 ' + endTime);
    
    let diff = (end - start) / 1000 / 60 / 60;
    
    if (diff < 0) {
      diff += 24;
    }
    
    document.getElementById('editHours').value = diff.toFixed(2);
  }
}

// =============== Add Record ===============
async function addRecord() {
  const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
  const empNum = userData.empNum || '';
  const empName = userData.empName || '';
  
  console.log('=== DEBUG addRecord ===');
  console.log('userData:', userData);
  console.log('empNum:', empNum);
  console.log('empName:', empName);
  
  const date = document.getElementById('recDate').value;
  const startTime = document.getElementById('startTime').value;
  const endTime = document.getElementById('endTime').value;
  const hours = parseFloat(document.getElementById('hoursField').value) || 0;
  const activity = document.getElementById('activityType').value;
  
  const schoolSelect = document.getElementById('schoolField');
  let school = '';
  let municipality = '';
  
  if (schoolSelect.value) {
    try {
      const schoolData = JSON.parse(schoolSelect.value);
      school = schoolData['בית ספר'];
      municipality = schoolData['רשות'];
    } catch(e) {}
  }
  
  const program = document.getElementById('programField').value;
  const session = document.getElementById('sessionNum').value;
  const km = parseFloat(document.getElementById('kmField').value) || 0;
  const totalExpenses = parseFloat(document.getElementById('totalExpenses').value) || 0;
  const expensesDetail = document.getElementById('expensesDetail').value;
  const notes = document.getElementById('notesField').value;
  
  const attachments = [];
  const fileInput = document.getElementById('attachments');
  if (fileInput && fileInput.files.length > 0) {
    for (const file of fileInput.files) {
      const base64 = await fileToBase64(file);
      attachments.push({
        name: file.name,
        type: file.type,
        size: file.size,
        content: base64
      });
    }
  }
  
  const missing = [];
  if (!date) missing.push('תאריך');
  if (!startTime) missing.push('שעת התחלה');
  if (!endTime) missing.push('שעת סיום');
  if (!hours) missing.push('שעות');
  if (!activity) missing.push('סוג פעילות');
  if (!school) missing.push('בית ספר');
  if (!municipality) missing.push('רשות');
  if (!program) missing.push('תוכנית');
  if (!session) missing.push('מספר מפגש');
  
  if (missing.length > 0) {
    showAlert('⚠️ אנא מלא את כל השדות החובה: ' + missing.join(', '), 'error');
    return;
  }
  
  const newRecord = {
    empNum,
    empName,
    date,
    start: startTime,
    end: endTime,
    hours,
    activity,
    school,
    municipality,
    location: '',
    program,
    session,
    km,
    totalExpenses,
    expensesDetail,
    attachments,
    notes,
    status: 'ממתין',
    id: empNum + '_' + date + '_' + Date.now()
  };
  
  records.push(newRecord);
  saveToLocalStorage();
  updateStats();
  
  // Clear form
  document.getElementById('recDate').value = '';
  document.getElementById('startTime').value = '';
  document.getElementById('endTime').value = '';
  document.getElementById('hoursField').value = '';
  document.getElementById('activityType').value = '';
  document.getElementById('schoolField').value = '';
  document.getElementById('municipality').value = '';
  document.getElementById('programField').value = '';
  document.getElementById('sessionNum').value = '';
  document.getElementById('kmField').value = '';
  document.getElementById('totalExpenses').value = '';
  document.getElementById('expensesDetail').value = '';
  if (document.getElementById('attachments')) document.getElementById('attachments').value = '';
  document.getElementById('notesField').value = '';
  
  showAlert('✅ הרשומה נוספה בהצלחה!', 'success');
  showPage(null, 'dashboard');
}

// =============== Records Table ===============
function renderRecordsTable() {
  document.getElementById('totalRecordsCount').textContent = records.length;
  
  const totalHours = records.reduce((sum, rec) => sum + (rec.hours || 0), 0);
  const totalKm = records.reduce((sum, rec) => sum + (rec.km || 0), 0);
  
  if (records.length === 0) {
    document.getElementById('recordsTable').innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px;">אין רשומות להצגה</p>';
    return;
  }
  
  const tableHTML = `
    <table>
      <thead>
        <tr>
          <th>תאריך</th>
          <th>עובד</th>
          <th>שעות התחלה</th>
          <th>שעות סיום</th>
          <th>סה"כ שעות</th>
          <th>פעילות</th>
          <th>בית ספר</th>
          <th>רשות</th>
          <th>ק"מ</th>
          <th>סטטוס</th>
          <th>פעולות</th>
        </tr>
      </thead>
      <tbody>
        ${records.map((rec, idx) => `
          <tr>
            <td>${rec.date}</td>
            <td>${rec.empName}</td>
            <td>${rec.start || '-'}</td>
            <td>${rec.end || '-'}</td>
            <td><strong>${parseFloat(rec.hours).toFixed(2)}</strong></td>
            <td>${rec.activity}</td>
            <td>${rec.school || '-'}</td>
            <td>${rec.municipality}</td>
            <td>${rec.km}</td>
            <td><span class="status-badge ${rec.status === 'נשלח' ? 'sent' : 'pending'}">${rec.status}</span></td>
            <td>
              <button class="btn" onclick="editRecord(${idx})" style="background: #dbeafe; color: #1e40af; padding: 8px 12px; margin-left: 5px;">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn" onclick="deleteRecord(${idx})" style="background: #fee2e2; color: #dc2626; padding: 8px 12px;">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `).join('')}
        <tr style="background: #f8fafc; font-weight: bold; border-top: 2px solid #3b82f6;">
          <td colspan="4" style="text-align: left; padding-right: 20px;">סה"כ:</td>
          <td style="color: #3b82f6;">${totalHours.toFixed(2)}</td>
          <td colspan="3"></td>
          <td style="color: #3b82f6;">${totalKm.toFixed(1)}</td>
          <td colspan="2"></td>
        </tr>
      </tbody>
    </table>
  `;
  
  document.getElementById('recordsTable').innerHTML = tableHTML;
}

function deleteRecord(index) {
  if (confirm('האם אתה בטוח שברצונך למחוק רשומה זו?')) {
    records.splice(index, 1);
    saveToLocalStorage();
    updateStats();
    renderRecordsTable();
    showAlert('🗑️ הרשומה נמחקה בהצלחה', 'success');
  }
}

// =============== Edit Record ===============
function editRecord(index) {
  editingIndex = index;
  const rec = records[index];
  
  document.getElementById('editDate').value = rec.date;
  document.getElementById('editStartTime').value = rec.start || '';
  document.getElementById('editEndTime').value = rec.end || '';
  document.getElementById('editHours').value = rec.hours;
  document.getElementById('editActivity').value = rec.activity;
  
  const schoolSelect = document.getElementById('editSchool');
  schoolSelect.innerHTML = '<option value="">בחר בית ספר</option>';
  schoolsData.forEach(school => {
    const option = document.createElement('option');
    option.value = JSON.stringify(school);
    option.textContent = school['בית ספר'];
    if (school['בית ספר'] === rec.school) {
      option.selected = true;
    }
    schoolSelect.appendChild(option);
  });
  
  document.getElementById('editMunicipality').value = rec.municipality;
  document.getElementById('editProgram').value = rec.program || '';
  document.getElementById('editSession').value = rec.session || '';
  document.getElementById('editKm').value = rec.km || '';
  document.getElementById('editTotalExpenses').value = rec.totalExpenses || '';
  document.getElementById('editExpensesDetail').value = rec.expensesDetail || '';
  document.getElementById('editNotes').value = rec.notes || '';
  
  if (rec.school === 'זום') {
    document.getElementById('editKm').value = '0';
    document.getElementById('editKm').readOnly = true;
    document.getElementById('editKm').style.background = '#f1f5f9';
  } else {
    document.getElementById('editKm').readOnly = false;
    document.getElementById('editKm').style.background = 'white';
  }
  
  document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
  editingIndex = -1;
}

function updateEditMunicipality() {
  const schoolSelect = document.getElementById('editSchool');
  const municipalityInput = document.getElementById('editMunicipality');
  const kmField = document.getElementById('editKm');
  
  if (schoolSelect.value) {
    try {
      const school = JSON.parse(schoolSelect.value);
      municipalityInput.value = school['רשות'];
      
      if (school['בית ספר'] === 'זום') {
        kmField.value = '0';
        kmField.readOnly = true;
        kmField.style.background = '#f1f5f9';
        kmField.style.cursor = 'not-allowed';
      } else {
        kmField.readOnly = false;
        kmField.style.background = 'white';
        kmField.style.cursor = 'text';
      }
    } catch(e) {
      console.error('שגיאה בעידכון רשות:', e);
    }
  }
}

async function saveEdit() {
  if (editingIndex === -1) return;
  
  const date = document.getElementById('editDate').value;
  const startTime = document.getElementById('editStartTime').value;
  const endTime = document.getElementById('editEndTime').value;
  const hours = parseFloat(document.getElementById('editHours').value) || 0;
  const activity = document.getElementById('editActivity').value;
  const schoolSelect = document.getElementById('editSchool');
  const municipality = document.getElementById('editMunicipality').value;
  const program = document.getElementById('editProgram').value;
  const session = document.getElementById('editSession').value;
  const km = parseFloat(document.getElementById('editKm').value) || 0;
  const totalExpenses = parseFloat(document.getElementById('editTotalExpenses').value) || 0;
  const expensesDetail = document.getElementById('editExpensesDetail').value;
  const notes = document.getElementById('editNotes').value;
  const attachmentsInput = document.getElementById('editAttachments');
  let attachments = records[editingIndex].attachments || [];
  
  if (attachmentsInput.files.length > 0) {
    for (const file of attachmentsInput.files) {
      const base64 = await fileToBase64(file);
      attachments.push({ 
        name: file.name, 
        size: file.size,
        type: file.type,
        content: base64 
      });
    }
  }
  
  let school = '';
  if (schoolSelect.value) {
    try {
      const schoolData = JSON.parse(schoolSelect.value);
      school = schoolData['בית ספר'];
    } catch(e) {}
  }
  
  const missing = [];
  if (!date) missing.push('תאריך');
  if (!startTime) missing.push('שעת התחלה');
  if (!endTime) missing.push('שעת סיום');
  if (!hours) missing.push('שעות');
  if (!activity) missing.push('סוג פעילות');
  if (!school) missing.push('בית ספר');
  if (!municipality) missing.push('רשות');
  if (!program) missing.push('תוכנית');
  if (!session) missing.push('מספר מפגש');
  
  if (missing.length > 0) {
    showAlert('⚠️ אנא מלא את כל השדות החובה: ' + missing.join(', '), 'error');
    return;
  }
  
  records[editingIndex] = {
    ...records[editingIndex],
    date,
    start: startTime,
    end: endTime,
    hours,
    activity,
    school,
    municipality,
    location: '',
    program,
    session,
    km,
    totalExpenses,
    expensesDetail,
    notes,
    attachments,
    status: 'ממתין'
  };
  
  saveToLocalStorage();
  updateStats();
  renderRecordsTable();
  closeEditModal();
  showAlert('✅ הרשומה עודכנה בהצלחה!', 'success');
}

// =============== Schools Functions ===============
function populateSchools() {
  const schoolSelect = document.getElementById('schoolField');
  schoolSelect.innerHTML = '<option value="">בחר בית ספר</option>';
  
  schoolsData.forEach(school => {
    const option = document.createElement('option');
    option.value = JSON.stringify(school);
    option.textContent = school['בית ספר'];
    schoolSelect.appendChild(option);
  });
}

function updateMunicipalityFromSchool() {
  const schoolSelect = document.getElementById('schoolField');
  const municipalityInput = document.getElementById('municipality');
  const kmField = document.getElementById('kmField');
  
  if (schoolSelect.value) {
    try {
      const school = JSON.parse(schoolSelect.value);
      municipalityInput.value = school['רשות'];
      
      if (school['בית ספר'] === 'זום') {
        kmField.value = '0';
        kmField.readOnly = true;
        kmField.style.background = '#f1f5f9';
        kmField.style.cursor = 'not-allowed';
        kmField.removeAttribute('required');
      } else {
        kmField.readOnly = false;
        kmField.style.background = 'white';
        kmField.style.cursor = 'text';
      }
    } catch(e) {
      console.error('שגיאה בעידכון רשות:', e);
    }
  }
}

// =============== Export & Clear ===============
function exportToExcel() {
  if (records.length === 0) {
    showAlert('⚠️ אין נתונים לייצוא', 'error');
    return;
  }
  
  let csv = 'מספר עובד,שם עובד,תאריך,שעת התחלה,שעת סיום,שעות,סוג פעילות,בית ספר,רשות,תוכנית,מספר מפגש,קילומטר,הוצאות,פירוט הוצאות,הערות\n';
  
  records.forEach(rec => {
    csv += `${rec.empNum},${rec.empName},${rec.date},${rec.start || ''},${rec.end || ''},${rec.hours},${rec.activity},${rec.school || ''},${rec.municipality},${rec.program},${rec.session},${rec.km || 0},${rec.totalExpenses || 0},"${(rec.expensesDetail || '').replace(/"/g, '""')}","${(rec.notes || '').replace(/"/g, '""')}"\n`;
  });
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `נוכחות_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  
  showAlert('✅ הקובץ יוצא בהצלחה!', 'success');
}

function clearAllData() {
  if (!confirm('⚠️ אזהרה! פעולה זו תמחק את כל הנתונים!\n\nהאם אתה בטוח לחלוטין?')) {
    return;
  }
  
  if (!confirm('האם אתה באמת בטוח? פעולה זו בלתי הפיכה!')) {
    return;
  }
  
  records = [];
  saveToLocalStorage();
  updateStats();
  renderRecordsTable();
  updateDashboard();
  
  showAlert('🗑️ כל הנתונים נמחקו!', 'success');
}

// =============== Initialize ===============
window.addEventListener('DOMContentLoaded', function() {
  populateSchools();
  
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    try {
      const empData = JSON.parse(savedUser);
      currentUser = empData.empName;
      
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      
      document.getElementById('empNum').value = empData.empNum;
      document.getElementById('empName').value = empData.empName;
      document.getElementById('userName').textContent = empData.empName;
      document.getElementById('userRole').textContent = getRoleDisplayName(empData.role || 'instructor');
      
      updateMenuByRole(empData.role || 'instructor');
      loadFromLocalStorage();
      updateStats();
      showPage(null, 'dashboard');
    } catch(e) {
      console.error('שגיאה:', e);
    }
  }
});
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('ServiceWorker registration successful');
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
  });
}
</script>
</body>

</html>
