{
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "6.0.0.0",
    "parameters": {
      "siteUrl": {
        "type": "String",
        "defaultValue": "https://think365orgil.sharepoint.com/sites/taasiyeda2026"
      },
      "Employees": {
        "type": "String",
        "defaultValue": "Employees"
      },
      "Attendance": {
        "type": "String",
        "defaultValue": "Attendance"
      },
      "$connections": {
        "type": "Object",
        "defaultValue": {}
      }
    },
    "triggers": {
      "manual": {
        "type": "Request",
        "kind": "Http",
        "inputs": {
          "method": "POST",
          "schema": {
            "type": "object",
            "properties": {
              "action": { "type": "string" },
              "employeeId": { "type": "string" },
              "personalCode": { "type": "string" },
              "employeeName": { "type": "string" },
              "attendanceDate": { "type": "string" },
              "startTime": { "type": "string" },
              "endTime": { "type": "string" },
              "workHours": { "type": "number" },
              "activityType": { "type": "string" },
              "schoolName": { "type": "string" },
              "municipality": { "type": "string" },
              "programName": { "type": "string" },
              "sessionNumber": { "type": "number" },
              "kilometers": { "type": "number" },
              "totalExpenses": { "type": "number" },
              "expensesDetails": { "type": "string" },
              "notes": { "type": "string" },
              "team": { "type": "string" },
              "employmentType": { "type": "string" },
              "role": { "type": "string" }
            },
            "required": ["action"]
          }
        }
      }
    },
    "actions": {
      "Init_CORS": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "corsHeaders",
              "type": "object",
              "value": {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
                "Access-Control-Allow-Headers": "Content-Type",
                "Content-Type": "application/json"
              }
            }
          ]
        }
      },
      "Normalize_Action": {
        "type": "Compose",
        "inputs": "@toLower(coalesce(triggerBody()?['action'], ''))",
        "runAfter": {
          "Init_CORS": ["Succeeded"]
        }
      },
      "Switch_By_Action": {
        "type": "Switch",
        "expression": "@outputs('Normalize_Action')",
        "runAfter": {
          "Normalize_Action": ["Succeeded"]
        },
        "cases": {
          "auth": {
            "case": "auth",
            "actions": {
              "Find_Employee": {
                "type": "ApiConnection",
                "inputs": {
                  "host": {
                    "connection": {
                      "name": "@parameters('$connections')['sharepointonline-1']['connectionId']"
                    }
                  },
                  "method": "get",
                  "path": "/datasets/@{encodeURIComponent(parameters('siteUrl'))}/tables/@{encodeURIComponent(parameters('Employees'))}/items",
                  "queries": {
                    "$filter": "employeeId eq '@{triggerBody()?['employeeId']}' and personalCode eq '@{triggerBody()?['personalCode']}'"
                  }
                }
              },
              "Response_Auth_Success": {
                "type": "Response",
                "inputs": {
                  "statusCode": 200,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": "@greater(length(body('Find_Employee')?['value']), 0)",
                    "employee": "@first(body('Find_Employee')?['value'])"
                  }
                },
                "runAfter": {
                  "Find_Employee": ["Succeeded"]
                }
              },
              "Response_Auth_Failed": {
                "type": "Response",
                "inputs": {
                  "statusCode": 500,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": false,
                    "message": "Authentication service unavailable"
                  }
                },
                "runAfter": {
                  "Find_Employee": ["Failed", "TimedOut"]
                }
              }
            }
          },
          "submit": {
            "case": "submit",
            "actions": {
              "Create_Attendance": {
                "type": "ApiConnection",
                "inputs": {
                  "host": {
                    "connection": {
                      "name": "@parameters('$connections')['sharepointonline-1']['connectionId']"
                    }
                  },
                  "method": "post",
                  "path": "/datasets/@{encodeURIComponent(parameters('siteUrl'))}/tables/@{encodeURIComponent(parameters('Attendance'))}/items",
                  "body": {
                    "employeeName": "@triggerBody()?['employeeName']",
                    "employeeId": "@triggerBody()?['employeeId']",
                    "attendanceDate": "@triggerBody()?['attendanceDate']",
                    "startTime": "@triggerBody()?['startTime']",
                    "endTime": "@triggerBody()?['endTime']",
                    "workHours": "@triggerBody()?['workHours']",
                    "activityType": "@triggerBody()?['activityType']",
                    "schoolName": "@triggerBody()?['schoolName']",
                    "municipality": "@triggerBody()?['municipality']",
                    "programName": "@triggerBody()?['programName']",
                    "sessionNumber": "@triggerBody()?['sessionNumber']",
                    "kilometers": "@triggerBody()?['kilometers']",
                    "totalExpenses": "@triggerBody()?['totalExpenses']",
                    "expensesDetails": "@triggerBody()?['expensesDetails']",
                    "notes": "@triggerBody()?['notes']",
                    "team": "@triggerBody()?['team']",
                    "employmentType": "@triggerBody()?['employmentType']",
                    "role": "@triggerBody()?['role']"
                  }
                }
              },
              "Response_Submit_Success": {
                "type": "Response",
                "inputs": {
                  "statusCode": 200,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": true,
                    "id": "@body('Create_Attendance')?['ID']"
                  }
                },
                "runAfter": {
                  "Create_Attendance": ["Succeeded"]
                }
              },
              "Response_Submit_Failed": {
                "type": "Response",
                "inputs": {
                  "statusCode": 500,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": false,
                    "message": "Failed to save attendance record"
                  }
                },
                "runAfter": {
                  "Create_Attendance": ["Failed", "TimedOut"]
                }
              }
            }
          },
          "getsummary": {
            "case": "getsummary",
            "actions": {
              "Fetch_Summary": {
                "type": "ApiConnection",
                "inputs": {
                  "host": {
                    "connection": {
                      "name": "@parameters('$connections')['sharepointonline-1']['connectionId']"
                    }
                  },
                  "method": "get",
                  "path": "/datasets/@{encodeURIComponent(parameters('siteUrl'))}/tables/@{encodeURIComponent(parameters('Attendance'))}/items",
                  "queries": {
                    "$filter": "attendanceDate ge '@{startOfMonth(utcNow())}'",
                    "$select": "ID,employeeId,employeeName,workHours,kilometers,team,attendanceDate"
                  }
                }
              },
              "Response_Summary_Success": {
                "type": "Response",
                "inputs": {
                  "statusCode": 200,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": true,
                    "records": "@body('Fetch_Summary')?['value']"
                  }
                },
                "runAfter": {
                  "Fetch_Summary": ["Succeeded"]
                }
              },
              "Response_Summary_Failed": {
                "type": "Response",
                "inputs": {
                  "statusCode": 500,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": false,
                    "message": "Failed to fetch summary"
                  }
                },
                "runAfter": {
                  "Fetch_Summary": ["Failed", "TimedOut"]
                }
              }
            }
          },
          "getemployeerecords": {
            "case": "getemployeerecords",
            "actions": {
              "Fetch_By_Employee": {
                "type": "ApiConnection",
                "inputs": {
                  "host": {
                    "connection": {
                      "name": "@parameters('$connections')['sharepointonline-1']['connectionId']"
                    }
                  },
                  "method": "get",
                  "path": "/datasets/@{encodeURIComponent(parameters('siteUrl'))}/tables/@{encodeURIComponent(parameters('Attendance'))}/items",
                  "queries": {
                    "$filter": "employeeId eq '@{triggerBody()?['employeeId']}' and attendanceDate ge '@{startOfMonth(utcNow())}'",
                    "$orderby": "attendanceDate desc"
                  }
                }
              },
              "Response_Employee_Success": {
                "type": "Response",
                "inputs": {
                  "statusCode": 200,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": true,
                    "records": "@body('Fetch_By_Employee')?['value']"
                  }
                },
                "runAfter": {
                  "Fetch_By_Employee": ["Succeeded"]
                }
              },
              "Response_Employee_Failed": {
                "type": "Response",
                "inputs": {
                  "statusCode": 500,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": false,
                    "message": "Failed to fetch records"
                  }
                },
                "runAfter": {
                  "Fetch_By_Employee": ["Failed", "TimedOut"]
                }
              }
            }
          }
        },
        "default": {
          "actions": {
            "Response_Unknown": {
              "type": "Response",
              "inputs": {
                "statusCode": 400,
                "headers": "@variables('corsHeaders')",
                "body": {
                  "success": false,
                  "message": "@concat('Unsupported action: ', outputs('Normalize_Action'))"
                }
              }
            }
          }
        }
      }
    }
  },
  "parameters": {
    "$connections": {
      "value": {
        "sharepointonline-1": {
          "id": "/subscriptions/7b35da34-f8af-4193-b59f-03d769307e89/providers/Microsoft.Web/locations/israelcentral/managedApis/sharepointonline",
          "connectionId": "/subscriptions/7b35da34-f8af-4193-b59f-03d769307e89/resourceGroups/attendance-rg/providers/Microsoft.Web/connections/sharepointonline-1",
          "connectionName": "sharepointonline-1"
        }
      }
    }
  }
}
