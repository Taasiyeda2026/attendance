{
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "2.0.0.0",
    "triggers": {
      "When_an_HTTP_request_is_received": {
        "type": "Request",
        "kind": "Http",
        "inputs": {
          "method": "POST",
          "schema": {
            "type": "object",
            "properties": {
              "action": { "type": "string" }
            },
            "required": ["action"]
          }
        }
      }
    },
    "actions": {
      "Set_CORS_Headers": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "corsHeaders",
              "type": "object",
              "value": {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
                "Access-Control-Allow-Headers": "Content-Type, Accept",
                "Content-Type": "application/json"
              }
            }
          ]
        }
      },
      "Normalize_Action": {
        "type": "Compose",
        "inputs": "@if(equals(triggerBody()?['action'], 'updateRecord'), 'update', if(equals(triggerBody()?['action'], 'deleteRecord'), 'delete', triggerBody()?['action']))",
        "runAfter": { "Set_CORS_Headers": ["Succeeded"] }
      },
      "Switch_Action": {
        "type": "Switch",
        "expression": "@outputs('Normalize_Action')",
        "cases": {
          "Submit_Case": {
            "case": "submit",
            "actions": {
              "Submit_Month_Key": {
                "type": "Compose",
                "inputs": "@substring(triggerBody()?['attendanceDate'], 0, 7)"
              },
              "Check_Submit_Allowed": {
                "type": "If",
                "expression": { "equals": [true, true] },
                "actions": {},
                "else": {
                  "actions": {
                    "Create_Attendance_Record": {
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/datasets/@{encodeURIComponent(encodeURIComponent('https://think365orgil.sharepoint.com/sites/taasiyeda2026'))}/tables/@{encodeURIComponent(encodeURIComponent('3c3d634f-5972-4e2e-87cd-0f51ebd8fe27'))}/items",
                        "body": {}
                      }
                    },
                    "Response_Submit_Success_Create": {
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "statusCode": 200,
                        "headers": "@variables('corsHeaders')",
                        "body": {
                          "success": true,
                          "message": "הרשומה נשמרה בהצלחה",
                          "recordId": "@body('Create_Attendance_Record')?['ID']"
                        }
                      },
                      "runAfter": { "Create_Attendance_Record": ["Succeeded"] }
                    }
                  }
                }
              }
            }
          }
        },
        "default": {
          "actions": {
            "Response_Unknown_Action": {
              "type": "Response",
              "kind": "Http",
              "inputs": {
                "statusCode": 400,
                "headers": "@variables('corsHeaders')",
                "body": { "success": false, "message": "פעולה לא ידועה" }
              }
            }
          }
        },
        "runAfter": { "Normalize_Action": ["Succeeded"] }
      }
    },
    "parameters": {
      "$connections": { "type": "Object", "defaultValue": {} }
    }
  },
  "parameters": {
    "$connections": {
      "type": "Object",
      "value": {
        "sharepointonline": {
          "id": "/subscriptions/7b35da34-f8af-4193-b59f-03d769307e89/providers/Microsoft.Web/locations/israelcentral/managedApis/sharepointonline",
          "connectionId": "/subscriptions/7b35da34-f8af-4193-b59f-03d769307e89/resourceGroups/attendance-rg/providers/Microsoft.Web/connections/sharepointonline",
          "connectionName": "sharepointonline"
        }
      }
    }
  }
}
