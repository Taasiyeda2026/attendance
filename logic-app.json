{
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "siteUrl": {
        "type": "String",
        "defaultValue": ""
      },
      "employeesListId": {
        "type": "String",
        "defaultValue": ""
      },
      "attendanceListId": {
        "type": "String",
        "defaultValue": ""
      },
      "$connections": {
        "type": "Object",
        "defaultValue": {}
      }
    },
    "triggers": {
      "manual": {
        "type": "Request",
        "kind": "Http",
        "inputs": {
          "method": "POST",
          "schema": {
            "type": "object",
            "properties": {
              "action": { "type": "string" },
              "employeeId": { "type": "string" },
              "personalCode": { "type": "string" },
              "employeeName": { "type": "string" },
              "team": { "type": "string" },
              "role": { "type": "string" },
              "attendanceDate": { "type": "string" },
              "workHours": { "type": "number" },
              "kilometers": { "type": "number" }
            },
            "required": ["action"]
          }
        }
      }
    },
    "actions": {
      "Initialize_CORS_Headers": {
        "type": "InitializeVariable",
        "inputs": {
          "variables": [
            {
              "name": "corsHeaders",
              "type": "object",
              "value": {
                "Access-Control-Allow-Origin": "*",
                "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
                "Access-Control-Allow-Headers": "Content-Type",
                "Content-Type": "application/json"
              }
            }
          ]
        }
      },
      "Normalize_Action": {
        "type": "Compose",
        "inputs": "@toLower(triggerBody()?['action'])",
        "runAfter": {
          "Initialize_CORS_Headers": ["Succeeded"]
        }
      },
      "Switch_By_Action": {
        "type": "Switch",
        "expression": "@outputs('Normalize_Action')",
        "runAfter": {
          "Normalize_Action": ["Succeeded"]
        },
        "cases": {
          "getsummary": {
            "case": "getsummary",
            "actions": {
              "Fetch_Summary_Data": {
                "type": "ApiConnection",
                "inputs": {
                  "host": {
                    "connection": {
                      "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                    }
                  },
                  "method": "get",
                  "path": "/datasets/@{encodeURIComponent(parameters('siteUrl'))}/tables/@{encodeURIComponent(parameters('attendanceListId'))}/items",
                  "queries": {
                    "$filter": "attendanceDate ge '@{startOfMonth(utcNow())}'",
                    "$select": "ID,employeeId,employeeName,workHours,kilometers,team,attendanceDate,status"
                  }
                }
              },
              "Response_Summary": {
                "type": "Response",
                "kind": "Http",
                "inputs": {
                  "statusCode": 200,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": true,
                    "records": "@body('Fetch_Summary_Data')?['value']"
                  }
                },
                "runAfter": {
                  "Fetch_Summary_Data": ["Succeeded"]
                }
              }
            }
          },
          "getemployeerecords": {
            "case": "getemployeerecords",
            "actions": {
              "Fetch_Detailed_Records": {
                "type": "ApiConnection",
                "inputs": {
                  "host": {
                    "connection": {
                      "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                    }
                  },
                  "method": "get",
                  "path": "/datasets/@{encodeURIComponent(parameters('siteUrl'))}/tables/@{encodeURIComponent(parameters('attendanceListId'))}/items",
                  "queries": {
                    "$filter": "employeeId eq '@{triggerBody()?['employeeId']}' and attendanceDate ge '@{startOfMonth(utcNow())}'"
                  }
                }
              },
              "Response_Detailed": {
                "type": "Response",
                "kind": "Http",
                "inputs": {
                  "statusCode": 200,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": true,
                    "records": "@body('Fetch_Detailed_Records')?['value']"
                  }
                },
                "runAfter": {
                  "Fetch_Detailed_Records": ["Succeeded"]
                }
              }
            }
          },
          "auth": {
            "case": "auth",
            "actions": {
              "Find_Employee": {
                "type": "ApiConnection",
                "inputs": {
                  "host": {
                    "connection": {
                      "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                    }
                  },
                  "method": "get",
                  "path": "/datasets/@{encodeURIComponent(parameters('siteUrl'))}/tables/@{encodeURIComponent(parameters('employeesListId'))}/items",
                  "queries": {
                    "$filter": "employeeId eq '@{triggerBody()?['employeeId']}' and personalCode eq '@{triggerBody()?['personalCode']}'"
                  }
                }
              },
              "Response_Auth": {
                "type": "Response",
                "kind": "Http",
                "inputs": {
                  "statusCode": 200,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": "@greater(length(body('Find_Employee')?['value']), 0)",
                    "employee": "@first(body('Find_Employee')?['value'])"
                  }
                },
                "runAfter": {
                  "Find_Employee": ["Succeeded"]
                }
              }
            }
          },
          "submit": {
            "case": "submit",
            "actions": {
              "Create_Item": {
                "type": "ApiConnection",
                "inputs": {
                  "host": {
                    "connection": {
                      "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                    }
                  },
                  "method": "post",
                  "path": "/datasets/@{encodeURIComponent(parameters('siteUrl'))}/tables/@{encodeURIComponent(parameters('attendanceListId'))}/items",
                  "body": "@triggerBody()"
                }
              },
              "Response_Submit": {
                "type": "Response",
                "kind": "Http",
                "inputs": {
                  "statusCode": 200,
                  "headers": "@variables('corsHeaders')",
                  "body": {
                    "success": true,
                    "id": "@body('Create_Item')?['ID']"
                  }
                },
                "runAfter": {
                  "Create_Item": ["Succeeded"]
                }
              }
            }
          }
        },
        "default": {
          "actions": {
            "Response_Unknown": {
              "type": "Response",
              "kind": "Http",
              "inputs": {
                "statusCode": 400,
                "headers": "@variables('corsHeaders')",
                "body": {
                  "success": false,
                  "message": "@concat('Action not supported: ', outputs('Normalize_Action'))"
                }
              }
            }
          }
        }
      }
    }
  },
  "parameters": {
    "$connections": {
      "value": {}
    }
  }
}
